{"version":3,"file":"ts-compiler.mjs","names":["EXT_TO_JS_MAP: Record<string, string>","dependencies: string[]"],"sources":["../../src/ts-compiler.ts"],"sourcesContent":["import * as esbuild from 'esbuild'\nimport { existsSync, mkdirSync, statSync, writeFileSync } from 'fs'\nimport path from 'path'\n\nconst COMPILED_DIR = '.motia/compiled'\n\nconst TS_EXTENSIONS = ['.ts', '.tsx', '.stream.ts', '.stream']\nconst EXT_TO_JS_MAP: Record<string, string> = {\n  '.stream.ts': '.stream.js',\n  '.tsx': '.js',\n  '.ts': '.js',\n  '.stream': '.stream.js',\n}\n\ninterface CompileCache {\n  compiledPath: string\n  sourceMtime: number\n}\n\ninterface ResolvedImport {\n  sourcePath: string\n  compiledImportPath: string\n}\n\ninterface TransformResult {\n  code: string\n  dependencies: string[]\n}\n\nconst cache = new Map<string, CompileCache>()\n\nconst getCompiledPath = (tsFilePath: string, projectRoot: string): string => {\n  const relativePath = path.relative(projectRoot, tsFilePath)\n  const compiledRelativePath = relativePath.replace(/\\.ts$/, '.js')\n  return path.join(projectRoot, COMPILED_DIR, compiledRelativePath)\n}\n\nconst getSourceMtime = (filePath: string): number => {\n  try {\n    return statSync(filePath).mtimeMs\n  } catch {\n    return 0\n  }\n}\n\nconst ensureCompiledDir = (compiledPath: string): void => {\n  const dir = path.dirname(compiledPath)\n  if (!existsSync(dir)) {\n    mkdirSync(dir, { recursive: true })\n  }\n}\n\nconst replaceExtensionWithJs = (filePath: string): string => {\n  for (const [ext, jsExt] of Object.entries(EXT_TO_JS_MAP)) {\n    if (filePath.endsWith(ext)) {\n      return filePath.replace(new RegExp(`${ext.replace('.', '\\\\.')}$`), jsExt)\n    }\n  }\n  return filePath\n}\n\nconst resolveImportPath = (\n  importPath: string,\n  dir: string,\n  projectRoot: string,\n  compiledPath: string,\n): ResolvedImport | null => {\n  const fullImportPath = path.resolve(dir, importPath)\n\n  for (const ext of TS_EXTENSIONS) {\n    const testPath = fullImportPath + (ext.startsWith('.') ? ext : `.${ext}`)\n    if (existsSync(testPath)) {\n      const relativeToProject = path.relative(projectRoot, testPath)\n      const compiledFileName = replaceExtensionWithJs(relativeToProject)\n      const compiledImportPath = path.join(COMPILED_DIR, compiledFileName)\n      const relativeCompiledPath = path\n        .relative(path.dirname(compiledPath), path.join(projectRoot, compiledImportPath))\n        .replace(/\\\\/g, '/')\n\n      return {\n        sourcePath: testPath,\n        compiledImportPath: relativeCompiledPath.startsWith('.') ? relativeCompiledPath : `./${relativeCompiledPath}`,\n      }\n    }\n  }\n\n  return null\n}\n\nconst transformImportPaths = (\n  code: string,\n  tsFilePath: string,\n  compiledPath: string,\n  projectRoot: string,\n): TransformResult => {\n  const dir = path.dirname(tsFilePath)\n  const dependencies: string[] = []\n\n  const transformedCode = code.replace(/from\\s+['\"](\\.\\/?[^'\"]+)['\"]/g, (match, importPath) => {\n    if (!importPath.startsWith('.')) {\n      return match\n    }\n    if (importPath.endsWith('.js') || importPath.endsWith('.json')) {\n      return match\n    }\n\n    const resolved = resolveImportPath(importPath, dir, projectRoot, compiledPath)\n    if (resolved) {\n      dependencies.push(resolved.sourcePath)\n      return match.replace(importPath, resolved.compiledImportPath)\n    }\n\n    if (!importPath.match(/\\.(ts|tsx|js|jsx|json|stream)$/)) {\n      return match.replace(importPath, `${importPath}.js`)\n    }\n\n    return match.replace(importPath, importPath.replace(/\\.(ts|tsx|stream\\.ts|stream)$/, '.js'))\n  })\n\n  return {\n    code: transformedCode,\n    dependencies: dependencies.filter(\n      (dep) => dep.endsWith('.ts') || dep.endsWith('.tsx') || dep.endsWith('.stream.ts'),\n    ),\n  }\n}\n\nconst isCacheValid = (tsFilePath: string): boolean => {\n  const cached = cache.get(tsFilePath)\n  if (!cached) {\n    return false\n  }\n\n  const sourceMtime = getSourceMtime(tsFilePath)\n  return cached.sourceMtime === sourceMtime && existsSync(cached.compiledPath)\n}\n\nconst buildWithEsbuild = async (tsFilePath: string, compiledPath: string): Promise<string> => {\n  const result = await esbuild.build({\n    entryPoints: [tsFilePath],\n    bundle: false,\n    format: 'esm',\n    target: 'node18',\n    platform: 'node',\n    outfile: compiledPath,\n    sourcemap: 'inline',\n    write: false,\n    resolveExtensions: ['.ts', '.tsx', '.js', '.jsx', '.json'],\n    packages: 'external',\n  })\n\n  if (!result.outputFiles || result.outputFiles.length === 0) {\n    throw new Error(`Failed to compile ${tsFilePath}`)\n  }\n\n  return result.outputFiles[0].text\n}\n\nconst compileDependencies = async (dependencies: string[], projectRoot: string): Promise<void> => {\n  for (const dep of dependencies) {\n    await compile(dep, projectRoot)\n  }\n}\n\nconst updateCache = (tsFilePath: string, compiledPath: string): void => {\n  const sourceMtime = getSourceMtime(tsFilePath)\n  cache.set(tsFilePath, {\n    compiledPath,\n    sourceMtime,\n  })\n}\n\nexport const compile = async (tsFilePath: string, projectRoot: string): Promise<string> => {\n  const compiledPath = getCompiledPath(tsFilePath, projectRoot)\n\n  if (isCacheValid(tsFilePath)) {\n    const cached = cache.get(tsFilePath)\n    if (cached) {\n      return cached.compiledPath\n    }\n  }\n\n  ensureCompiledDir(compiledPath)\n  const compiledCode = await buildWithEsbuild(tsFilePath, compiledPath)\n  const { code, dependencies } = transformImportPaths(compiledCode, tsFilePath, compiledPath, projectRoot)\n\n  await compileDependencies(dependencies, projectRoot)\n  writeFileSync(compiledPath, code, 'utf-8')\n  updateCache(tsFilePath, compiledPath)\n\n  return compiledPath\n}\n\nexport const invalidate = (tsFilePath: string): void => {\n  cache.delete(tsFilePath)\n}\n\nexport const invalidateAll = (): void => {\n  cache.clear()\n}\n"],"mappings":"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"}