{"version":3,"file":"flows-helper.mjs","names":["edges: FlowEdge[]","uuidv5"],"sources":["../../../src/helper/flows-helper.ts"],"sourcesContent":["// Helper functions\n\nimport fs from 'fs'\nimport path from 'path'\nimport { v5 as uuidv5 } from 'uuid'\nimport { getStepLanguage } from '../get-step-language'\nimport { isApiStep, isCronStep, isEventStep, isNoopStep } from '../guards'\nimport type { Emit, Step } from '../types'\nimport type { FlowEdge, FlowResponse, FlowStepResponse } from '../types/flows-types'\n\nconst getNodeComponentPath = (filePath: string): string | undefined => {\n  const filePathWithoutExtension = filePath.replace(/\\.[^/.]+$/, '')\n  const tsxPath = filePathWithoutExtension + '.tsx'\n  const jsxPath = filePathWithoutExtension + '.jsx'\n\n  if (fs.existsSync(tsxPath)) return tsxPath\n  if (fs.existsSync(jsxPath)) return jsxPath\n}\n\nconst getRelativePath = (filePath: string): string => {\n  const baseDir = process.cwd()\n  return path.relative(baseDir, filePath)\n}\n\nconst createEdge = (\n  sourceId: string,\n  targetId: string,\n  topic: string,\n  label: string | undefined,\n  variant: 'event' | 'virtual',\n  conditional?: boolean,\n): FlowEdge => ({\n  id: `${sourceId}-${targetId}`,\n  source: sourceId,\n  target: targetId,\n  data: {\n    variant,\n    label,\n    topic,\n    labelVariant: conditional ? 'conditional' : 'default',\n  },\n})\n\nconst processEmit = (emit: Emit): { topic: string; label?: string; conditional?: boolean } => {\n  const isString = typeof emit === 'string'\n\n  return {\n    topic: isString ? emit : emit.topic,\n    label: isString ? undefined : emit.label,\n    conditional: isString ? undefined : emit.conditional,\n  }\n}\n\nconst createEdgesForEmits = (\n  sourceStep: FlowStepResponse,\n  targetSteps: FlowStepResponse[],\n  emits: Emit[],\n  variant: 'event' | 'virtual',\n): FlowEdge[] => {\n  const edges: FlowEdge[] = []\n\n  emits.forEach((emit) => {\n    const { topic, label, conditional } = processEmit(emit)\n\n    targetSteps.forEach((targetStep) => {\n      if (targetStep.subscribes?.includes(topic) || targetStep.virtualSubscribes?.includes(topic)) {\n        edges.push(createEdge(sourceStep.id, targetStep.id, topic, label, variant, conditional))\n      }\n    })\n  })\n\n  return edges\n}\n\nconst createBaseStepResponse = (\n  step: Step,\n  id: string,\n): Pick<\n  FlowStepResponse,\n  'name' | 'description' | 'nodeComponentPath' | 'language' | 'id' | 'filePath' | 'virtualEmits' | 'virtualSubscribes'\n> => ({\n  id,\n  name: step.config.name,\n  description: step.config.description,\n  nodeComponentPath: getNodeComponentPath(step.filePath),\n  filePath: getRelativePath(step.filePath),\n  language: getStepLanguage(step.filePath),\n\n  virtualEmits: step.config.virtualEmits ?? undefined,\n  virtualSubscribes: step.config.virtualSubscribes ?? undefined,\n})\n\nconst createApiStepResponse = (step: Step, id: string): FlowStepResponse => {\n  if (!isApiStep(step)) {\n    throw new Error('Attempted to create API step response with non-API step')\n  }\n\n  return {\n    ...createBaseStepResponse(step, id),\n    type: 'api',\n    emits: step.config.emits,\n    subscribes: step.config.virtualSubscribes ?? undefined,\n    action: 'webhook',\n    webhookUrl: `${step.config.method} ${step.config.path}`,\n    bodySchema: step.config.bodySchema ?? undefined,\n  }\n}\n\nconst createEventStepResponse = (step: Step, id: string): FlowStepResponse => {\n  if (!isEventStep(step)) {\n    throw new Error('Attempted to create Event step response with non-Event step')\n  }\n\n  return {\n    ...createBaseStepResponse(step, id),\n    type: 'event',\n    emits: step.config.emits,\n    subscribes: step.config.subscribes,\n  }\n}\n\nconst createNoopStepResponse = (step: Step, id: string): FlowStepResponse => {\n  if (!isNoopStep(step)) {\n    throw new Error('Attempted to create Noop step response with non-Noop step')\n  }\n\n  return {\n    ...createBaseStepResponse(step, id),\n    type: 'noop',\n    emits: [],\n    subscribes: step.config.virtualSubscribes,\n  }\n}\n\nconst createCronStepResponse = (step: Step, id: string): FlowStepResponse => {\n  if (!isCronStep(step)) {\n    throw new Error('Attempted to create Cron step response with non-Cron step')\n  }\n\n  return {\n    ...createBaseStepResponse(step, id),\n    type: 'cron',\n    emits: step.config.emits,\n    cronExpression: step.config.cron,\n  }\n}\n\nexport const STEP_NAMESPACE = '7f1c3ff2-9b00-4d0a-bdd7-efb8bca49d4f'\nexport const generateStepId = (filePath: string): string => {\n  return uuidv5(filePath, STEP_NAMESPACE)\n}\n\nconst createStepResponse = (step: Step): FlowStepResponse => {\n  const id = generateStepId(step.filePath)\n  if (isApiStep(step)) return createApiStepResponse(step, id)\n  if (isEventStep(step)) return createEventStepResponse(step, id)\n  if (isNoopStep(step)) return createNoopStepResponse(step, id)\n  if (isCronStep(step)) return createCronStepResponse(step, id)\n\n  throw new Error(`Unknown step type for step: ${step.config.name}`)\n}\n\nconst createEdgesForStep = (sourceStep: FlowStepResponse, allSteps: FlowStepResponse[]): FlowEdge[] => {\n  const regularEdges = createEdgesForEmits(sourceStep, allSteps, sourceStep.emits, 'event')\n  const virtualEdges = sourceStep.virtualEmits\n    ? createEdgesForEmits(sourceStep, allSteps, sourceStep.virtualEmits, 'virtual')\n    : []\n\n  return [...regularEdges, ...virtualEdges]\n}\n\nexport const generateFlow = (flowId: string, flowSteps: Step[]): FlowResponse => {\n  const steps = flowSteps.map(createStepResponse)\n\n  const edges = steps.flatMap((step) => createEdgesForStep(step, steps))\n\n  return { id: flowId, name: flowId, steps, edges }\n}\n"],"mappings":"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"}