{"version":3,"file":"process-manager.mjs","names":["options: ProcessManagerOptions"],"sources":["../../../src/process-communication/process-manager.ts"],"sourcesContent":["import { type ChildProcess, spawn } from 'child_process'\nimport type { Logger } from '../logger'\nimport { RpcProcessor } from '../step-handler-rpc-processor'\nimport { RpcStdinProcessor } from '../step-handler-rpc-stdin-processor'\nimport { type CommunicationType, createCommunicationConfig } from './communication-config'\nimport type { MessageCallback, RpcHandler, RpcProcessorInterface } from './rpc-processor-interface'\n\nexport interface ProcessManagerOptions {\n  command: string\n  args: string[]\n  logger: Logger\n  context?: string\n  projectRoot?: string\n}\n\nexport class ProcessManager {\n  private child?: ChildProcess\n  private processor?: RpcProcessorInterface\n  private communicationType?: CommunicationType\n\n  constructor(private options: ProcessManagerOptions) {}\n\n  async spawn(): Promise<ChildProcess> {\n    const { command, args, logger, context = 'Process', projectRoot } = this.options\n\n    // Get communication configuration\n    const commConfig = createCommunicationConfig(command, projectRoot)\n    this.communicationType = commConfig.type\n\n    logger.debug(`[${context}] Spawning process`, {\n      command,\n      args,\n      communicationType: this.communicationType,\n    })\n\n    // Spawn the process\n    this.child = spawn(command, args, commConfig.spawnOptions)\n\n    // Create appropriate processor based on communication type\n    this.processor = this.communicationType === 'rpc' ? new RpcStdinProcessor(this.child) : new RpcProcessor(this.child)\n\n    // Initialize the processor\n    await this.processor.init()\n\n    return this.child\n  }\n\n  handler<TInput, TOutput = unknown>(method: string, handler: RpcHandler<TInput, TOutput>): void {\n    if (!this.processor) {\n      throw new Error('Process not spawned yet. Call spawn() first.')\n    }\n    this.processor.handler(method, handler)\n  }\n\n  onMessage<T = unknown>(callback: MessageCallback<T>): void {\n    if (!this.processor) {\n      throw new Error('Process not spawned yet. Call spawn() first.')\n    }\n    this.processor.onMessage(callback)\n  }\n\n  onProcessClose(callback: (code: number | null) => void): void {\n    if (!this.child) {\n      throw new Error('Process not spawned yet. Call spawn() first.')\n    }\n    this.child.on('close', callback)\n  }\n\n  onProcessError(callback: (error: Error & { code?: string }) => void): void {\n    if (!this.child) {\n      throw new Error('Process not spawned yet. Call spawn() first.')\n    }\n    this.child.on('error', callback)\n  }\n\n  onStderr(callback: (data: Buffer) => void): void {\n    if (!this.child) {\n      throw new Error('Process not spawned yet. Call spawn() first.')\n    }\n    this.child.stderr?.on('data', callback)\n  }\n\n  onStdout(callback: (data: Buffer) => void): void {\n    if (!this.child) {\n      throw new Error('Process not spawned yet. Call spawn() first.')\n    }\n    // Only for non-RPC mode (in RPC mode, stdout is used for communication)\n    if (this.communicationType !== 'rpc') {\n      this.child.stdout?.on('data', callback)\n    }\n  }\n\n  kill(): void {\n    if (this.child) {\n      this.child.kill('SIGKILL')\n    }\n  }\n\n  close(): void {\n    if (this.child) {\n      this.child.removeAllListeners()\n      this.child.stdout?.removeAllListeners()\n      this.child.stderr?.removeAllListeners()\n    }\n    if (this.processor) {\n      this.processor.close()\n      this.processor = undefined\n    }\n  }\n\n  get process(): ChildProcess | undefined {\n    return this.child\n  }\n\n  get commType(): CommunicationType | undefined {\n    return this.communicationType\n  }\n}\n"],"mappings":";;;;;;AAeA,IAAa,iBAAb,MAA4B;CAK1B,YAAY,AAAQA,SAAgC;EAAhC;;CAEpB,MAAM,QAA+B;EACnC,MAAM,EAAE,SAAS,MAAM,QAAQ,UAAU,WAAW,gBAAgB,KAAK;EAGzE,MAAM,aAAa,0BAA0B,SAAS,YAAY;AAClE,OAAK,oBAAoB,WAAW;AAEpC,SAAO,MAAM,IAAI,QAAQ,qBAAqB;GAC5C;GACA;GACA,mBAAmB,KAAK;GACzB,CAAC;AAGF,OAAK,QAAQ,MAAM,SAAS,MAAM,WAAW,aAAa;AAG1D,OAAK,YAAY,KAAK,sBAAsB,QAAQ,IAAI,kBAAkB,KAAK,MAAM,GAAG,IAAI,aAAa,KAAK,MAAM;AAGpH,QAAM,KAAK,UAAU,MAAM;AAE3B,SAAO,KAAK;;CAGd,QAAmC,QAAgB,SAA4C;AAC7F,MAAI,CAAC,KAAK,UACR,OAAM,IAAI,MAAM,+CAA+C;AAEjE,OAAK,UAAU,QAAQ,QAAQ,QAAQ;;CAGzC,UAAuB,UAAoC;AACzD,MAAI,CAAC,KAAK,UACR,OAAM,IAAI,MAAM,+CAA+C;AAEjE,OAAK,UAAU,UAAU,SAAS;;CAGpC,eAAe,UAA+C;AAC5D,MAAI,CAAC,KAAK,MACR,OAAM,IAAI,MAAM,+CAA+C;AAEjE,OAAK,MAAM,GAAG,SAAS,SAAS;;CAGlC,eAAe,UAA4D;AACzE,MAAI,CAAC,KAAK,MACR,OAAM,IAAI,MAAM,+CAA+C;AAEjE,OAAK,MAAM,GAAG,SAAS,SAAS;;CAGlC,SAAS,UAAwC;AAC/C,MAAI,CAAC,KAAK,MACR,OAAM,IAAI,MAAM,+CAA+C;AAEjE,OAAK,MAAM,QAAQ,GAAG,QAAQ,SAAS;;CAGzC,SAAS,UAAwC;AAC/C,MAAI,CAAC,KAAK,MACR,OAAM,IAAI,MAAM,+CAA+C;AAGjE,MAAI,KAAK,sBAAsB,MAC7B,MAAK,MAAM,QAAQ,GAAG,QAAQ,SAAS;;CAI3C,OAAa;AACX,MAAI,KAAK,MACP,MAAK,MAAM,KAAK,UAAU;;CAI9B,QAAc;AACZ,MAAI,KAAK,OAAO;AACd,QAAK,MAAM,oBAAoB;AAC/B,QAAK,MAAM,QAAQ,oBAAoB;AACvC,QAAK,MAAM,QAAQ,oBAAoB;;AAEzC,MAAI,KAAK,WAAW;AAClB,QAAK,UAAU,OAAO;AACtB,QAAK,YAAY;;;CAIrB,IAAI,UAAoC;AACtC,SAAO,KAAK;;CAGd,IAAI,WAA0C;AAC5C,SAAO,KAAK"}