{"version":3,"file":"redis-logs-stream.mjs","names":["uuidv4","keys: string[]","cursor: string | number","item: BaseStreamItem<Log>"],"sources":["../../../src/streams/redis-logs-stream.ts"],"sourcesContent":["import type { RedisClientType } from 'redis'\nimport { v4 as uuidv4 } from 'uuid'\nimport { StreamAdapter } from '../adapters/interfaces/stream-adapter.interface'\nimport type { BaseStreamItem, StateStreamEvent } from '../types-stream'\n\nexport type Log = {\n  id: string\n  level: string\n  time: number\n  msg: string\n  traceId: string\n  flows: string[]\n  [key: string]: any\n}\n\nconst LOG_TTL_SECONDS = 3 * 24 * 60 * 60\n\nexport class RedisLogsStream extends StreamAdapter<Log> {\n  private client: RedisClientType\n  readonly keyPrefix = 'motia:logs:'\n\n  constructor(client: RedisClientType) {\n    super('__motia.logs')\n    this.client = client\n  }\n\n  private makeLogKey(groupId: string, id: string): string {\n    return `${this.keyPrefix}${groupId}:${id}`\n  }\n\n  private makeChannelKey(channel: { groupId: string; id: string }): string {\n    return `${this.keyPrefix}events:${channel.groupId}:${channel.id}`\n  }\n\n  private makeLogId(): string {\n    return `${Date.now()}-${uuidv4()}`\n  }\n\n  private async scanKeys(pattern: string): Promise<string[]> {\n    const keys: string[] = []\n    let cursor: string | number = '0'\n\n    do {\n      const result = await this.client.scan(cursor.toString(), {\n        MATCH: pattern,\n        COUNT: 100,\n      })\n      cursor = result.cursor\n      keys.push(...result.keys)\n    } while (String(cursor) !== '0')\n\n    return keys\n  }\n\n  async get(groupId: string, id: string): Promise<BaseStreamItem<Log> | null> {\n    const key = this.makeLogKey(groupId, id)\n    const value = await this.client.get(key)\n    return value ? JSON.parse(value) : null\n  }\n\n  async set(groupId: string, id: string, data: Log): Promise<BaseStreamItem<Log>> {\n    const logId = id || this.makeLogId()\n    const key = this.makeLogKey(groupId, logId)\n    const logData: Log = { ...data, id: logId }\n    const item: BaseStreamItem<Log> = { ...logData, id: logId }\n    const itemJson = JSON.stringify(item)\n\n    await Promise.all([\n      this.client.set(key, itemJson),\n      this.client.expire(key, LOG_TTL_SECONDS),\n      this.send({ groupId, id: logId }, { type: 'log', data: item }),\n    ])\n\n    return item\n  }\n\n  async delete(groupId: string, id: string): Promise<BaseStreamItem<Log> | null> {\n    const key = this.makeLogKey(groupId, id)\n    const value = await this.client.get(key)\n\n    if (!value) return null\n\n    const item = JSON.parse(value) as BaseStreamItem<Log>\n\n    await Promise.all([this.client.del(key), this.send({ groupId, id }, { type: 'delete', data: item })])\n\n    return item\n  }\n\n  async getGroup(groupId: string): Promise<BaseStreamItem<Log>[]> {\n    const pattern = `${this.keyPrefix}${groupId}:*`\n    const keys = await this.scanKeys(pattern)\n\n    if (keys.length === 0) return []\n\n    const values = await this.client.mGet(keys)\n    const logs = values.filter((v): v is string => v !== null).map((v) => JSON.parse(v) as BaseStreamItem<Log>)\n\n    const sortDesc = (a: BaseStreamItem<Log>, b: BaseStreamItem<Log>) => a.time - b.time\n    return logs.sort(sortDesc)\n  }\n\n  async send<T>(channel: { groupId: string; id: string }, event: StateStreamEvent<T>): Promise<void> {\n    const channelKey = this.makeChannelKey(channel)\n    await this.client.publish(channelKey, JSON.stringify(event))\n  }\n\n  async clear(groupId: string): Promise<void> {\n    const pattern = `${this.keyPrefix}${groupId}:*`\n    const keys = await this.scanKeys(pattern)\n\n    if (keys.length === 0) return\n\n    await this.client.del(keys)\n  }\n}\n"],"mappings":";;;;AAeA,MAAM,kBAAkB,OAAc;AAEtC,IAAa,kBAAb,cAAqC,cAAmB;CAItD,YAAY,QAAyB;AACnC,QAAM,eAAe;mBAHF;AAInB,OAAK,SAAS;;CAGhB,AAAQ,WAAW,SAAiB,IAAoB;AACtD,SAAO,GAAG,KAAK,YAAY,QAAQ,GAAG;;CAGxC,AAAQ,eAAe,SAAkD;AACvE,SAAO,GAAG,KAAK,UAAU,SAAS,QAAQ,QAAQ,GAAG,QAAQ;;CAG/D,AAAQ,YAAoB;AAC1B,SAAO,GAAG,KAAK,KAAK,CAAC,GAAGA,IAAQ;;CAGlC,MAAc,SAAS,SAAoC;EACzD,MAAMC,OAAiB,EAAE;EACzB,IAAIC,SAA0B;AAE9B,KAAG;GACD,MAAM,SAAS,MAAM,KAAK,OAAO,KAAK,OAAO,UAAU,EAAE;IACvD,OAAO;IACP,OAAO;IACR,CAAC;AACF,YAAS,OAAO;AAChB,QAAK,KAAK,GAAG,OAAO,KAAK;WAClB,OAAO,OAAO,KAAK;AAE5B,SAAO;;CAGT,MAAM,IAAI,SAAiB,IAAiD;EAC1E,MAAM,MAAM,KAAK,WAAW,SAAS,GAAG;EACxC,MAAM,QAAQ,MAAM,KAAK,OAAO,IAAI,IAAI;AACxC,SAAO,QAAQ,KAAK,MAAM,MAAM,GAAG;;CAGrC,MAAM,IAAI,SAAiB,IAAY,MAAyC;EAC9E,MAAM,QAAQ,MAAM,KAAK,WAAW;EACpC,MAAM,MAAM,KAAK,WAAW,SAAS,MAAM;EAE3C,MAAMC,OAA4B;GADX,GAAG;GAAM,IAAI;GACY,IAAI;GAAO;EAC3D,MAAM,WAAW,KAAK,UAAU,KAAK;AAErC,QAAM,QAAQ,IAAI;GAChB,KAAK,OAAO,IAAI,KAAK,SAAS;GAC9B,KAAK,OAAO,OAAO,KAAK,gBAAgB;GACxC,KAAK,KAAK;IAAE;IAAS,IAAI;IAAO,EAAE;IAAE,MAAM;IAAO,MAAM;IAAM,CAAC;GAC/D,CAAC;AAEF,SAAO;;CAGT,MAAM,OAAO,SAAiB,IAAiD;EAC7E,MAAM,MAAM,KAAK,WAAW,SAAS,GAAG;EACxC,MAAM,QAAQ,MAAM,KAAK,OAAO,IAAI,IAAI;AAExC,MAAI,CAAC,MAAO,QAAO;EAEnB,MAAM,OAAO,KAAK,MAAM,MAAM;AAE9B,QAAM,QAAQ,IAAI,CAAC,KAAK,OAAO,IAAI,IAAI,EAAE,KAAK,KAAK;GAAE;GAAS;GAAI,EAAE;GAAE,MAAM;GAAU,MAAM;GAAM,CAAC,CAAC,CAAC;AAErG,SAAO;;CAGT,MAAM,SAAS,SAAiD;EAC9D,MAAM,UAAU,GAAG,KAAK,YAAY,QAAQ;EAC5C,MAAM,OAAO,MAAM,KAAK,SAAS,QAAQ;AAEzC,MAAI,KAAK,WAAW,EAAG,QAAO,EAAE;EAGhC,MAAM,QADS,MAAM,KAAK,OAAO,KAAK,KAAK,EACvB,QAAQ,MAAmB,MAAM,KAAK,CAAC,KAAK,MAAM,KAAK,MAAM,EAAE,CAAwB;EAE3G,MAAM,YAAY,GAAwB,MAA2B,EAAE,OAAO,EAAE;AAChF,SAAO,KAAK,KAAK,SAAS;;CAG5B,MAAM,KAAQ,SAA0C,OAA2C;EACjG,MAAM,aAAa,KAAK,eAAe,QAAQ;AAC/C,QAAM,KAAK,OAAO,QAAQ,YAAY,KAAK,UAAU,MAAM,CAAC;;CAG9D,MAAM,MAAM,SAAgC;EAC1C,MAAM,UAAU,GAAG,KAAK,YAAY,QAAQ;EAC5C,MAAM,OAAO,MAAM,KAAK,SAAS,QAAQ;AAEzC,MAAI,KAAK,WAAW,EAAG;AAEvB,QAAM,KAAK,OAAO,IAAI,KAAK"}