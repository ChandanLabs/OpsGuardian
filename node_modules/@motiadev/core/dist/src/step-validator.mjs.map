{"version":3,"file":"step-validator.mjs","names":[],"sources":["../../src/step-validator.ts"],"sourcesContent":["import { z } from 'zod'\nimport { infrastructureSchema } from './infrastructure-validator/schemas'\nimport type { Step } from './types'\n\nconst objectSchema = z.object({\n  type: z.literal('object'),\n  properties: z.record(z.string(), z.any()),\n  required: z.array(z.string()).optional(),\n  additionalProperties: z.boolean().optional(),\n  description: z.string().optional(),\n  title: z.string().optional(),\n})\n\nconst arraySchema = z.object({\n  type: z.literal('array'),\n  items: objectSchema,\n  description: z.string().optional(),\n  title: z.string().optional(),\n})\n\nconst jsonSchema = z.any().refine((data) => {\n  if (!data) {\n    return true\n  } else if (data.type === 'object') {\n    return objectSchema.parse(data)\n  } else if (data.type === 'array') {\n    return arraySchema.parse(data)\n  }\n\n  return true\n})\n\nconst emits = z.array(\n  z.union([\n    z.string(),\n    z\n      .object({\n        topic: z.string(),\n        label: z.string().optional(),\n        conditional: z.boolean().optional(),\n      })\n      .strict(),\n  ]),\n)\n\nconst noopSchema = z\n  .object({\n    type: z.literal('noop'),\n    name: z.string(),\n    description: z.string().optional(),\n    virtualEmits: emits,\n    virtualSubscribes: z.array(z.string()),\n    flows: z.array(z.string()).optional(),\n  })\n  .strict()\n\nconst eventSchema = z\n  .object({\n    type: z.literal('event'),\n    name: z.string(),\n    description: z.string().optional(),\n    subscribes: z.array(z.string()),\n    emits: emits,\n    virtualEmits: emits.optional(),\n    virtualSubscribes: z.array(z.string()).optional(),\n    input: z.union([jsonSchema, z.object({}), z.null()]).optional(),\n    flows: z.array(z.string()).optional(),\n    includeFiles: z.array(z.string()).optional(),\n    infrastructure: infrastructureSchema.optional(),\n  })\n  .strict()\n\nconst apiSchema = z\n  .object({\n    type: z.literal('api'),\n    name: z.string(),\n    description: z.string().optional(),\n    path: z.string(),\n    method: z.string(),\n    emits: emits,\n    virtualEmits: emits.optional(),\n    virtualSubscribes: z.array(z.string()).optional(),\n    flows: z.array(z.string()).optional(),\n    includeFiles: z.array(z.string()).optional(),\n    middleware: z.array(z.any()).optional(),\n    queryParams: z.array(z.object({ name: z.string(), description: z.string().optional() })).optional(),\n    bodySchema: z.union([jsonSchema, z.object({}), z.null()]).optional(),\n    responseSchema: z.record(z.string(), jsonSchema).optional(),\n  })\n  .strict()\n\nconst cronSchema = z\n  .object({\n    type: z.literal('cron'),\n    name: z.string(),\n    description: z.string().optional(),\n    cron: z.string(),\n    virtualEmits: emits.optional(),\n    virtualSubscribes: z.array(z.string()).optional(),\n    emits: emits,\n    flows: z.array(z.string()).optional(),\n    includeFiles: z.array(z.string()).optional(),\n  })\n  .strict()\n\nexport type ValidationSuccess = {\n  success: true\n}\n\nexport type ValidationError = {\n  success: false\n  error: string\n  errors?: Array<{ path: string; message: string }>\n}\n\nexport type ValidationResult = ValidationSuccess | ValidationError\n\nexport const validateStep = (step: Step): ValidationResult => {\n  try {\n    if (step.config.type === 'noop') {\n      noopSchema.parse(step.config)\n    } else if (step.config.type === 'event') {\n      eventSchema.parse(step.config)\n    } else if (step.config.type === 'api') {\n      apiSchema.parse(step.config)\n    } else if (step.config.type === 'cron') {\n      cronSchema.parse(step.config)\n    } else {\n      return {\n        success: false,\n        error: 'Invalid step type',\n      }\n    }\n\n    return { success: true }\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      return {\n        success: false,\n        error: error.issues.map((err) => err.message).join(', '),\n        errors: error.issues.map((err) => ({ path: err.path.join('.'), message: err.message })),\n      }\n    }\n\n    // Handle unexpected errors\n    return {\n      success: false,\n      error: 'Unexpected validation error occurred',\n    }\n  }\n}\n"],"mappings":"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"}