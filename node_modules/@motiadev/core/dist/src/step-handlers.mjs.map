{"version":3,"file":"step-handlers.mjs","names":["handlers: Array<SubscriptionHandle>"],"sources":["../../src/step-handlers.ts"],"sourcesContent":["import type { EventAdapter, SubscriptionHandle } from './adapters/interfaces/event-adapter.interface'\nimport { callStepFile } from './call-step-file'\nimport { getQueueConfigWithDefaults } from './infrastructure-validator/defaults'\nimport { validateInfrastructureConfig } from './infrastructure-validator/validations'\nimport { globalLogger } from './logger'\nimport type { Motia } from './motia'\nimport type { Event, EventConfig, Step } from './types'\nimport { validateEventInput } from './validate-event-input'\n\nexport type MotiaEventManager = {\n  createHandler: (step: Step<EventConfig>) => void\n  removeHandler: (step: Step<EventConfig>) => void\n}\n\nexport const createStepHandlers = (motia: Motia, eventAdapter: EventAdapter): MotiaEventManager => {\n  const eventSteps = motia.lockedData.eventSteps()\n  const handlerMap = new Map<string, Array<SubscriptionHandle>>()\n\n  globalLogger.debug(`[step handler] creating step handlers for ${eventSteps.length} steps`)\n\n  const removeLogger = (event: Event) => {\n    const { logger, tracer, ...rest } = event\n    return rest\n  }\n\n  const createHandler = (step: Step<EventConfig>) => {\n    const { config, filePath } = step\n    const { subscribes, name } = config\n\n    globalLogger.debug('[step handler] establishing step subscriptions', { filePath, step: step.config.name })\n\n    // âœ… Validate infrastructure config if present\n    if (config.infrastructure) {\n      globalLogger.debug('[step handler] validating infrastructure config', {\n        step: name,\n        infrastructure: config.infrastructure,\n      })\n\n      const validationResult = validateInfrastructureConfig(config.infrastructure)\n\n      if (!validationResult.success && validationResult.errors) {\n        globalLogger.error('[step handler] Infrastructure configuration validation failed', {\n          step: name,\n          filePath,\n          errors: validationResult.errors,\n        })\n        return\n      }\n\n      globalLogger.debug('[step handler] infrastructure config validated successfully', { step: name })\n    }\n\n    const queueConfig = getQueueConfigWithDefaults(config.infrastructure)\n    const handlers: Array<SubscriptionHandle> = []\n\n    subscribes.forEach(async (subscribe) => {\n      const handler = async (event: Event) => {\n        const { data, traceId, flows } = event\n\n        const logger = event.logger\n          ? event.logger.child({ step: step.config.name })\n          : motia.loggerFactory.create({ traceId, flows: flows || [], stepName: step.config.name })\n\n        const tracer = event.tracer\n          ? event.tracer.child(step, logger)\n          : await motia.tracerFactory.attachToTrace(traceId, step, logger)\n\n        globalLogger.debug('[step handler] received event', { event: removeLogger(event), step: name })\n\n        validateEventInput(step, event, motia)\n\n        // Continue execution even if validation failed\n        await callStepFile({ step, data, traceId, tracer, logger, infrastructure: config.infrastructure }, motia)\n      }\n\n      const subscriptionHandle = await eventAdapter.subscribe(subscribe, name, handler, queueConfig)\n      handlers.push(subscriptionHandle)\n    })\n\n    handlerMap.set(filePath, handlers)\n  }\n\n  const removeHandler = (step: Step<EventConfig>) => {\n    const { filePath } = step\n    const handlers = handlerMap.get(filePath)\n\n    if (handlers) {\n      handlers.forEach((subscriptionHandle) => {\n        eventAdapter.unsubscribe(subscriptionHandle)\n        globalLogger.debug('[step handler] unsubscribed handler', {\n          filePath,\n          ...subscriptionHandle,\n          step: step.config.name,\n        })\n      })\n      handlerMap.delete(filePath)\n    }\n  }\n\n  eventSteps.forEach(createHandler)\n\n  return { removeHandler, createHandler }\n}\n"],"mappings":";;;;;;;AAcA,MAAa,sBAAsB,OAAc,iBAAkD;CACjG,MAAM,aAAa,MAAM,WAAW,YAAY;CAChD,MAAM,6BAAa,IAAI,KAAwC;AAE/D,cAAa,MAAM,6CAA6C,WAAW,OAAO,QAAQ;CAE1F,MAAM,gBAAgB,UAAiB;EACrC,MAAM,EAAE,QAAQ,QAAQ,GAAG,SAAS;AACpC,SAAO;;CAGT,MAAM,iBAAiB,SAA4B;EACjD,MAAM,EAAE,QAAQ,aAAa;EAC7B,MAAM,EAAE,YAAY,SAAS;AAE7B,eAAa,MAAM,kDAAkD;GAAE;GAAU,MAAM,KAAK,OAAO;GAAM,CAAC;AAG1G,MAAI,OAAO,gBAAgB;AACzB,gBAAa,MAAM,mDAAmD;IACpE,MAAM;IACN,gBAAgB,OAAO;IACxB,CAAC;GAEF,MAAM,mBAAmB,6BAA6B,OAAO,eAAe;AAE5E,OAAI,CAAC,iBAAiB,WAAW,iBAAiB,QAAQ;AACxD,iBAAa,MAAM,iEAAiE;KAClF,MAAM;KACN;KACA,QAAQ,iBAAiB;KAC1B,CAAC;AACF;;AAGF,gBAAa,MAAM,+DAA+D,EAAE,MAAM,MAAM,CAAC;;EAGnG,MAAM,cAAc,2BAA2B,OAAO,eAAe;EACrE,MAAMA,WAAsC,EAAE;AAE9C,aAAW,QAAQ,OAAO,cAAc;GACtC,MAAM,UAAU,OAAO,UAAiB;IACtC,MAAM,EAAE,MAAM,SAAS,UAAU;IAEjC,MAAM,SAAS,MAAM,SACjB,MAAM,OAAO,MAAM,EAAE,MAAM,KAAK,OAAO,MAAM,CAAC,GAC9C,MAAM,cAAc,OAAO;KAAE;KAAS,OAAO,SAAS,EAAE;KAAE,UAAU,KAAK,OAAO;KAAM,CAAC;IAE3F,MAAM,SAAS,MAAM,SACjB,MAAM,OAAO,MAAM,MAAM,OAAO,GAChC,MAAM,MAAM,cAAc,cAAc,SAAS,MAAM,OAAO;AAElE,iBAAa,MAAM,iCAAiC;KAAE,OAAO,aAAa,MAAM;KAAE,MAAM;KAAM,CAAC;AAE/F,uBAAmB,MAAM,OAAO,MAAM;AAGtC,UAAM,aAAa;KAAE;KAAM;KAAM;KAAS;KAAQ;KAAQ,gBAAgB,OAAO;KAAgB,EAAE,MAAM;;GAG3G,MAAM,qBAAqB,MAAM,aAAa,UAAU,WAAW,MAAM,SAAS,YAAY;AAC9F,YAAS,KAAK,mBAAmB;IACjC;AAEF,aAAW,IAAI,UAAU,SAAS;;CAGpC,MAAM,iBAAiB,SAA4B;EACjD,MAAM,EAAE,aAAa;EACrB,MAAM,WAAW,WAAW,IAAI,SAAS;AAEzC,MAAI,UAAU;AACZ,YAAS,SAAS,uBAAuB;AACvC,iBAAa,YAAY,mBAAmB;AAC5C,iBAAa,MAAM,uCAAuC;KACxD;KACA,GAAG;KACH,MAAM,KAAK,OAAO;KACnB,CAAC;KACF;AACF,cAAW,OAAO,SAAS;;;AAI/B,YAAW,QAAQ,cAAc;AAEjC,QAAO;EAAE;EAAe;EAAe"}