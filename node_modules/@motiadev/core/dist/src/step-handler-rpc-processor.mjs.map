{"version":3,"file":"step-handler-rpc-processor.mjs","names":["child: ChildProcess"],"sources":["../../src/step-handler-rpc-processor.ts"],"sourcesContent":["import type { ChildProcess } from 'child_process'\nimport type {\n  MessageCallback,\n  RpcHandler,\n  RpcProcessorInterface,\n} from './process-communication/rpc-processor-interface'\n\nexport type RpcMessage = {\n  type: 'rpc_request'\n  id: string | undefined\n  method: string\n  args: unknown\n}\n\nexport class RpcProcessor implements RpcProcessorInterface {\n  private handlers: Record<string, RpcHandler<any, any>> = {}\n\n  private messageCallback?: MessageCallback<any>\n  private isClosed = false\n\n  constructor(private child: ChildProcess) {}\n\n  handler<TInput, TOutput = unknown>(method: string, handler: RpcHandler<TInput, TOutput>) {\n    this.handlers[method] = handler\n  }\n\n  onMessage<T = unknown>(callback: MessageCallback<T>): void {\n    this.messageCallback = callback\n  }\n\n  async handle(method: string, input: unknown) {\n    const handler = this.handlers[method]\n    if (!handler) {\n      throw new Error(`Handler for method ${method} not found`)\n    }\n    return handler(input)\n  }\n\n  private response(id: string | undefined, result: unknown, error: unknown) {\n    if (id && !this.isClosed && this.child.send && this.child.connected) {\n      const responseMessage = {\n        type: 'rpc_response',\n        id,\n        result: error ? undefined : result,\n        error: error ? String(error) : undefined,\n      }\n      this.child.send(responseMessage)\n    }\n  }\n\n  async init() {\n    this.child.on('message', (msg: any) => {\n      // Call generic message callback if registered\n      if (this.messageCallback) {\n        this.messageCallback(msg)\n      }\n\n      // Handle RPC requests specifically\n      if (msg && msg.type === 'rpc_request') {\n        const { id, method, args } = msg as RpcMessage\n        this.handle(method, args)\n          .then((result) => this.response(id, result, null))\n          .catch((error) => this.response(id, null, error))\n      }\n    })\n\n    this.child.on('exit', () => {\n      this.isClosed = true\n    })\n    this.child.on('close', () => {\n      this.isClosed = true\n    })\n    this.child.on('disconnect', () => {\n      this.isClosed = true\n    })\n  }\n\n  close() {\n    this.isClosed = true\n    this.messageCallback = undefined\n    this.handlers = {}\n  }\n}\n"],"mappings":";AAcA,IAAa,eAAb,MAA2D;CAMzD,YAAY,AAAQA,OAAqB;EAArB;kBALqC,EAAE;kBAGxC;;CAInB,QAAmC,QAAgB,SAAsC;AACvF,OAAK,SAAS,UAAU;;CAG1B,UAAuB,UAAoC;AACzD,OAAK,kBAAkB;;CAGzB,MAAM,OAAO,QAAgB,OAAgB;EAC3C,MAAM,UAAU,KAAK,SAAS;AAC9B,MAAI,CAAC,QACH,OAAM,IAAI,MAAM,sBAAsB,OAAO,YAAY;AAE3D,SAAO,QAAQ,MAAM;;CAGvB,AAAQ,SAAS,IAAwB,QAAiB,OAAgB;AACxE,MAAI,MAAM,CAAC,KAAK,YAAY,KAAK,MAAM,QAAQ,KAAK,MAAM,WAAW;GACnE,MAAM,kBAAkB;IACtB,MAAM;IACN;IACA,QAAQ,QAAQ,SAAY;IAC5B,OAAO,QAAQ,OAAO,MAAM,GAAG;IAChC;AACD,QAAK,MAAM,KAAK,gBAAgB;;;CAIpC,MAAM,OAAO;AACX,OAAK,MAAM,GAAG,YAAY,QAAa;AAErC,OAAI,KAAK,gBACP,MAAK,gBAAgB,IAAI;AAI3B,OAAI,OAAO,IAAI,SAAS,eAAe;IACrC,MAAM,EAAE,IAAI,QAAQ,SAAS;AAC7B,SAAK,OAAO,QAAQ,KAAK,CACtB,MAAM,WAAW,KAAK,SAAS,IAAI,QAAQ,KAAK,CAAC,CACjD,OAAO,UAAU,KAAK,SAAS,IAAI,MAAM,MAAM,CAAC;;IAErD;AAEF,OAAK,MAAM,GAAG,cAAc;AAC1B,QAAK,WAAW;IAChB;AACF,OAAK,MAAM,GAAG,eAAe;AAC3B,QAAK,WAAW;IAChB;AACF,OAAK,MAAM,GAAG,oBAAoB;AAChC,QAAK,WAAW;IAChB;;CAGJ,QAAQ;AACN,OAAK,WAAW;AAChB,OAAK,kBAAkB;AACvB,OAAK,WAAW,EAAE"}