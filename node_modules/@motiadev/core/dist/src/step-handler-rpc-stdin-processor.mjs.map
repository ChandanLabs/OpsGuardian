{"version":3,"file":"step-handler-rpc-stdin-processor.mjs","names":["child: ChildProcess"],"sources":["../../src/step-handler-rpc-stdin-processor.ts"],"sourcesContent":["import type { ChildProcess } from 'child_process'\nimport readline from 'readline'\nimport type {\n  MessageCallback,\n  RpcHandler,\n  RpcProcessorInterface,\n} from './process-communication/rpc-processor-interface'\n\nexport type RpcMessage = {\n  type: 'rpc_request'\n  id: string | undefined\n  method: string\n  args: unknown\n}\n\nexport class RpcStdinProcessor implements RpcProcessorInterface {\n  private handlers: Record<string, RpcHandler<any, any>> = {}\n\n  private messageCallback?: MessageCallback<any>\n  private isClosed = false\n  private rl?: readline.Interface\n\n  constructor(private child: ChildProcess) {}\n\n  handler<TInput, TOutput = unknown>(method: string, handler: RpcHandler<TInput, TOutput>) {\n    this.handlers[method] = handler\n  }\n\n  onMessage<T = unknown>(callback: MessageCallback<T>): void {\n    this.messageCallback = callback\n  }\n\n  async handle(method: string, input: unknown) {\n    const handler = this.handlers[method]\n    if (!handler) {\n      throw new Error(`Handler for method ${method} not found`)\n    }\n    return handler(input)\n  }\n\n  private response(id: string | undefined, result: unknown, error: unknown) {\n    if (id && !this.isClosed && this.child.stdin && !this.child.killed) {\n      const responseMessage = {\n        type: 'rpc_response',\n        id,\n        result: error ? undefined : result,\n        error: error ? String(error) : undefined,\n      }\n      const messageStr = JSON.stringify(responseMessage)\n      this.child.stdin.write(messageStr + '\\n')\n    }\n  }\n\n  async init() {\n    if (this.child.stdout) {\n      this.rl = readline.createInterface({\n        input: this.child.stdout,\n        crlfDelay: Infinity,\n      })\n\n      this.rl.on('line', (line) => {\n        try {\n          const msg = JSON.parse(line.trim())\n\n          // Call generic message callback if registered\n          if (this.messageCallback) {\n            this.messageCallback(msg)\n          }\n\n          // Handle RPC requests specifically\n          if (msg && msg.type === 'rpc_request') {\n            const { id, method, args } = msg as RpcMessage\n            this.handle(method, args)\n              .then((result) => this.response(id, result, null))\n              .catch((error) => this.response(id, null, error))\n          }\n        } catch (error) {\n          console.error('Failed to parse RPC message:', error, 'Raw line:', line)\n        }\n      })\n\n      this.rl.on('close', () => {\n        this.isClosed = true\n      })\n    }\n\n    this.child.on('exit', () => {\n      this.isClosed = true\n    })\n    this.child.on('close', () => {\n      this.isClosed = true\n    })\n  }\n\n  close() {\n    this.isClosed = true\n    this.messageCallback = undefined\n    this.handlers = {}\n    if (this.rl) {\n      this.rl.removeAllListeners()\n      this.rl.close()\n    }\n  }\n}\n"],"mappings":";;;AAeA,IAAa,oBAAb,MAAgE;CAO9D,YAAY,AAAQA,OAAqB;EAArB;kBANqC,EAAE;kBAGxC;;CAKnB,QAAmC,QAAgB,SAAsC;AACvF,OAAK,SAAS,UAAU;;CAG1B,UAAuB,UAAoC;AACzD,OAAK,kBAAkB;;CAGzB,MAAM,OAAO,QAAgB,OAAgB;EAC3C,MAAM,UAAU,KAAK,SAAS;AAC9B,MAAI,CAAC,QACH,OAAM,IAAI,MAAM,sBAAsB,OAAO,YAAY;AAE3D,SAAO,QAAQ,MAAM;;CAGvB,AAAQ,SAAS,IAAwB,QAAiB,OAAgB;AACxE,MAAI,MAAM,CAAC,KAAK,YAAY,KAAK,MAAM,SAAS,CAAC,KAAK,MAAM,QAAQ;GAClE,MAAM,kBAAkB;IACtB,MAAM;IACN;IACA,QAAQ,QAAQ,SAAY;IAC5B,OAAO,QAAQ,OAAO,MAAM,GAAG;IAChC;GACD,MAAM,aAAa,KAAK,UAAU,gBAAgB;AAClD,QAAK,MAAM,MAAM,MAAM,aAAa,KAAK;;;CAI7C,MAAM,OAAO;AACX,MAAI,KAAK,MAAM,QAAQ;AACrB,QAAK,KAAK,SAAS,gBAAgB;IACjC,OAAO,KAAK,MAAM;IAClB,WAAW;IACZ,CAAC;AAEF,QAAK,GAAG,GAAG,SAAS,SAAS;AAC3B,QAAI;KACF,MAAM,MAAM,KAAK,MAAM,KAAK,MAAM,CAAC;AAGnC,SAAI,KAAK,gBACP,MAAK,gBAAgB,IAAI;AAI3B,SAAI,OAAO,IAAI,SAAS,eAAe;MACrC,MAAM,EAAE,IAAI,QAAQ,SAAS;AAC7B,WAAK,OAAO,QAAQ,KAAK,CACtB,MAAM,WAAW,KAAK,SAAS,IAAI,QAAQ,KAAK,CAAC,CACjD,OAAO,UAAU,KAAK,SAAS,IAAI,MAAM,MAAM,CAAC;;aAE9C,OAAO;AACd,aAAQ,MAAM,gCAAgC,OAAO,aAAa,KAAK;;KAEzE;AAEF,QAAK,GAAG,GAAG,eAAe;AACxB,SAAK,WAAW;KAChB;;AAGJ,OAAK,MAAM,GAAG,cAAc;AAC1B,QAAK,WAAW;IAChB;AACF,OAAK,MAAM,GAAG,eAAe;AAC3B,QAAK,WAAW;IAChB;;CAGJ,QAAQ;AACN,OAAK,WAAW;AAChB,OAAK,kBAAkB;AACvB,OAAK,WAAW,EAAE;AAClB,MAAI,KAAK,IAAI;AACX,QAAK,GAAG,oBAAoB;AAC5B,QAAK,GAAG,OAAO"}