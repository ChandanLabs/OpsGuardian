{"version":3,"file":"node-runner.mjs","names":["arg","filePath","importError: unknown","importedModule: FileModule","err: unknown","stack: string[]"],"sources":["../../../src/node/node-runner.ts"],"sourcesContent":["import dotenv from 'dotenv'\nimport path from 'path'\nimport { pathToFileURL } from 'url'\nimport type { StateStreamEvent, StateStreamEventChannel, StreamConfig } from '../types-stream'\nimport { Logger } from './logger'\nimport { composeMiddleware } from './middleware-compose'\nimport { RpcSender } from './rpc'\nimport { RpcStateManager } from './rpc-state-manager'\n\ndotenv.config()\n\ntype FileModule = { handler?: unknown; default?: { handler?: unknown; config?: unknown }; config?: unknown }\n\nfunction parseArgs(arg: string) {\n  try {\n    return JSON.parse(arg)\n  } catch {\n    return arg\n  }\n}\n\nconst importCompiledModule = async (filePath: string): Promise<FileModule> => {\n  try {\n    return import(pathToFileURL(path.resolve(filePath)).href)\n  } catch (importError: unknown) {\n    const err = importError as Error & { code?: string }\n    const error = {\n      message: `Failed to import module ${filePath}: ${err.message}`,\n      code: err.code || 'IMPORT_ERROR',\n      stack: err.stack || '',\n    }\n\n    throw error\n  }\n}\nasync function runTypescriptModule(filePath: string, event: Record<string, unknown>) {\n  const sender = new RpcSender(process)\n\n  try {\n    sender.init()\n\n    const importedModule: FileModule = await importCompiledModule(filePath)\n\n    const handler = importedModule.handler || importedModule.default?.handler\n    const config = (importedModule.config || importedModule.default?.config || {}) as { middleware?: unknown[] }\n\n    // Check if the specified function exists in the module\n    if (typeof handler !== 'function') {\n      throw new Error(`Function handler not found in module ${filePath}`)\n    }\n\n    const { traceId, flows, contextInFirstArg } = event\n\n    const logger = new Logger(traceId as string, flows as string[], sender)\n    const state = new RpcStateManager(sender)\n\n    const emit = async (data: unknown) => sender.send('emit', data)\n    const streamsConfig = event.streams as StreamConfig[]\n    const streams = (streamsConfig ?? []).reduce(\n      (acc, streams) => {\n        acc[streams.name] = {\n          get: (groupId: string, id: string) => sender.send(`streams.${streams.name}.get`, { groupId, id }),\n          set: (groupId: string, id: string, data: unknown) =>\n            sender.send(`streams.${streams.name}.set`, { groupId, id, data }),\n          delete: (groupId: string, id: string) => sender.send(`streams.${streams.name}.delete`, { groupId, id }),\n          getGroup: (groupId: string) => sender.send(`streams.${streams.name}.getGroup`, { groupId }),\n          send: (channel: StateStreamEventChannel, event: StateStreamEvent<unknown>) =>\n            sender.send(`streams.${streams.name}.send`, { channel, event }),\n        }\n        return acc\n      },\n      {} as Record<string, unknown>,\n    )\n\n    const context = { traceId, flows, logger, state, emit, streams }\n\n    const middlewares = Array.isArray(config.middleware) ? config.middleware : []\n\n    const composedMiddleware = composeMiddleware(...middlewares)\n    const handlerFn = () => {\n      return contextInFirstArg ? handler(context) : handler(event.data, context)\n    }\n\n    const result = await composedMiddleware(event.data, context, handlerFn)\n\n    if (result !== undefined && result !== null) {\n      await sender.send('result', result)\n    }\n\n    sender.sendNoWait('close', undefined)\n    await sender.close()\n    process.exit(0)\n  } catch (err: unknown) {\n    const error = err as Error & { code?: string }\n    const stack: string[] = error.stack?.split('\\n') ?? []\n\n    if (stack) {\n      const index = stack.findIndex((line) => line.includes('src/node/node-runner'))\n      stack.splice(index, stack.length - index)\n      stack.splice(0, 1)\n    }\n\n    const errorObj = {\n      message: error.message || '',\n      code: error.code || null,\n      stack: stack.join('\\n'),\n    }\n    sender.sendNoWait('close', errorObj)\n  }\n}\n\nconst [, , filePath, arg] = process.argv\n\nif (!filePath) {\n  console.error('Usage: node node-runner.mjs <file-path> <arg>')\n  process.exit(1)\n}\n\nrunTypescriptModule(filePath, parseArgs(arg)).catch((err) => {\n  console.error('Error:', err)\n  process.exit(1)\n})\n"],"mappings":"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"}