{"version":3,"file":"rpc.mjs","names":["process: NodeJS.Process"],"sources":["../../../src/node/rpc.ts"],"sourcesContent":["/// <reference types=\"node\" />\nimport crypto from 'crypto'\n\ntype RpcResponse = {\n  type: 'rpc_response'\n  id: string\n  result: unknown\n  error: unknown\n}\n\nexport class RpcSender {\n  private readonly pendingRequests: Record<\n    string,\n    { resolve: (result: any) => void; reject: (error: any) => void; method: string; args: any }\n  > = {}\n\n  constructor(private readonly process: NodeJS.Process) {}\n\n  async close(): Promise<void> {\n    const outstandingRequests = Object.values(this.pendingRequests)\n\n    if (outstandingRequests.length > 0) {\n      console.error('Process ended while there are some promises outstanding')\n      this.process.exit(1)\n    }\n  }\n\n  send<T>(method: string, args: unknown): Promise<T> {\n    return new Promise((resolve, reject) => {\n      const id = crypto.randomUUID()\n      this.pendingRequests[id] = { resolve, reject, method, args }\n\n      this.process.send?.({ type: 'rpc_request', id, method, args })\n    })\n  }\n\n  sendNoWait(method: string, args: unknown) {\n    this.process.send?.({ type: 'rpc_request', method, args })\n  }\n\n  init() {\n    this.process.on('message', (msg: RpcResponse) => {\n      if (msg.type === 'rpc_response') {\n        const { id, result, error } = msg\n        const callbacks = this.pendingRequests[id]\n\n        if (!callbacks) {\n          return\n        } else if (error) {\n          callbacks.reject(error)\n        } else {\n          callbacks.resolve(result)\n        }\n\n        delete this.pendingRequests[id]\n      }\n    })\n  }\n}\n"],"mappings":";;;AAUA,IAAa,YAAb,MAAuB;CAMrB,YAAY,AAAiBA,SAAyB;EAAzB;yBAFzB,EAAE;;CAIN,MAAM,QAAuB;AAG3B,MAF4B,OAAO,OAAO,KAAK,gBAAgB,CAEvC,SAAS,GAAG;AAClC,WAAQ,MAAM,0DAA0D;AACxE,QAAK,QAAQ,KAAK,EAAE;;;CAIxB,KAAQ,QAAgB,MAA2B;AACjD,SAAO,IAAI,SAAS,SAAS,WAAW;GACtC,MAAM,KAAK,OAAO,YAAY;AAC9B,QAAK,gBAAgB,MAAM;IAAE;IAAS;IAAQ;IAAQ;IAAM;AAE5D,QAAK,QAAQ,OAAO;IAAE,MAAM;IAAe;IAAI;IAAQ;IAAM,CAAC;IAC9D;;CAGJ,WAAW,QAAgB,MAAe;AACxC,OAAK,QAAQ,OAAO;GAAE,MAAM;GAAe;GAAQ;GAAM,CAAC;;CAG5D,OAAO;AACL,OAAK,QAAQ,GAAG,YAAY,QAAqB;AAC/C,OAAI,IAAI,SAAS,gBAAgB;IAC/B,MAAM,EAAE,IAAI,QAAQ,UAAU;IAC9B,MAAM,YAAY,KAAK,gBAAgB;AAEvC,QAAI,CAAC,UACH;aACS,MACT,WAAU,OAAO,MAAM;QAEvB,WAAU,QAAQ,OAAO;AAG3B,WAAO,KAAK,gBAAgB;;IAE9B"}