{"version":3,"file":"call-step-file.mjs","names":["result: TData | undefined","timeoutId: NodeJS.Timeout | undefined","flows","data","error: unknown"],"sources":["../../src/call-step-file.ts"],"sourcesContent":["import { trackEvent } from './analytics/utils'\nimport { getLanguageBasedRunner } from './language-runner'\nimport type { Logger } from './logger'\nimport type { Motia } from './motia'\nimport type { Tracer } from './observability'\nimport type { TraceError } from './observability/types'\nimport { ProcessManager } from './process-communication/process-manager'\nimport { compile } from './ts-compiler'\nimport type { Event, InfrastructureConfig, Step } from './types'\nimport type { BaseStreamItem, StateStreamEvent, StateStreamEventChannel } from './types-stream'\nimport { isAllowedToEmit } from './utils'\n\ntype StateGetInput = { traceId: string; key: string }\ntype StateSetInput = { traceId: string; key: string; value: unknown }\ntype StateDeleteInput = { traceId: string; key: string }\ntype StateClearInput = { traceId: string }\n\ntype StateStreamGetInput = { groupId: string; id: string }\ntype StateStreamSendInput = { channel: StateStreamEventChannel; event: StateStreamEvent<unknown> }\ntype StateStreamMutateInput = { groupId: string; id: string; data: BaseStreamItem }\n\ntype CallStepFileOptions = {\n  step: Step\n  traceId: string\n  data?: unknown\n  contextInFirstArg?: boolean\n  logger: Logger\n  tracer: Tracer\n  infrastructure?: Partial<InfrastructureConfig>\n}\n\nexport const callStepFile = <TData>(options: CallStepFileOptions, motia: Motia): Promise<TData | undefined> => {\n  const { step, traceId, data, tracer, logger, contextInFirstArg = false, infrastructure } = options\n\n  const flows = step.config.flows\n\n  return (async () => {\n    try {\n      const streamConfig = motia.lockedData.getStreams()\n      const streams = Object.keys(streamConfig).map((name) => ({ name }))\n      const jsonData = JSON.stringify({ data, flows, traceId, contextInFirstArg, streams })\n\n      const filePathToExecute = step.filePath.endsWith('.ts')\n        ? await compile(step.filePath, motia.lockedData.baseDir)\n        : step.filePath\n\n      const { runner, command, args } = getLanguageBasedRunner(step.filePath)\n      let result: TData | undefined\n      let timeoutId: NodeJS.Timeout | undefined\n\n      return new Promise<TData | undefined>((resolve, reject) => {\n        const processManager = new ProcessManager({\n          command,\n          args: [...args, runner, filePathToExecute, jsonData],\n          logger,\n          context: 'StepExecution',\n          projectRoot: motia.lockedData.baseDir,\n        })\n\n        trackEvent('step_execution_started', {\n          stepName: step.config.name,\n          language: command,\n          type: step.config.type,\n          streams: streams.length,\n        })\n\n        const timeoutSeconds = infrastructure?.handler?.timeout\n        if (timeoutSeconds) {\n          timeoutId = setTimeout(async () => {\n            processManager.kill()\n            const errorMessage = `Step execution timed out after ${timeoutSeconds} seconds`\n            logger.error(errorMessage, { step: step.config.name, timeout: timeoutSeconds })\n            tracer.end({ message: errorMessage })\n            trackEvent('step_execution_timeout', {\n              stepName: step.config.name,\n              traceId,\n              timeout: timeoutSeconds,\n            })\n            reject(new Error(errorMessage))\n          }, timeoutSeconds * 1000)\n        }\n\n        processManager\n          .spawn()\n          .then(() => {\n            processManager.handler<TraceError | undefined>('close', async (err) => {\n              if (err) {\n                if (timeoutId) clearTimeout(timeoutId)\n                processManager.close()\n\n                trackEvent('step_execution_error', {\n                  stepName: step.config.name,\n                  traceId,\n                  message: err.message,\n                })\n\n                tracer.end({\n                  message: err.message,\n                  code: err.code,\n                  stack: err.stack?.replace(new RegExp(`${motia.lockedData.baseDir}/`), ''),\n                })\n\n                const error = err ?? new Error('Handler execution failed')\n\n                reject(error)\n              } else {\n                tracer.end()\n              }\n\n              processManager.kill()\n            })\n            processManager.handler<unknown>('log', async (input: unknown) => logger.log(input))\n\n            processManager.handler<StateGetInput, unknown>('state.get', async (input) => {\n              tracer.stateOperation('get', input)\n              return motia.state.get(input.traceId, input.key)\n            })\n\n            processManager.handler<StateSetInput, unknown>('state.set', async (input) => {\n              tracer.stateOperation('set', { traceId: input.traceId, key: input.key, value: input.value })\n              return motia.state.set(input.traceId, input.key, input.value)\n            })\n\n            processManager.handler<StateDeleteInput, unknown>('state.delete', async (input) => {\n              tracer.stateOperation('delete', input)\n              return motia.state.delete(input.traceId, input.key)\n            })\n\n            processManager.handler<StateClearInput, void>('state.clear', async (input) => {\n              tracer.stateOperation('clear', input)\n              return motia.state.clear(input.traceId)\n            })\n\n            processManager.handler<StateStreamGetInput>(`state.getGroup`, async (input) => {\n              tracer.stateOperation('getGroup', input)\n              return motia.state.getGroup(input.groupId)\n            })\n\n            processManager.handler<TData, void>('result', async (input) => {\n              const inputWithBody = input as TData & { body?: { type?: string; data?: number[] } }\n\n              if (inputWithBody.body && inputWithBody.body.type === 'Buffer') {\n                inputWithBody.body = Buffer.from(inputWithBody.body.data || []) as unknown as typeof inputWithBody.body\n              }\n              result = inputWithBody as TData\n            })\n\n            processManager.handler<Event, unknown>('emit', async (input) => {\n              const flows = step.config.flows\n\n              if (!isAllowedToEmit(step, input.topic)) {\n                tracer.emitOperation(input.topic, input.data, false)\n                return motia.printer.printInvalidEmit(step, input.topic)\n              }\n\n              tracer.emitOperation(input.topic, input.data, true)\n              return motia.eventAdapter.emit({ ...input, traceId, flows, logger, tracer })\n            })\n\n            Object.entries(streamConfig).forEach(([name, streamFactory]) => {\n              const stateStream = streamFactory()\n\n              processManager.handler<StateStreamGetInput>(`streams.${name}.get`, async (input) => {\n                tracer.streamOperation(name, 'get', input)\n                return stateStream.get(input.groupId, input.id)\n              })\n\n              processManager.handler<StateStreamMutateInput>(`streams.${name}.set`, async (input) => {\n                tracer.streamOperation(name, 'set', { groupId: input.groupId, id: input.id, data: input.data })\n                return stateStream.set(input.groupId, input.id, input.data)\n              })\n\n              processManager.handler<StateStreamGetInput>(`streams.${name}.delete`, async (input) => {\n                tracer.streamOperation(name, 'delete', input)\n                return stateStream.delete(input.groupId, input.id)\n              })\n\n              processManager.handler<StateStreamGetInput>(`streams.${name}.getGroup`, async (input) => {\n                tracer.streamOperation(name, 'getGroup', input)\n                return stateStream.getGroup(input.groupId)\n              })\n\n              processManager.handler<StateStreamSendInput>(`streams.${name}.send`, async (input) => {\n                tracer.streamOperation(name, 'send', input)\n                return stateStream.send(input.channel, input.event)\n              })\n            })\n\n            processManager.onStdout((data) => {\n              try {\n                const message = JSON.parse(data.toString())\n                logger.log(message)\n              } catch {\n                logger.info(Buffer.from(data).toString())\n              }\n            })\n\n            processManager.onStderr((data) => logger.error(Buffer.from(data).toString()))\n\n            processManager.onProcessClose(async (code) => {\n              if (timeoutId) clearTimeout(timeoutId)\n              processManager.close()\n\n              if (code !== 0 && code !== null) {\n                const error = { message: `Process exited with code ${code}`, code }\n                tracer.end(error)\n                trackEvent('step_execution_error', { stepName: step.config.name, traceId, code })\n                reject(`Process exited with code ${code}`)\n              } else {\n                tracer.end()\n                resolve(result)\n              }\n            })\n\n            processManager.onProcessError(async (error) => {\n              if (timeoutId) clearTimeout(timeoutId)\n              processManager.close()\n              tracer.end({\n                message: error.message,\n                code: error.code,\n                stack: error.stack,\n              })\n\n              if (error.code === 'ENOENT') {\n                trackEvent('step_execution_error', {\n                  stepName: step.config.name,\n                  traceId,\n                  code: error.code,\n                  message: error.message,\n                })\n                reject(`Executable ${command} not found`)\n              } else {\n                reject(error)\n              }\n            })\n          })\n          .catch(async (error) => {\n            if (timeoutId) clearTimeout(timeoutId)\n            tracer.end({\n              message: error.message,\n              code: error.code,\n              stack: error.stack,\n            })\n\n            trackEvent('step_execution_error', {\n              stepName: step.config.name,\n              traceId,\n              code: error.code,\n              message: error.message,\n            })\n            reject(`Failed to spawn process: ${error}`)\n          })\n      })\n    } catch (error: unknown) {\n      const err = error as Error & { code?: string }\n      tracer.end({\n        message: err.message,\n        code: err.code,\n        stack: err.stack,\n      })\n      trackEvent('step_execution_error', {\n        stepName: step.config.name,\n        traceId,\n        code: err.code,\n        message: err.message,\n      })\n      throw err\n    }\n  })()\n}\n"],"mappings":";;;;;;;AA+BA,MAAa,gBAAuB,SAA8B,UAA6C;CAC7G,MAAM,EAAE,MAAM,SAAS,MAAM,QAAQ,QAAQ,oBAAoB,OAAO,mBAAmB;CAE3F,MAAM,QAAQ,KAAK,OAAO;AAE1B,SAAQ,YAAY;AAClB,MAAI;GACF,MAAM,eAAe,MAAM,WAAW,YAAY;GAClD,MAAM,UAAU,OAAO,KAAK,aAAa,CAAC,KAAK,UAAU,EAAE,MAAM,EAAE;GACnE,MAAM,WAAW,KAAK,UAAU;IAAE;IAAM;IAAO;IAAS;IAAmB;IAAS,CAAC;GAErF,MAAM,oBAAoB,KAAK,SAAS,SAAS,MAAM,GACnD,MAAM,QAAQ,KAAK,UAAU,MAAM,WAAW,QAAQ,GACtD,KAAK;GAET,MAAM,EAAE,QAAQ,SAAS,SAAS,uBAAuB,KAAK,SAAS;GACvE,IAAIA;GACJ,IAAIC;AAEJ,UAAO,IAAI,SAA4B,SAAS,WAAW;IACzD,MAAM,iBAAiB,IAAI,eAAe;KACxC;KACA,MAAM;MAAC,GAAG;MAAM;MAAQ;MAAmB;MAAS;KACpD;KACA,SAAS;KACT,aAAa,MAAM,WAAW;KAC/B,CAAC;AAEF,eAAW,0BAA0B;KACnC,UAAU,KAAK,OAAO;KACtB,UAAU;KACV,MAAM,KAAK,OAAO;KAClB,SAAS,QAAQ;KAClB,CAAC;IAEF,MAAM,iBAAiB,gBAAgB,SAAS;AAChD,QAAI,eACF,aAAY,WAAW,YAAY;AACjC,oBAAe,MAAM;KACrB,MAAM,eAAe,kCAAkC,eAAe;AACtE,YAAO,MAAM,cAAc;MAAE,MAAM,KAAK,OAAO;MAAM,SAAS;MAAgB,CAAC;AAC/E,YAAO,IAAI,EAAE,SAAS,cAAc,CAAC;AACrC,gBAAW,0BAA0B;MACnC,UAAU,KAAK,OAAO;MACtB;MACA,SAAS;MACV,CAAC;AACF,YAAO,IAAI,MAAM,aAAa,CAAC;OAC9B,iBAAiB,IAAK;AAG3B,mBACG,OAAO,CACP,WAAW;AACV,oBAAe,QAAgC,SAAS,OAAO,QAAQ;AACrE,UAAI,KAAK;AACP,WAAI,UAAW,cAAa,UAAU;AACtC,sBAAe,OAAO;AAEtB,kBAAW,wBAAwB;QACjC,UAAU,KAAK,OAAO;QACtB;QACA,SAAS,IAAI;QACd,CAAC;AAEF,cAAO,IAAI;QACT,SAAS,IAAI;QACb,MAAM,IAAI;QACV,OAAO,IAAI,OAAO,wBAAQ,IAAI,OAAO,GAAG,MAAM,WAAW,QAAQ,GAAG,EAAE,GAAG;QAC1E,CAAC;AAIF,cAFc,uBAAO,IAAI,MAAM,2BAA2B,CAE7C;YAEb,QAAO,KAAK;AAGd,qBAAe,MAAM;OACrB;AACF,oBAAe,QAAiB,OAAO,OAAO,UAAmB,OAAO,IAAI,MAAM,CAAC;AAEnF,oBAAe,QAAgC,aAAa,OAAO,UAAU;AAC3E,aAAO,eAAe,OAAO,MAAM;AACnC,aAAO,MAAM,MAAM,IAAI,MAAM,SAAS,MAAM,IAAI;OAChD;AAEF,oBAAe,QAAgC,aAAa,OAAO,UAAU;AAC3E,aAAO,eAAe,OAAO;OAAE,SAAS,MAAM;OAAS,KAAK,MAAM;OAAK,OAAO,MAAM;OAAO,CAAC;AAC5F,aAAO,MAAM,MAAM,IAAI,MAAM,SAAS,MAAM,KAAK,MAAM,MAAM;OAC7D;AAEF,oBAAe,QAAmC,gBAAgB,OAAO,UAAU;AACjF,aAAO,eAAe,UAAU,MAAM;AACtC,aAAO,MAAM,MAAM,OAAO,MAAM,SAAS,MAAM,IAAI;OACnD;AAEF,oBAAe,QAA+B,eAAe,OAAO,UAAU;AAC5E,aAAO,eAAe,SAAS,MAAM;AACrC,aAAO,MAAM,MAAM,MAAM,MAAM,QAAQ;OACvC;AAEF,oBAAe,QAA6B,kBAAkB,OAAO,UAAU;AAC7E,aAAO,eAAe,YAAY,MAAM;AACxC,aAAO,MAAM,MAAM,SAAS,MAAM,QAAQ;OAC1C;AAEF,oBAAe,QAAqB,UAAU,OAAO,UAAU;MAC7D,MAAM,gBAAgB;AAEtB,UAAI,cAAc,QAAQ,cAAc,KAAK,SAAS,SACpD,eAAc,OAAO,OAAO,KAAK,cAAc,KAAK,QAAQ,EAAE,CAAC;AAEjE,eAAS;OACT;AAEF,oBAAe,QAAwB,QAAQ,OAAO,UAAU;MAC9D,MAAMC,UAAQ,KAAK,OAAO;AAE1B,UAAI,CAAC,gBAAgB,MAAM,MAAM,MAAM,EAAE;AACvC,cAAO,cAAc,MAAM,OAAO,MAAM,MAAM,MAAM;AACpD,cAAO,MAAM,QAAQ,iBAAiB,MAAM,MAAM,MAAM;;AAG1D,aAAO,cAAc,MAAM,OAAO,MAAM,MAAM,KAAK;AACnD,aAAO,MAAM,aAAa,KAAK;OAAE,GAAG;OAAO;OAAS;OAAO;OAAQ;OAAQ,CAAC;OAC5E;AAEF,YAAO,QAAQ,aAAa,CAAC,SAAS,CAAC,MAAM,mBAAmB;MAC9D,MAAM,cAAc,eAAe;AAEnC,qBAAe,QAA6B,WAAW,KAAK,OAAO,OAAO,UAAU;AAClF,cAAO,gBAAgB,MAAM,OAAO,MAAM;AAC1C,cAAO,YAAY,IAAI,MAAM,SAAS,MAAM,GAAG;QAC/C;AAEF,qBAAe,QAAgC,WAAW,KAAK,OAAO,OAAO,UAAU;AACrF,cAAO,gBAAgB,MAAM,OAAO;QAAE,SAAS,MAAM;QAAS,IAAI,MAAM;QAAI,MAAM,MAAM;QAAM,CAAC;AAC/F,cAAO,YAAY,IAAI,MAAM,SAAS,MAAM,IAAI,MAAM,KAAK;QAC3D;AAEF,qBAAe,QAA6B,WAAW,KAAK,UAAU,OAAO,UAAU;AACrF,cAAO,gBAAgB,MAAM,UAAU,MAAM;AAC7C,cAAO,YAAY,OAAO,MAAM,SAAS,MAAM,GAAG;QAClD;AAEF,qBAAe,QAA6B,WAAW,KAAK,YAAY,OAAO,UAAU;AACvF,cAAO,gBAAgB,MAAM,YAAY,MAAM;AAC/C,cAAO,YAAY,SAAS,MAAM,QAAQ;QAC1C;AAEF,qBAAe,QAA8B,WAAW,KAAK,QAAQ,OAAO,UAAU;AACpF,cAAO,gBAAgB,MAAM,QAAQ,MAAM;AAC3C,cAAO,YAAY,KAAK,MAAM,SAAS,MAAM,MAAM;QACnD;OACF;AAEF,oBAAe,UAAU,WAAS;AAChC,UAAI;OACF,MAAM,UAAU,KAAK,MAAMC,OAAK,UAAU,CAAC;AAC3C,cAAO,IAAI,QAAQ;cACb;AACN,cAAO,KAAK,OAAO,KAAKA,OAAK,CAAC,UAAU,CAAC;;OAE3C;AAEF,oBAAe,UAAU,WAAS,OAAO,MAAM,OAAO,KAAKA,OAAK,CAAC,UAAU,CAAC,CAAC;AAE7E,oBAAe,eAAe,OAAO,SAAS;AAC5C,UAAI,UAAW,cAAa,UAAU;AACtC,qBAAe,OAAO;AAEtB,UAAI,SAAS,KAAK,SAAS,MAAM;OAC/B,MAAM,QAAQ;QAAE,SAAS,4BAA4B;QAAQ;QAAM;AACnE,cAAO,IAAI,MAAM;AACjB,kBAAW,wBAAwB;QAAE,UAAU,KAAK,OAAO;QAAM;QAAS;QAAM,CAAC;AACjF,cAAO,4BAA4B,OAAO;aACrC;AACL,cAAO,KAAK;AACZ,eAAQ,OAAO;;OAEjB;AAEF,oBAAe,eAAe,OAAO,UAAU;AAC7C,UAAI,UAAW,cAAa,UAAU;AACtC,qBAAe,OAAO;AACtB,aAAO,IAAI;OACT,SAAS,MAAM;OACf,MAAM,MAAM;OACZ,OAAO,MAAM;OACd,CAAC;AAEF,UAAI,MAAM,SAAS,UAAU;AAC3B,kBAAW,wBAAwB;QACjC,UAAU,KAAK,OAAO;QACtB;QACA,MAAM,MAAM;QACZ,SAAS,MAAM;QAChB,CAAC;AACF,cAAO,cAAc,QAAQ,YAAY;YAEzC,QAAO,MAAM;OAEf;MACF,CACD,MAAM,OAAO,UAAU;AACtB,SAAI,UAAW,cAAa,UAAU;AACtC,YAAO,IAAI;MACT,SAAS,MAAM;MACf,MAAM,MAAM;MACZ,OAAO,MAAM;MACd,CAAC;AAEF,gBAAW,wBAAwB;MACjC,UAAU,KAAK,OAAO;MACtB;MACA,MAAM,MAAM;MACZ,SAAS,MAAM;MAChB,CAAC;AACF,YAAO,4BAA4B,QAAQ;MAC3C;KACJ;WACKC,OAAgB;GACvB,MAAM,MAAM;AACZ,UAAO,IAAI;IACT,SAAS,IAAI;IACb,MAAM,IAAI;IACV,OAAO,IAAI;IACZ,CAAC;AACF,cAAW,wBAAwB;IACjC,UAAU,KAAK,OAAO;IACtB;IACA,MAAM,IAAI;IACV,SAAS,IAAI;IACd,CAAC;AACF,SAAM;;KAEN"}