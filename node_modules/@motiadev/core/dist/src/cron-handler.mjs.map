{"version":3,"file":"cron-handler.mjs","names":["lock: CronLock | null","error: any"],"sources":["../../src/cron-handler.ts"],"sourcesContent":["import * as cron from 'node-cron'\nimport type { CronAdapter, CronLock } from './adapters/interfaces/cron-adapter.interface'\nimport { callStepFile } from './call-step-file'\nimport { generateTraceId } from './generate-trace-id'\nimport { globalLogger } from './logger'\nimport type { Motia } from './motia'\nimport type { CronConfig, Step } from './types'\n\nexport type CronManager = {\n  createCronJob: (step: Step<CronConfig>) => void\n  removeCronJob: (step: Step<CronConfig>) => void\n  close: () => Promise<void>\n}\n\nexport const setupCronHandlers = (motia: Motia, cronAdapter?: CronAdapter) => {\n  const cronJobs = new Map<string, cron.ScheduledTask>()\n\n  const createCronJob = (step: Step<CronConfig>) => {\n    const { config, filePath } = step\n    const { cron: cronExpression, name: stepName, flows } = config\n\n    if (!cron.validate(cronExpression)) {\n      globalLogger.error('[cron handler] invalid cron expression', {\n        expression: cronExpression,\n        step: stepName,\n      })\n      return\n    }\n\n    globalLogger.debug('[cron handler] setting up cron job', {\n      filePath,\n      step: stepName,\n      cron: cronExpression,\n    })\n\n    const task = cron.schedule(cronExpression, async () => {\n      let lock: CronLock | null = null\n\n      if (cronAdapter) {\n        try {\n          lock = await cronAdapter.acquireLock(stepName, 300000)\n\n          if (!lock) {\n            globalLogger.debug('[cron handler] failed to acquire lock, skipping execution', {\n              step: stepName,\n            })\n            return\n          }\n\n          globalLogger.debug('[cron handler] acquired lock for cron job', {\n            step: stepName,\n            lockId: lock.lockId,\n            instanceId: lock.instanceId,\n          })\n        } catch (error: any) {\n          globalLogger.error('[cron handler] error acquiring lock', {\n            error: error.message,\n            step: stepName,\n          })\n          return\n        }\n      }\n\n      const traceId = generateTraceId()\n      const logger = motia.loggerFactory.create({ traceId, flows, stepName })\n      const tracer = await motia.tracerFactory.createTracer(traceId, step, logger)\n\n      try {\n        await callStepFile({ contextInFirstArg: true, step, traceId, tracer, logger }, motia)\n      } catch (error: any) {\n        logger.error('[cron handler] error executing cron job', {\n          error: error.message,\n          step: step.config.name,\n        })\n      } finally {\n        if (lock && cronAdapter) {\n          try {\n            await cronAdapter.releaseLock(lock)\n            globalLogger.debug('[cron handler] released lock for cron job', {\n              step: stepName,\n              lockId: lock.lockId,\n            })\n          } catch (error: any) {\n            globalLogger.error('[cron handler] error releasing lock', {\n              error: error.message,\n              step: stepName,\n            })\n          }\n        }\n      }\n    })\n\n    cronJobs.set(step.filePath, task)\n  }\n\n  const removeCronJob = (step: Step<CronConfig>) => {\n    const task = cronJobs.get(step.filePath)\n\n    if (task) {\n      task.stop()\n      cronJobs.delete(step.filePath)\n    }\n  }\n\n  const close = async () => {\n    cronJobs.forEach((task) => task.stop())\n    cronJobs.clear()\n\n    if (cronAdapter) {\n      await cronAdapter.shutdown()\n    }\n  }\n\n  motia.lockedData.cronSteps().forEach(createCronJob)\n\n  return { createCronJob, removeCronJob, close }\n}\n"],"mappings":";;;;;;AAcA,MAAa,qBAAqB,OAAc,gBAA8B;CAC5E,MAAM,2BAAW,IAAI,KAAiC;CAEtD,MAAM,iBAAiB,SAA2B;EAChD,MAAM,EAAE,QAAQ,aAAa;EAC7B,MAAM,EAAE,MAAM,gBAAgB,MAAM,UAAU,UAAU;AAExD,MAAI,CAAC,KAAK,SAAS,eAAe,EAAE;AAClC,gBAAa,MAAM,0CAA0C;IAC3D,YAAY;IACZ,MAAM;IACP,CAAC;AACF;;AAGF,eAAa,MAAM,sCAAsC;GACvD;GACA,MAAM;GACN,MAAM;GACP,CAAC;EAEF,MAAM,OAAO,KAAK,SAAS,gBAAgB,YAAY;GACrD,IAAIA,OAAwB;AAE5B,OAAI,YACF,KAAI;AACF,WAAO,MAAM,YAAY,YAAY,UAAU,IAAO;AAEtD,QAAI,CAAC,MAAM;AACT,kBAAa,MAAM,6DAA6D,EAC9E,MAAM,UACP,CAAC;AACF;;AAGF,iBAAa,MAAM,6CAA6C;KAC9D,MAAM;KACN,QAAQ,KAAK;KACb,YAAY,KAAK;KAClB,CAAC;YACKC,OAAY;AACnB,iBAAa,MAAM,uCAAuC;KACxD,OAAO,MAAM;KACb,MAAM;KACP,CAAC;AACF;;GAIJ,MAAM,UAAU,iBAAiB;GACjC,MAAM,SAAS,MAAM,cAAc,OAAO;IAAE;IAAS;IAAO;IAAU,CAAC;GACvE,MAAM,SAAS,MAAM,MAAM,cAAc,aAAa,SAAS,MAAM,OAAO;AAE5E,OAAI;AACF,UAAM,aAAa;KAAE,mBAAmB;KAAM;KAAM;KAAS;KAAQ;KAAQ,EAAE,MAAM;YAC9EA,OAAY;AACnB,WAAO,MAAM,2CAA2C;KACtD,OAAO,MAAM;KACb,MAAM,KAAK,OAAO;KACnB,CAAC;aACM;AACR,QAAI,QAAQ,YACV,KAAI;AACF,WAAM,YAAY,YAAY,KAAK;AACnC,kBAAa,MAAM,6CAA6C;MAC9D,MAAM;MACN,QAAQ,KAAK;MACd,CAAC;aACKA,OAAY;AACnB,kBAAa,MAAM,uCAAuC;MACxD,OAAO,MAAM;MACb,MAAM;MACP,CAAC;;;IAIR;AAEF,WAAS,IAAI,KAAK,UAAU,KAAK;;CAGnC,MAAM,iBAAiB,SAA2B;EAChD,MAAM,OAAO,SAAS,IAAI,KAAK,SAAS;AAExC,MAAI,MAAM;AACR,QAAK,MAAM;AACX,YAAS,OAAO,KAAK,SAAS;;;CAIlC,MAAM,QAAQ,YAAY;AACxB,WAAS,SAAS,SAAS,KAAK,MAAM,CAAC;AACvC,WAAS,OAAO;AAEhB,MAAI,YACF,OAAM,YAAY,UAAU;;AAIhC,OAAM,WAAW,WAAW,CAAC,QAAQ,cAAc;AAEnD,QAAO;EAAE;EAAe;EAAe;EAAO"}