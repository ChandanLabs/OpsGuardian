{"version":3,"file":"schemas.mjs","names":["AWS_LAMBDA_CPU_RATIO: Record<number, number>"],"sources":["../../../src/infrastructure-validator/schemas.ts"],"sourcesContent":["import { z } from 'zod'\n\nexport const AWS_LAMBDA_LIMITS = {\n  MIN_RAM_MB: 128,\n  MAX_RAM_MB: 10240,\n  MIN_TIMEOUT_SECONDS: 1,\n  MAX_TIMEOUT_SECONDS: 900,\n} as const\n\nexport const AWS_LAMBDA_CPU_RATIO: Record<number, number> = {\n  128: 0.0625,\n  256: 0.125,\n  512: 0.25,\n  1024: 0.5,\n  1536: 0.75,\n  2048: 1,\n  3008: 1.5,\n  4096: 2,\n  5120: 2.5,\n  6144: 3,\n  7168: 3.5,\n  8192: 4,\n  9216: 4.5,\n  10240: 5,\n}\n\nexport function getProportionalCpu(ramMb: number): number {\n  const ramValues = Object.keys(AWS_LAMBDA_CPU_RATIO)\n    .map(Number)\n    .sort((a, b) => a - b)\n\n  const exact = AWS_LAMBDA_CPU_RATIO[ramMb]\n  if (exact !== undefined) {\n    return exact\n  }\n\n  for (let i = 0; i < ramValues.length - 1; i++) {\n    const lower = ramValues[i]\n    const upper = ramValues[i + 1]\n\n    if (ramMb > lower && ramMb < upper) {\n      const lowerCpu = AWS_LAMBDA_CPU_RATIO[lower]\n      const upperCpu = AWS_LAMBDA_CPU_RATIO[upper]\n      const ratio = (ramMb - lower) / (upper - lower)\n      return lowerCpu + (upperCpu - lowerCpu) * ratio\n    }\n  }\n\n  return ramMb <= ramValues[0]\n    ? AWS_LAMBDA_CPU_RATIO[ramValues[0]]\n    : AWS_LAMBDA_CPU_RATIO[ramValues[ramValues.length - 1]]\n}\n\nexport const handlerBaseSchema = z.object({\n  ram: z\n    .number()\n    .min(AWS_LAMBDA_LIMITS.MIN_RAM_MB, `RAM must be at least ${AWS_LAMBDA_LIMITS.MIN_RAM_MB} MB`)\n    .max(AWS_LAMBDA_LIMITS.MAX_RAM_MB, `RAM cannot exceed ${AWS_LAMBDA_LIMITS.MAX_RAM_MB} MB`),\n  timeout: z\n    .number()\n    .min(AWS_LAMBDA_LIMITS.MIN_TIMEOUT_SECONDS, `Timeout must be at least ${AWS_LAMBDA_LIMITS.MIN_TIMEOUT_SECONDS}s`)\n    .max(AWS_LAMBDA_LIMITS.MAX_TIMEOUT_SECONDS, `Timeout cannot exceed ${AWS_LAMBDA_LIMITS.MAX_TIMEOUT_SECONDS}s`),\n  cpu: z.number().optional(),\n})\n\nexport const handlerSchema = handlerBaseSchema.partial().superRefine((handler, ctx) => {\n  if (handler.cpu === undefined || handler.ram === undefined) {\n    return\n  }\n\n  const expectedCpu = getProportionalCpu(handler.ram)\n  const tolerance = 0.1\n\n  if (Math.abs(handler.cpu - expectedCpu) > tolerance) {\n    ctx.addIssue({\n      code: z.ZodIssueCode.custom,\n      path: ['handler', 'cpu'],\n      message: `CPU (${handler.cpu} vCPU) is not proportional to RAM (${handler.ram} MB). Expected approximately ${expectedCpu.toFixed(2)} vCPU`,\n    })\n  }\n})\n\nexport const queueSchema = z.object({\n  type: z.enum(['standard', 'fifo']),\n  visibilityTimeout: z.number(),\n  maxRetries: z.number().min(0, 'maxRetries cannot be negative'),\n  delaySeconds: z\n    .number()\n    .min(0, 'delaySeconds cannot be negative')\n    .max(900, 'delaySeconds cannot exceed 900 seconds (15 minutes)')\n    .optional(),\n})\n\nexport const infrastructureSchema = z\n  .object({\n    handler: handlerSchema.optional(),\n    queue: queueSchema.partial().optional(),\n  })\n  .superRefine((config, ctx) => {\n    if (config.queue?.visibilityTimeout !== undefined && config.handler?.timeout !== undefined) {\n      if (config.queue.visibilityTimeout <= config.handler.timeout) {\n        ctx.addIssue({\n          code: z.ZodIssueCode.custom,\n          path: ['queue', 'visibilityTimeout'],\n          message: `Visibility timeout (${config.queue.visibilityTimeout}s) must be greater than handler timeout (${config.handler.timeout}s) to prevent premature message redelivery`,\n        })\n      }\n    }\n  })\n"],"mappings":";;;AAEA,MAAa,oBAAoB;CAC/B,YAAY;CACZ,YAAY;CACZ,qBAAqB;CACrB,qBAAqB;CACtB;AAED,MAAaA,uBAA+C;CAC1D,KAAK;CACL,KAAK;CACL,KAAK;CACL,MAAM;CACN,MAAM;CACN,MAAM;CACN,MAAM;CACN,MAAM;CACN,MAAM;CACN,MAAM;CACN,MAAM;CACN,MAAM;CACN,MAAM;CACN,OAAO;CACR;AAED,SAAgB,mBAAmB,OAAuB;CACxD,MAAM,YAAY,OAAO,KAAK,qBAAqB,CAChD,IAAI,OAAO,CACX,MAAM,GAAG,MAAM,IAAI,EAAE;CAExB,MAAM,QAAQ,qBAAqB;AACnC,KAAI,UAAU,OACZ,QAAO;AAGT,MAAK,IAAI,IAAI,GAAG,IAAI,UAAU,SAAS,GAAG,KAAK;EAC7C,MAAM,QAAQ,UAAU;EACxB,MAAM,QAAQ,UAAU,IAAI;AAE5B,MAAI,QAAQ,SAAS,QAAQ,OAAO;GAClC,MAAM,WAAW,qBAAqB;GACtC,MAAM,WAAW,qBAAqB;GACtC,MAAM,SAAS,QAAQ,UAAU,QAAQ;AACzC,UAAO,YAAY,WAAW,YAAY;;;AAI9C,QAAO,SAAS,UAAU,KACtB,qBAAqB,UAAU,MAC/B,qBAAqB,UAAU,UAAU,SAAS;;AAGxD,MAAa,oBAAoB,EAAE,OAAO;CACxC,KAAK,EACF,QAAQ,CACR,IAAI,kBAAkB,YAAY,wBAAwB,kBAAkB,WAAW,KAAK,CAC5F,IAAI,kBAAkB,YAAY,qBAAqB,kBAAkB,WAAW,KAAK;CAC5F,SAAS,EACN,QAAQ,CACR,IAAI,kBAAkB,qBAAqB,4BAA4B,kBAAkB,oBAAoB,GAAG,CAChH,IAAI,kBAAkB,qBAAqB,yBAAyB,kBAAkB,oBAAoB,GAAG;CAChH,KAAK,EAAE,QAAQ,CAAC,UAAU;CAC3B,CAAC;AAEF,MAAa,gBAAgB,kBAAkB,SAAS,CAAC,aAAa,SAAS,QAAQ;AACrF,KAAI,QAAQ,QAAQ,UAAa,QAAQ,QAAQ,OAC/C;CAGF,MAAM,cAAc,mBAAmB,QAAQ,IAAI;AAGnD,KAAI,KAAK,IAAI,QAAQ,MAAM,YAAY,GAFrB,GAGhB,KAAI,SAAS;EACX,MAAM,EAAE,aAAa;EACrB,MAAM,CAAC,WAAW,MAAM;EACxB,SAAS,QAAQ,QAAQ,IAAI,qCAAqC,QAAQ,IAAI,+BAA+B,YAAY,QAAQ,EAAE,CAAC;EACrI,CAAC;EAEJ;AAEF,MAAa,cAAc,EAAE,OAAO;CAClC,MAAM,EAAE,KAAK,CAAC,YAAY,OAAO,CAAC;CAClC,mBAAmB,EAAE,QAAQ;CAC7B,YAAY,EAAE,QAAQ,CAAC,IAAI,GAAG,gCAAgC;CAC9D,cAAc,EACX,QAAQ,CACR,IAAI,GAAG,kCAAkC,CACzC,IAAI,KAAK,sDAAsD,CAC/D,UAAU;CACd,CAAC;AAEF,MAAa,uBAAuB,EACjC,OAAO;CACN,SAAS,cAAc,UAAU;CACjC,OAAO,YAAY,SAAS,CAAC,UAAU;CACxC,CAAC,CACD,aAAa,QAAQ,QAAQ;AAC5B,KAAI,OAAO,OAAO,sBAAsB,UAAa,OAAO,SAAS,YAAY,QAC/E;MAAI,OAAO,MAAM,qBAAqB,OAAO,QAAQ,QACnD,KAAI,SAAS;GACX,MAAM,EAAE,aAAa;GACrB,MAAM,CAAC,SAAS,oBAAoB;GACpC,SAAS,uBAAuB,OAAO,MAAM,kBAAkB,2CAA2C,OAAO,QAAQ,QAAQ;GAClI,CAAC;;EAGN"}