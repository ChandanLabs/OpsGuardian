{"version":3,"file":"file-state-adapter.mjs","names":["path"],"sources":["../../../../../src/adapters/defaults/state/file-state-adapter.ts"],"sourcesContent":["import fs from 'fs'\nimport * as path from 'path'\nimport type { StateAdapter, StateItem, StateItemsInput } from '../../interfaces/state-adapter.interface'\nimport { filterItem, inferType } from './utils'\n\nexport type FileAdapterConfig = {\n  adapter: 'default'\n  filePath: string\n}\n\nexport class FileStateAdapter implements StateAdapter {\n  private readonly filePath: string\n\n  constructor(config: FileAdapterConfig) {\n    this.filePath = path.join(config.filePath, 'motia.state.json')\n    this.init()\n  }\n\n  init() {\n    const dir = this.filePath.replace('motia.state.json', '')\n    try {\n      fs.realpathSync(dir)\n    } catch {\n      fs.mkdirSync(dir, { recursive: true })\n    }\n\n    try {\n      fs.readFileSync(this.filePath, 'utf-8')\n    } catch {\n      fs.writeFileSync(this.filePath, JSON.stringify({}), 'utf-8')\n    }\n  }\n\n  async getGroup<T>(groupId: string): Promise<T[]> {\n    const data = this._readFile()\n\n    return Object.entries(data)\n      .filter(([key]) => key.startsWith(groupId))\n      .map(([, value]) => JSON.parse(value) as T)\n  }\n\n  async get<T>(traceId: string, key: string): Promise<T | null> {\n    const data = this._readFile()\n    const fullKey = this._makeKey(traceId, key)\n\n    return data[fullKey] ? (JSON.parse(data[fullKey]) as T) : null\n  }\n\n  async set<T>(traceId: string, key: string, value: T) {\n    const data = this._readFile()\n    const fullKey = this._makeKey(traceId, key)\n\n    data[fullKey] = JSON.stringify(value)\n\n    this._writeFile(data)\n\n    return value\n  }\n\n  async delete<T>(traceId: string, key: string): Promise<T | null> {\n    const data = this._readFile()\n    const fullKey = this._makeKey(traceId, key)\n    const value = await this.get<T>(traceId, key)\n\n    if (value) {\n      delete data[fullKey]\n      this._writeFile(data)\n    }\n\n    return value\n  }\n\n  async clear(traceId: string) {\n    const data = this._readFile()\n    const pattern = this._makeKey(traceId, '')\n\n    for (const key in data) {\n      if (key.startsWith(pattern)) {\n        delete data[key]\n      }\n    }\n\n    this._writeFile(data)\n  }\n\n  async keys(traceId: string) {\n    const data = this._readFile()\n    return Object.keys(data)\n      .filter((key) => key.startsWith(this._makeKey(traceId, '')))\n      .map((key) => key.replace(this._makeKey(traceId, ''), ''))\n  }\n\n  async traceIds() {\n    const data = this._readFile()\n    const traceIds = new Set<string>()\n\n    Object.keys(data).forEach((key) => traceIds.add(key.split(':')[0]))\n\n    return Array.from(traceIds)\n  }\n\n  async cleanup() {}\n\n  async items(input: StateItemsInput): Promise<StateItem[]> {\n    const data = this._readFile()\n\n    return Object.entries(data)\n      .map(([key, value]) => {\n        const [groupId, ...keyParts] = key.split(':')\n        const itemKey = keyParts.join(':')\n        const itemValue = JSON.parse(value)\n        return { groupId, key: itemKey, value: itemValue, type: inferType(itemValue) }\n      })\n      .filter((item) => (input.groupId ? item.groupId === input.groupId : true))\n      .filter((item) => (input.filter ? filterItem(item, input.filter) : true))\n  }\n\n  private _makeKey(traceId: string, key: string) {\n    return `${traceId}:${key}`\n  }\n\n  private _readFile(): Record<string, string> {\n    try {\n      const content = fs.readFileSync(this.filePath, 'utf-8')\n      return JSON.parse(content)\n    } catch (error) {\n      this.init()\n      return {}\n    }\n  }\n\n  private _writeFile(data: unknown) {\n    try {\n      fs.writeFileSync(this.filePath, JSON.stringify(data, null, 2), 'utf-8')\n    } catch (error) {\n      this.init()\n      fs.writeFileSync(this.filePath, JSON.stringify(data, null, 2), 'utf-8')\n    }\n  }\n}\n"],"mappings":"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"}