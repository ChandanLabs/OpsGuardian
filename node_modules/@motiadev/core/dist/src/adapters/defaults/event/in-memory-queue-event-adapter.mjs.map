{"version":3,"file":"in-memory-queue-event-adapter.mjs","names":["uuidv4","handle: SubscriptionHandle"],"sources":["../../../../../src/adapters/defaults/event/in-memory-queue-event-adapter.ts"],"sourcesContent":["import { v4 as uuidv4 } from 'uuid'\nimport { DEFAULT_QUEUE_CONFIG } from '../../../infrastructure-validator/defaults'\nimport { QueueManager, type QueueMetrics } from '../../../queue-manager'\nimport type { Event, QueueConfig } from '../../../types'\nimport type { EventAdapter, SubscriptionHandle } from '../../interfaces/event-adapter.interface'\n\nexport class InMemoryQueueEventAdapter implements EventAdapter {\n  private queueManager: QueueManager = new QueueManager()\n  private subscriptions: Map<string, { topic: string; handler: (event: Event<any>) => void | Promise<void> }> =\n    new Map()\n\n  async emit<TData>(event: Event<TData>): Promise<void> {\n    await this.queueManager.enqueue(event.topic, event, event.messageGroupId)\n  }\n\n  async subscribe<TData>(\n    topic: string,\n    stepName: string,\n    handler: (event: Event<TData>) => void | Promise<void>,\n    queueConfig?: QueueConfig,\n  ): Promise<SubscriptionHandle> {\n    const id = uuidv4()\n\n    this.subscriptions.set(id, { topic, handler: handler as (event: Event<any>) => void | Promise<void> })\n\n    const config = queueConfig || DEFAULT_QUEUE_CONFIG\n    this.queueManager.subscribe(topic, handler as any, config, id)\n\n    const handle: SubscriptionHandle = {\n      topic,\n      id,\n      unsubscribe: async () => {\n        await this.unsubscribe(handle)\n      },\n    }\n\n    return handle\n  }\n\n  async unsubscribe(handle: SubscriptionHandle): Promise<void> {\n    const subscription = this.subscriptions.get(handle.id)\n    if (subscription) {\n      this.queueManager.unsubscribe(handle.topic, subscription.handler as any)\n      this.subscriptions.delete(handle.id)\n    }\n  }\n\n  async shutdown(): Promise<void> {\n    this.subscriptions.clear()\n  }\n\n  async getSubscriptionCount(topic: string): Promise<number> {\n    return Array.from(this.subscriptions.values()).filter((sub) => sub.topic === topic).length\n  }\n\n  async listTopics(): Promise<string[]> {\n    return Array.from(new Set(Array.from(this.subscriptions.values()).map((sub) => sub.topic)))\n  }\n\n  getAllMetrics(): Record<string, QueueMetrics> {\n    return this.queueManager.getAllMetrics()\n  }\n}\n"],"mappings":";;;;;AAMA,IAAa,4BAAb,MAA+D;;sBACxB,IAAI,cAAc;uCAErD,IAAI,KAAK;;CAEX,MAAM,KAAY,OAAoC;AACpD,QAAM,KAAK,aAAa,QAAQ,MAAM,OAAO,OAAO,MAAM,eAAe;;CAG3E,MAAM,UACJ,OACA,UACA,SACA,aAC6B;EAC7B,MAAM,KAAKA,IAAQ;AAEnB,OAAK,cAAc,IAAI,IAAI;GAAE;GAAgB;GAAwD,CAAC;EAEtG,MAAM,SAAS,eAAe;AAC9B,OAAK,aAAa,UAAU,OAAO,SAAgB,QAAQ,GAAG;EAE9D,MAAMC,SAA6B;GACjC;GACA;GACA,aAAa,YAAY;AACvB,UAAM,KAAK,YAAY,OAAO;;GAEjC;AAED,SAAO;;CAGT,MAAM,YAAY,QAA2C;EAC3D,MAAM,eAAe,KAAK,cAAc,IAAI,OAAO,GAAG;AACtD,MAAI,cAAc;AAChB,QAAK,aAAa,YAAY,OAAO,OAAO,aAAa,QAAe;AACxE,QAAK,cAAc,OAAO,OAAO,GAAG;;;CAIxC,MAAM,WAA0B;AAC9B,OAAK,cAAc,OAAO;;CAG5B,MAAM,qBAAqB,OAAgC;AACzD,SAAO,MAAM,KAAK,KAAK,cAAc,QAAQ,CAAC,CAAC,QAAQ,QAAQ,IAAI,UAAU,MAAM,CAAC;;CAGtF,MAAM,aAAgC;AACpC,SAAO,MAAM,KAAK,IAAI,IAAI,MAAM,KAAK,KAAK,cAAc,QAAQ,CAAC,CAAC,KAAK,QAAQ,IAAI,MAAM,CAAC,CAAC;;CAG7F,gBAA8C;AAC5C,SAAO,KAAK,aAAa,eAAe"}