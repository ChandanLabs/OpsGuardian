{"version":3,"file":"file-stream-adapter.mjs","names":["path"],"sources":["../../../../../src/adapters/defaults/stream/file-stream-adapter.ts"],"sourcesContent":["import fs from 'fs'\nimport * as path from 'path'\nimport type { BaseStreamItem } from '../../../types-stream'\nimport { StreamAdapter } from '../../interfaces/stream-adapter.interface'\n\nexport type FileAdapterConfig = {\n  filePath: string\n}\n\nexport class FileStreamAdapter<TData> extends StreamAdapter<TData> {\n  private readonly filePath: string\n  private readonly streamsDir: string\n\n  constructor(filePath: string, streamName: string, motiaFileStoragePath: string = '.motia') {\n    super(streamName)\n    this.streamsDir = path.join(filePath, motiaFileStoragePath, 'streams')\n    this.filePath = path.join(this.streamsDir, `${streamName}.stream.json`)\n  }\n\n  init() {\n    try {\n      fs.realpathSync(this.streamsDir)\n    } catch {\n      fs.mkdirSync(this.streamsDir, { recursive: true })\n    }\n\n    try {\n      fs.readFileSync(this.filePath, 'utf-8')\n    } catch {\n      fs.writeFileSync(this.filePath, JSON.stringify({}), 'utf-8')\n    }\n  }\n\n  async getGroup(groupId: string): Promise<BaseStreamItem<TData>[]> {\n    const data = this._readFile()\n    const prefix = this._makeKey(groupId, '')\n\n    return Object.entries(data)\n      .filter(([key]) => key.startsWith(prefix))\n      .map(([, value]) => JSON.parse(value) as BaseStreamItem<TData>)\n  }\n\n  async get(groupId: string, key: string): Promise<BaseStreamItem<TData> | null> {\n    const data = this._readFile()\n    const fullKey = this._makeKey(groupId, key)\n\n    return data[fullKey] ? (JSON.parse(data[fullKey]) as BaseStreamItem<TData>) : null\n  }\n\n  async set(groupId: string, id: string, value: TData) {\n    const data = this._readFile()\n    const key = this._makeKey(groupId, id)\n\n    data[key] = JSON.stringify(value)\n\n    this._writeFile(data)\n\n    return { ...value, id }\n  }\n\n  async delete(groupId: string, id: string): Promise<BaseStreamItem<TData> | null> {\n    const data = this._readFile()\n    const key = this._makeKey(groupId, id)\n    const value = await this.get(groupId, id)\n\n    if (value) {\n      delete data[key]\n      this._writeFile(data)\n    }\n\n    return value\n  }\n\n  async clear(groupId: string) {\n    const data = this._readFile()\n    const pattern = this._makeKey(groupId, '')\n\n    for (const key in data) {\n      if (key.startsWith(pattern)) {\n        delete data[key]\n      }\n    }\n\n    this._writeFile(data)\n  }\n\n  protected _makeKey(groupId: string, id: string) {\n    return `${groupId}:${id}`\n  }\n\n  protected _readFile(): Record<string, string> {\n    try {\n      const content = fs.readFileSync(this.filePath, 'utf-8')\n      return JSON.parse(content)\n    } catch (error) {\n      this.init()\n      return {}\n    }\n  }\n\n  protected _writeFile(data: unknown) {\n    try {\n      fs.writeFileSync(this.filePath, JSON.stringify(data, null, 2), 'utf-8')\n    } catch (error) {\n      this.init()\n      fs.writeFileSync(this.filePath, JSON.stringify(data, null, 2), 'utf-8')\n    }\n  }\n}\n"],"mappings":";;;;;AASA,IAAa,oBAAb,cAA8C,cAAqB;CAIjE,YAAY,UAAkB,YAAoB,uBAA+B,UAAU;AACzF,QAAM,WAAW;AACjB,OAAK,aAAaA,OAAK,KAAK,UAAU,sBAAsB,UAAU;AACtE,OAAK,WAAWA,OAAK,KAAK,KAAK,YAAY,GAAG,WAAW,cAAc;;CAGzE,OAAO;AACL,MAAI;AACF,MAAG,aAAa,KAAK,WAAW;UAC1B;AACN,MAAG,UAAU,KAAK,YAAY,EAAE,WAAW,MAAM,CAAC;;AAGpD,MAAI;AACF,MAAG,aAAa,KAAK,UAAU,QAAQ;UACjC;AACN,MAAG,cAAc,KAAK,UAAU,KAAK,UAAU,EAAE,CAAC,EAAE,QAAQ;;;CAIhE,MAAM,SAAS,SAAmD;EAChE,MAAM,OAAO,KAAK,WAAW;EAC7B,MAAM,SAAS,KAAK,SAAS,SAAS,GAAG;AAEzC,SAAO,OAAO,QAAQ,KAAK,CACxB,QAAQ,CAAC,SAAS,IAAI,WAAW,OAAO,CAAC,CACzC,KAAK,GAAG,WAAW,KAAK,MAAM,MAAM,CAA0B;;CAGnE,MAAM,IAAI,SAAiB,KAAoD;EAC7E,MAAM,OAAO,KAAK,WAAW;EAC7B,MAAM,UAAU,KAAK,SAAS,SAAS,IAAI;AAE3C,SAAO,KAAK,WAAY,KAAK,MAAM,KAAK,SAAS,GAA6B;;CAGhF,MAAM,IAAI,SAAiB,IAAY,OAAc;EACnD,MAAM,OAAO,KAAK,WAAW;EAC7B,MAAM,MAAM,KAAK,SAAS,SAAS,GAAG;AAEtC,OAAK,OAAO,KAAK,UAAU,MAAM;AAEjC,OAAK,WAAW,KAAK;AAErB,SAAO;GAAE,GAAG;GAAO;GAAI;;CAGzB,MAAM,OAAO,SAAiB,IAAmD;EAC/E,MAAM,OAAO,KAAK,WAAW;EAC7B,MAAM,MAAM,KAAK,SAAS,SAAS,GAAG;EACtC,MAAM,QAAQ,MAAM,KAAK,IAAI,SAAS,GAAG;AAEzC,MAAI,OAAO;AACT,UAAO,KAAK;AACZ,QAAK,WAAW,KAAK;;AAGvB,SAAO;;CAGT,MAAM,MAAM,SAAiB;EAC3B,MAAM,OAAO,KAAK,WAAW;EAC7B,MAAM,UAAU,KAAK,SAAS,SAAS,GAAG;AAE1C,OAAK,MAAM,OAAO,KAChB,KAAI,IAAI,WAAW,QAAQ,CACzB,QAAO,KAAK;AAIhB,OAAK,WAAW,KAAK;;CAGvB,AAAU,SAAS,SAAiB,IAAY;AAC9C,SAAO,GAAG,QAAQ,GAAG;;CAGvB,AAAU,YAAoC;AAC5C,MAAI;GACF,MAAM,UAAU,GAAG,aAAa,KAAK,UAAU,QAAQ;AACvD,UAAO,KAAK,MAAM,QAAQ;WACnB,OAAO;AACd,QAAK,MAAM;AACX,UAAO,EAAE;;;CAIb,AAAU,WAAW,MAAe;AAClC,MAAI;AACF,MAAG,cAAc,KAAK,UAAU,KAAK,UAAU,MAAM,MAAM,EAAE,EAAE,QAAQ;WAChE,OAAO;AACd,QAAK,MAAM;AACX,MAAG,cAAc,KAAK,UAAU,KAAK,UAAU,MAAM,MAAM,EAAE,EAAE,QAAQ"}