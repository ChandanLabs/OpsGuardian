{"version":3,"file":"run-stream-can-access.mjs","names":["result: boolean | null"],"sources":["../../src/run-stream-can-access.ts"],"sourcesContent":["import { getLanguageBasedRunner } from './language-runner'\nimport { globalLogger } from './logger'\nimport { ProcessManager } from './process-communication/process-manager'\nimport type { StreamSubscription } from './types-stream'\n\ntype RunStreamCanAccessOptions = {\n  file: string\n  subscription: StreamSubscription\n  authContext?: unknown\n  projectRoot?: string\n}\n\nexport const runStreamCanAccess = async ({\n  file,\n  subscription,\n  authContext,\n  projectRoot,\n}: RunStreamCanAccessOptions): Promise<boolean> => {\n  const { runner, command, args } = getLanguageBasedRunner(file, {\n    python: 'can-access.py',\n    ruby: 'can-access.rb',\n    node: { js: 'can-access.mjs', ts: 'can-access.ts' },\n  })\n\n  const payload = JSON.stringify({ subscription, authContext })\n\n  return new Promise((resolve, reject) => {\n    let result: boolean | null = null\n\n    const processManager = new ProcessManager({\n      command,\n      args: [...args, runner, file, payload],\n      logger: globalLogger,\n      context: 'StreamCanAccess',\n      projectRoot,\n    })\n\n    processManager\n      .spawn()\n      .then(() => {\n        processManager.onMessage<boolean>((message) => {\n          result = Boolean(message)\n          resolve(result)\n          processManager.kill()\n        })\n\n        processManager.onProcessClose((code) => {\n          processManager.close()\n\n          if (result !== null) {\n            return\n          }\n\n          if (code !== 0) {\n            reject(`Process exited with code ${code}`)\n          } else {\n            reject('Stream canAccess evaluation returned no result')\n          }\n        })\n\n        processManager.onProcessError((error) => {\n          processManager.close()\n          if (error.code === 'ENOENT') {\n            reject(`Executable ${command} not found`)\n          } else {\n            reject(error)\n          }\n        })\n      })\n      .catch((error) => {\n        processManager.close()\n        reject(`Failed to spawn process: ${error}`)\n      })\n  })\n}\n"],"mappings":";;;;;AAYA,MAAa,qBAAqB,OAAO,EACvC,MACA,cACA,aACA,kBACiD;CACjD,MAAM,EAAE,QAAQ,SAAS,SAAS,uBAAuB,MAAM;EAC7D,QAAQ;EACR,MAAM;EACN,MAAM;GAAE,IAAI;GAAkB,IAAI;GAAiB;EACpD,CAAC;CAEF,MAAM,UAAU,KAAK,UAAU;EAAE;EAAc;EAAa,CAAC;AAE7D,QAAO,IAAI,SAAS,SAAS,WAAW;EACtC,IAAIA,SAAyB;EAE7B,MAAM,iBAAiB,IAAI,eAAe;GACxC;GACA,MAAM;IAAC,GAAG;IAAM;IAAQ;IAAM;IAAQ;GACtC,QAAQ;GACR,SAAS;GACT;GACD,CAAC;AAEF,iBACG,OAAO,CACP,WAAW;AACV,kBAAe,WAAoB,YAAY;AAC7C,aAAS,QAAQ,QAAQ;AACzB,YAAQ,OAAO;AACf,mBAAe,MAAM;KACrB;AAEF,kBAAe,gBAAgB,SAAS;AACtC,mBAAe,OAAO;AAEtB,QAAI,WAAW,KACb;AAGF,QAAI,SAAS,EACX,QAAO,4BAA4B,OAAO;QAE1C,QAAO,iDAAiD;KAE1D;AAEF,kBAAe,gBAAgB,UAAU;AACvC,mBAAe,OAAO;AACtB,QAAI,MAAM,SAAS,SACjB,QAAO,cAAc,QAAQ,YAAY;QAEzC,QAAO,MAAM;KAEf;IACF,CACD,OAAO,UAAU;AAChB,kBAAe,OAAO;AACtB,UAAO,4BAA4B,QAAQ;IAC3C;GACJ"}