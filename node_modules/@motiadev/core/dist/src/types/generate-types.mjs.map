{"version":3,"file":"generate-types.mjs","names":["handlers: HandlersMap","topics: Record<string, string>","topicsSchemas: Record<string, JsonSchema>","topicsSteps: Record<string, Step[]>","topicIsFifo: Record<string, boolean>","emit"],"sources":["../../../src/types/generate-types.ts"],"sourcesContent":["import { isApiStep, isCronStep, isEventStep } from '../guards'\nimport type { Printer } from '../printer'\nimport { schemaToJsonSchema } from '../schema-utils'\nimport type { Emit, Step } from '../types'\nimport type { Stream } from '../types-stream'\nimport { generateTypeFromSchema } from './generate-type-from-schema'\nimport { generateTypesFromResponse } from './generate-types-from-response'\nimport { mergeSchemas } from './merge-schemas'\nimport type { JsonSchema } from './schema.types'\n\ntype HandlersMap = Record<string, { type: string; generics: string[] }>\ntype StreamsMap = Record<string, string>\n\nexport const generateTypesString = (\n  handlers: HandlersMap,\n  streams: StreamsMap,\n  streamAuthContextType?: string,\n): string => {\n  return `/**\n * Automatically generated types for motia\n * Do NOT edit this file manually.\n * \n * Consider adding this file to .prettierignore and eslint ignore.\n */\nimport { EventHandler, ApiRouteHandler, ApiResponse, MotiaStream, CronHandler } from 'motia'\n\ndeclare module 'motia' {\n  interface FlowContextStateStreams {\n    ${Object.entries(streams)\n      .map(([key, value]) => `'${key}': MotiaStream<${value}>`)\n      .join('\\n    ')\n      .trim()}\n  }\n\n  interface Handlers {\n    ${Object.entries(handlers)\n      .map(([key, { type, generics }]) => `'${key}': ${type}<${generics.join(', ')}>`)\n      .join('\\n    ')\n      .trim()}\n  }\n    ${streamAuthContextType ? `interface StreamAuthContext ${streamAuthContextType}` : ''}\n}`\n}\n\nexport const generateTypesFromSteps = (steps: Step[], printer: Printer): HandlersMap => {\n  const handlers: HandlersMap = {}\n  const topics: Record<string, string> = {}\n  const topicsSchemas: Record<string, JsonSchema> = {}\n  const topicsSteps: Record<string, Step[]> = {}\n  const topicIsFifo: Record<string, boolean> = {}\n\n  for (const step of steps) {\n    if (isEventStep(step)) {\n      if (!step.config.input) {\n        for (const topic of step.config.subscribes) {\n          if (!topics[topic]) {\n            topics[topic] = 'never'\n          }\n        }\n        continue\n      }\n\n      for (const topic of step.config.subscribes) {\n        const existingSchema = topicsSchemas[topic]\n\n        topicsSteps[topic] = topicsSteps[topic] ?? []\n        topicsSteps[topic].push(step)\n\n        const queueType = step.config.infrastructure?.queue?.type\n        if (queueType === 'fifo') {\n          topicIsFifo[topic] = true\n        }\n\n        try {\n          const input = step.config.input\n          const schema = existingSchema\n            ? mergeSchemas(existingSchema, input)\n            : (schemaToJsonSchema(input) ?? (input as JsonSchema))\n          topics[topic] = generateTypeFromSchema(schema)\n          topicsSchemas[topic] = schema\n        } catch (error) {\n          printer.printInvalidSchema(topic, topicsSteps[topic])\n          topics[topic] = 'never'\n        }\n      }\n    }\n  }\n\n  const generateEmitData = (emit: Emit[], step: Step): string => {\n    const emits = emit\n      .reduce((acc, emit) => {\n        const topic = typeof emit === 'string' ? emit : emit.topic\n        const topicType = topics[topic]\n\n        if (topicType) {\n          const isFifo = topicIsFifo[topic]\n          if (isFifo) {\n            acc.push(`{ topic: '${topic.replace(/'/g, \"\\\\'\")}'; data: ${topicType}; messageGroupId: string }`)\n          } else {\n            acc.push(`{ topic: '${topic.replace(/'/g, \"\\\\'\")}'; data: ${topicType} }`)\n          }\n        } else {\n          printer.printInvalidEmitConfiguration(step, topic)\n        }\n\n        return acc\n      }, [] as string[])\n      .join(' | ')\n\n    return emits.length === 0 ? 'never' : emits\n  }\n\n  for (const step of steps) {\n    const emits = 'emits' in step.config ? generateEmitData(step.config.emits, step) : 'never'\n\n    if (isEventStep(step)) {\n      const input = step.config.input ? generateTypeFromSchema(step.config.input as never as JsonSchema) : 'never'\n      handlers[step.config.name] = { type: 'EventHandler', generics: [input, emits] }\n    } else if (isApiStep(step)) {\n      const input = step.config.bodySchema\n        ? generateTypeFromSchema(step.config.bodySchema as never as JsonSchema)\n        : 'Record<string, unknown>'\n      const result = step.config.responseSchema\n        ? generateTypesFromResponse(step.config.responseSchema as never as Record<number, JsonSchema>)\n        : 'unknown'\n      handlers[step.config.name] = { type: 'ApiRouteHandler', generics: [input, result, emits] }\n    } else if (isCronStep(step)) {\n      handlers[step.config.name] = { type: 'CronHandler', generics: [emits] }\n    }\n  }\n\n  return handlers\n}\n\nexport const generateTypesFromStreams = (streams: Record<string, Stream>): StreamsMap => {\n  return Object.entries(streams).reduce((acc, [key, stream]) => {\n    if (!stream.hidden) {\n      acc[key] = generateTypeFromSchema(stream.config.schema as unknown as JsonSchema)\n    }\n    return acc\n  }, {} as StreamsMap)\n}\n"],"mappings":"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"}