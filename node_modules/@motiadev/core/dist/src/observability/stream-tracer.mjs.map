{"version":3,"file":"stream-tracer.mjs","names":["manager: TraceManager","traceGroup: TraceGroup","trace: Trace"],"sources":["../../../src/observability/stream-tracer.ts"],"sourcesContent":["import type { Logger } from '../logger'\nimport type { Step } from '../types'\nimport { createTrace } from './create-trace'\nimport type { Tracer } from './index'\nimport type { TraceManager } from './trace-manager'\nimport type { StateOperation, StreamOperation, Trace, TraceError, TraceEvent, TraceGroup } from './types'\n\nexport class StreamTracer implements Tracer {\n  constructor(\n    private readonly manager: TraceManager,\n    private readonly traceGroup: TraceGroup,\n    private readonly trace: Trace,\n    logger: Logger,\n  ) {\n    logger.addListener(async (level, msg, args) => {\n      await this.addEvent({\n        type: 'log',\n        timestamp: Date.now(),\n        level,\n        message: msg,\n        metadata: args,\n      })\n    })\n  }\n\n  async end(err?: TraceError) {\n    if (this.trace.endTime) {\n      return\n    }\n\n    this.trace.status = err ? 'failed' : 'completed'\n    this.trace.endTime = Date.now()\n    this.trace.error = err\n\n    await this.manager.updateTrace()\n  }\n\n  async stateOperation(operation: StateOperation, input: unknown) {\n    await this.addEvent({\n      type: 'state',\n      timestamp: Date.now(),\n      operation,\n      data: input,\n    })\n  }\n\n  async emitOperation(topic: string, data: unknown, success: boolean) {\n    await this.addEvent({\n      type: 'emit',\n      timestamp: Date.now(),\n      topic,\n      success,\n      data,\n    })\n  }\n\n  async streamOperation(\n    streamName: string,\n    operation: StreamOperation,\n    input: { groupId: string; id: string; data?: unknown },\n  ) {\n    if (operation === 'set') {\n      const lastEvent = this.trace.events[this.trace.events.length - 1]\n\n      if (\n        lastEvent &&\n        lastEvent.type === 'stream' &&\n        lastEvent.streamName === streamName &&\n        lastEvent.data.groupId === input.groupId &&\n        lastEvent.data.id === input.id\n      ) {\n        lastEvent.calls++\n        lastEvent.data.data = input.data\n        lastEvent.maxTimestamp = Date.now()\n\n        await this.manager.updateTrace()\n\n        return\n      }\n    }\n\n    await this.addEvent({\n      type: 'stream',\n      timestamp: Date.now(),\n      operation,\n      data: input,\n      streamName,\n      calls: 1,\n    })\n  }\n\n  child(step: Step, logger: Logger) {\n    const trace = createTrace(this.traceGroup, step)\n    const manager = this.manager.child(trace)\n\n    return new StreamTracer(manager, this.traceGroup, trace, logger)\n  }\n\n  private async addEvent(event: TraceEvent) {\n    this.trace.events.push(event)\n\n    await this.manager.updateTrace()\n  }\n}\n"],"mappings":";;;AAOA,IAAa,eAAb,MAAa,aAA+B;CAC1C,YACE,AAAiBA,SACjB,AAAiBC,YACjB,AAAiBC,OACjB,QACA;EAJiB;EACA;EACA;AAGjB,SAAO,YAAY,OAAO,OAAO,KAAK,SAAS;AAC7C,SAAM,KAAK,SAAS;IAClB,MAAM;IACN,WAAW,KAAK,KAAK;IACrB;IACA,SAAS;IACT,UAAU;IACX,CAAC;IACF;;CAGJ,MAAM,IAAI,KAAkB;AAC1B,MAAI,KAAK,MAAM,QACb;AAGF,OAAK,MAAM,SAAS,MAAM,WAAW;AACrC,OAAK,MAAM,UAAU,KAAK,KAAK;AAC/B,OAAK,MAAM,QAAQ;AAEnB,QAAM,KAAK,QAAQ,aAAa;;CAGlC,MAAM,eAAe,WAA2B,OAAgB;AAC9D,QAAM,KAAK,SAAS;GAClB,MAAM;GACN,WAAW,KAAK,KAAK;GACrB;GACA,MAAM;GACP,CAAC;;CAGJ,MAAM,cAAc,OAAe,MAAe,SAAkB;AAClE,QAAM,KAAK,SAAS;GAClB,MAAM;GACN,WAAW,KAAK,KAAK;GACrB;GACA;GACA;GACD,CAAC;;CAGJ,MAAM,gBACJ,YACA,WACA,OACA;AACA,MAAI,cAAc,OAAO;GACvB,MAAM,YAAY,KAAK,MAAM,OAAO,KAAK,MAAM,OAAO,SAAS;AAE/D,OACE,aACA,UAAU,SAAS,YACnB,UAAU,eAAe,cACzB,UAAU,KAAK,YAAY,MAAM,WACjC,UAAU,KAAK,OAAO,MAAM,IAC5B;AACA,cAAU;AACV,cAAU,KAAK,OAAO,MAAM;AAC5B,cAAU,eAAe,KAAK,KAAK;AAEnC,UAAM,KAAK,QAAQ,aAAa;AAEhC;;;AAIJ,QAAM,KAAK,SAAS;GAClB,MAAM;GACN,WAAW,KAAK,KAAK;GACrB;GACA,MAAM;GACN;GACA,OAAO;GACR,CAAC;;CAGJ,MAAM,MAAY,QAAgB;EAChC,MAAM,QAAQ,YAAY,KAAK,YAAY,KAAK;AAGhD,SAAO,IAAI,aAFK,KAAK,QAAQ,MAAM,MAAM,EAER,KAAK,YAAY,OAAO,OAAO;;CAGlE,MAAc,SAAS,OAAmB;AACxC,OAAK,MAAM,OAAO,KAAK,MAAM;AAE7B,QAAM,KAAK,QAAQ,aAAa"}