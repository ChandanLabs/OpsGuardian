{"version":3,"file":"tracer.mjs","names":["traceStream: MotiaStream<Trace>","traceGroupStream: MotiaStream<TraceGroup>","traceGroup: TraceGroup","traceStreamAdapter: MotiaStream<Trace>","traceGroupStreamAdapter: MotiaStream<TraceGroup>"],"sources":["../../../src/observability/tracer.ts"],"sourcesContent":["import type { LockedData } from '../locked-data'\nimport type { Logger } from '../logger'\nimport type { Step } from '../types'\nimport type { MotiaStream } from '../types-stream'\nimport { createTrace } from './create-trace'\nimport type { TracerFactory } from './index'\nimport { RedisTraceStreamAdapter } from './redis-trace-stream-adapter'\nimport { StreamTracer } from './stream-tracer'\nimport { TraceManager } from './trace-manager'\nimport type { Trace, TraceGroup } from './types'\n\nexport class BaseTracerFactory implements TracerFactory {\n  constructor(\n    private readonly traceStream: MotiaStream<Trace>,\n    private readonly traceGroupStream: MotiaStream<TraceGroup>,\n  ) {}\n\n  private async getAllGroups() {\n    return await this.traceGroupStream.getGroup('default')\n  }\n\n  private async deleteGroup(group: TraceGroup) {\n    const traces = await this.traceStream.getGroup(group.id)\n\n    for (const trace of traces) {\n      await this.traceStream.delete(group.id, trace.id)\n    }\n    await this.traceGroupStream.delete('default', group.id)\n  }\n\n  async clear() {\n    const groups = await this.getAllGroups()\n\n    for (const group of groups) {\n      await this.deleteGroup(group)\n    }\n  }\n\n  async createTracer(traceId: string, step: Step, logger: Logger) {\n    const traceGroup: TraceGroup = {\n      id: traceId,\n      name: step.config.name,\n      startTime: Date.now(),\n    }\n\n    const trace = createTrace(traceGroup, step)\n    const manager = new TraceManager(this.traceStream, this.traceGroupStream, traceGroup, trace)\n\n    await manager.updateTraceGroup()\n\n    return new StreamTracer(manager, traceGroup, trace, logger)\n  }\n\n  async attachToTrace(traceId: string, step: Step, logger: Logger) {\n    const existingGroup = await this.traceGroupStream.get('default', traceId)\n\n    if (!existingGroup) {\n      return this.createTracer(traceId, step, logger)\n    }\n\n    const trace = createTrace(existingGroup, step)\n    const manager = new TraceManager(this.traceStream, this.traceGroupStream, existingGroup, trace)\n\n    return new StreamTracer(manager, existingGroup, trace, logger)\n  }\n}\n\nexport const createTracerFactory = (lockedData: LockedData): TracerFactory => {\n  if (!lockedData.redisClient) {\n    throw new Error(\n      'Redis client is required for tracer factory. Please provide a redisClient when creating LockedData.',\n    )\n  }\n\n  const traceStreamName = 'motia-trace'\n  const traceStreamAdapter: MotiaStream<Trace> = new RedisTraceStreamAdapter(traceStreamName, lockedData.redisClient)\n\n  const traceStream = lockedData.createStream<Trace>({\n    filePath: traceStreamName,\n    hidden: true,\n    config: {\n      name: traceStreamName,\n      baseConfig: { storageType: 'custom', factory: () => traceStreamAdapter },\n      schema: null as never,\n    },\n  })()\n\n  const traceGroupName = 'motia-trace-group'\n  const traceGroupStreamAdapter: MotiaStream<TraceGroup> = new RedisTraceStreamAdapter(\n    traceGroupName,\n    lockedData.redisClient,\n  )\n\n  const traceGroupStream = lockedData.createStream<TraceGroup>({\n    filePath: traceGroupName,\n    hidden: true,\n    config: {\n      name: traceGroupName,\n      baseConfig: { storageType: 'custom', factory: () => traceGroupStreamAdapter },\n      schema: null as never,\n    },\n  })()\n\n  return new BaseTracerFactory(traceStream, traceGroupStream)\n}\n"],"mappings":";;;;;;AAWA,IAAa,oBAAb,MAAwD;CACtD,YACE,AAAiBA,aACjB,AAAiBC,kBACjB;EAFiB;EACA;;CAGnB,MAAc,eAAe;AAC3B,SAAO,MAAM,KAAK,iBAAiB,SAAS,UAAU;;CAGxD,MAAc,YAAY,OAAmB;EAC3C,MAAM,SAAS,MAAM,KAAK,YAAY,SAAS,MAAM,GAAG;AAExD,OAAK,MAAM,SAAS,OAClB,OAAM,KAAK,YAAY,OAAO,MAAM,IAAI,MAAM,GAAG;AAEnD,QAAM,KAAK,iBAAiB,OAAO,WAAW,MAAM,GAAG;;CAGzD,MAAM,QAAQ;EACZ,MAAM,SAAS,MAAM,KAAK,cAAc;AAExC,OAAK,MAAM,SAAS,OAClB,OAAM,KAAK,YAAY,MAAM;;CAIjC,MAAM,aAAa,SAAiB,MAAY,QAAgB;EAC9D,MAAMC,aAAyB;GAC7B,IAAI;GACJ,MAAM,KAAK,OAAO;GAClB,WAAW,KAAK,KAAK;GACtB;EAED,MAAM,QAAQ,YAAY,YAAY,KAAK;EAC3C,MAAM,UAAU,IAAI,aAAa,KAAK,aAAa,KAAK,kBAAkB,YAAY,MAAM;AAE5F,QAAM,QAAQ,kBAAkB;AAEhC,SAAO,IAAI,aAAa,SAAS,YAAY,OAAO,OAAO;;CAG7D,MAAM,cAAc,SAAiB,MAAY,QAAgB;EAC/D,MAAM,gBAAgB,MAAM,KAAK,iBAAiB,IAAI,WAAW,QAAQ;AAEzE,MAAI,CAAC,cACH,QAAO,KAAK,aAAa,SAAS,MAAM,OAAO;EAGjD,MAAM,QAAQ,YAAY,eAAe,KAAK;AAG9C,SAAO,IAAI,aAFK,IAAI,aAAa,KAAK,aAAa,KAAK,kBAAkB,eAAe,MAAM,EAE9D,eAAe,OAAO,OAAO;;;AAIlE,MAAa,uBAAuB,eAA0C;AAC5E,KAAI,CAAC,WAAW,YACd,OAAM,IAAI,MACR,sGACD;CAGH,MAAM,kBAAkB;CACxB,MAAMC,qBAAyC,IAAI,wBAAwB,iBAAiB,WAAW,YAAY;CAEnH,MAAM,cAAc,WAAW,aAAoB;EACjD,UAAU;EACV,QAAQ;EACR,QAAQ;GACN,MAAM;GACN,YAAY;IAAE,aAAa;IAAU,eAAe;IAAoB;GACxE,QAAQ;GACT;EACF,CAAC,EAAE;CAEJ,MAAM,iBAAiB;CACvB,MAAMC,0BAAmD,IAAI,wBAC3D,gBACA,WAAW,YACZ;AAYD,QAAO,IAAI,kBAAkB,aAVJ,WAAW,aAAyB;EAC3D,UAAU;EACV,QAAQ;EACR,QAAQ;GACN,MAAM;GACN,YAAY;IAAE,aAAa;IAAU,eAAe;IAAyB;GAC7E,QAAQ;GACT;EACF,CAAC,EAAE,CAEuD"}