{"version":3,"file":"redis-trace-stream-adapter.mjs","names":["item: BaseStreamItem<TData>"],"sources":["../../../src/observability/redis-trace-stream-adapter.ts"],"sourcesContent":["import type { RedisClientType } from 'redis'\nimport { StreamAdapter } from '../adapters/interfaces/stream-adapter.interface'\nimport type { BaseStreamItem, StateStreamEvent, StateStreamEventChannel } from '../types-stream'\n\nconst TRACE_TTL_SECONDS = 3 * 24 * 60 * 60\n\nexport class RedisTraceStreamAdapter<TData> extends StreamAdapter<TData> {\n  private client: RedisClientType\n  private readonly keyPrefix: string = 'motia:trace:'\n  private ttl: number\n\n  constructor(streamName: string, client: RedisClientType, ttl: number = TRACE_TTL_SECONDS) {\n    super(streamName)\n    this.client = client\n    this.ttl = ttl\n  }\n\n  private makeGroupKey(groupId: string): string {\n    return `${this.keyPrefix}${groupId}`\n  }\n\n  async get(groupId: string, id: string): Promise<BaseStreamItem<TData> | null> {\n    const hashKey = this.makeGroupKey(groupId)\n    const value = await this.client.hGet(hashKey, id)\n    return value ? JSON.parse(value) : null\n  }\n\n  async set(groupId: string, id: string, data: TData): Promise<BaseStreamItem<TData>> {\n    const hashKey = this.makeGroupKey(groupId)\n    const item: BaseStreamItem<TData> = { ...data, id } as BaseStreamItem<TData>\n    const itemJson = JSON.stringify(item)\n\n    const existed = await this.client.hExists(hashKey, id)\n    const eventType = existed ? 'update' : 'create'\n\n    await Promise.all([\n      this.client.hSet(hashKey, id, itemJson),\n      this.send({ groupId, id }, { type: eventType, data: item }),\n      this.client.expire(hashKey, this.ttl),\n    ])\n\n    return item\n  }\n\n  async delete(groupId: string, id: string): Promise<BaseStreamItem<TData> | null> {\n    const hashKey = this.makeGroupKey(groupId)\n    const value = await this.client.hGet(hashKey, id)\n\n    if (!value) return null\n\n    const item = JSON.parse(value) as BaseStreamItem<TData>\n\n    await Promise.all([this.client.hDel(hashKey, id), this.send({ groupId, id }, { type: 'delete', data: item })])\n\n    return item\n  }\n\n  async getGroup(groupId: string): Promise<BaseStreamItem<TData>[]> {\n    const hashKey = this.makeGroupKey(groupId)\n    const values = await this.client.hGetAll(hashKey)\n\n    const items = Object.values(values).map((v: string) => JSON.parse(v) as BaseStreamItem<TData>)\n\n    const sortDesc = (a: BaseStreamItem<TData>, b: BaseStreamItem<TData>) => {\n      const aTime = (a as { startTime?: number }).startTime || 0\n      const bTime = (b as { startTime?: number }).startTime || 0\n      return aTime - bTime\n    }\n    return items.sort(sortDesc)\n  }\n\n  async send<T>(channel: StateStreamEventChannel, event: StateStreamEvent<T>): Promise<void> {\n    const channelKey = channel.id\n      ? `${this.keyPrefix}events:${this.streamName}:${channel.groupId}:${channel.id}`\n      : `${this.keyPrefix}events:${this.streamName}:${channel.groupId}`\n    await this.client.publish(channelKey, JSON.stringify(event))\n  }\n\n  async clear(groupId: string): Promise<void> {\n    const hashKey = this.makeGroupKey(groupId)\n    await this.client.del(hashKey)\n  }\n}\n"],"mappings":";;;AAIA,MAAM,oBAAoB,OAAc;AAExC,IAAa,0BAAb,cAAoD,cAAqB;CAKvE,YAAY,YAAoB,QAAyB,MAAc,mBAAmB;AACxF,QAAM,WAAW;mBAJkB;AAKnC,OAAK,SAAS;AACd,OAAK,MAAM;;CAGb,AAAQ,aAAa,SAAyB;AAC5C,SAAO,GAAG,KAAK,YAAY;;CAG7B,MAAM,IAAI,SAAiB,IAAmD;EAC5E,MAAM,UAAU,KAAK,aAAa,QAAQ;EAC1C,MAAM,QAAQ,MAAM,KAAK,OAAO,KAAK,SAAS,GAAG;AACjD,SAAO,QAAQ,KAAK,MAAM,MAAM,GAAG;;CAGrC,MAAM,IAAI,SAAiB,IAAY,MAA6C;EAClF,MAAM,UAAU,KAAK,aAAa,QAAQ;EAC1C,MAAMA,OAA8B;GAAE,GAAG;GAAM;GAAI;EACnD,MAAM,WAAW,KAAK,UAAU,KAAK;EAGrC,MAAM,YADU,MAAM,KAAK,OAAO,QAAQ,SAAS,GAAG,GAC1B,WAAW;AAEvC,QAAM,QAAQ,IAAI;GAChB,KAAK,OAAO,KAAK,SAAS,IAAI,SAAS;GACvC,KAAK,KAAK;IAAE;IAAS;IAAI,EAAE;IAAE,MAAM;IAAW,MAAM;IAAM,CAAC;GAC3D,KAAK,OAAO,OAAO,SAAS,KAAK,IAAI;GACtC,CAAC;AAEF,SAAO;;CAGT,MAAM,OAAO,SAAiB,IAAmD;EAC/E,MAAM,UAAU,KAAK,aAAa,QAAQ;EAC1C,MAAM,QAAQ,MAAM,KAAK,OAAO,KAAK,SAAS,GAAG;AAEjD,MAAI,CAAC,MAAO,QAAO;EAEnB,MAAM,OAAO,KAAK,MAAM,MAAM;AAE9B,QAAM,QAAQ,IAAI,CAAC,KAAK,OAAO,KAAK,SAAS,GAAG,EAAE,KAAK,KAAK;GAAE;GAAS;GAAI,EAAE;GAAE,MAAM;GAAU,MAAM;GAAM,CAAC,CAAC,CAAC;AAE9G,SAAO;;CAGT,MAAM,SAAS,SAAmD;EAChE,MAAM,UAAU,KAAK,aAAa,QAAQ;EAC1C,MAAM,SAAS,MAAM,KAAK,OAAO,QAAQ,QAAQ;EAEjD,MAAM,QAAQ,OAAO,OAAO,OAAO,CAAC,KAAK,MAAc,KAAK,MAAM,EAAE,CAA0B;EAE9F,MAAM,YAAY,GAA0B,MAA6B;AAGvE,WAFe,EAA6B,aAAa,MAC1C,EAA6B,aAAa;;AAG3D,SAAO,MAAM,KAAK,SAAS;;CAG7B,MAAM,KAAQ,SAAkC,OAA2C;EACzF,MAAM,aAAa,QAAQ,KACvB,GAAG,KAAK,UAAU,SAAS,KAAK,WAAW,GAAG,QAAQ,QAAQ,GAAG,QAAQ,OACzE,GAAG,KAAK,UAAU,SAAS,KAAK,WAAW,GAAG,QAAQ;AAC1D,QAAM,KAAK,OAAO,QAAQ,YAAY,KAAK,UAAU,MAAM,CAAC;;CAG9D,MAAM,MAAM,SAAgC;EAC1C,MAAM,UAAU,KAAK,aAAa,QAAQ;AAC1C,QAAM,KAAK,OAAO,IAAI,QAAQ"}