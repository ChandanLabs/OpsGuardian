{"version":3,"file":"validate-event-input.mjs","names":["compiledSchema: any","validate: ValidateFunction","missingFields: string[]","extraFields: string[]","typeMismatches: string[]"],"sources":["../../src/validate-event-input.ts"],"sourcesContent":["import Ajv, { type ErrorObject, type ValidateFunction } from 'ajv'\nimport { globalLogger } from './logger'\nimport { Printer } from './printer'\nimport { schemaToJsonSchema } from './schema-utils'\nimport type { Event, EventConfig, Step } from './types'\n\nconst ajv = new Ajv({ allErrors: true, strict: false })\n\nexport const validateEventInput = (step: Step<EventConfig>, event: Event, motia: any) => {\n  const { data } = event\n  const logger = event.logger\n    ? event.logger.child({ step: step.config.name })\n    : motia.loggerFactory.create({ step: step.config.name, traceId: event.traceId })\n\n  if (step.config.input) {\n    if (data === null || typeof data !== 'object') {\n      logger.warn(`⚠️ Event \"${step.config.name}\" received non-object data`, { data })\n      return\n    }\n\n    let compiledSchema: any\n    const inputSchema = step.config.input\n\n    try {\n      compiledSchema = schemaToJsonSchema(inputSchema)\n      if (!compiledSchema) {\n        compiledSchema = inputSchema\n      }\n    } catch (err) {\n      logger.error(`❌ Failed to convert or compile schema for step \"${step.config.name}\"`, { error: err })\n      globalLogger.error('[step handler] failed to convert schema', { step: step.config.name, error: err })\n      return\n    }\n\n    let validate: ValidateFunction\n    try {\n      validate = ajv.compile(compiledSchema)\n    } catch (err) {\n      logger.error(`❌ Invalid JSON schema for step \"${step.config.name}\"`, { error: err })\n      globalLogger.error('[step handler] invalid JSON schema', { step: step.config.name, error: err })\n      return\n    }\n\n    const valid = validate(data)\n\n    if (!valid && validate.errors?.length) {\n      const missingFields: string[] = []\n      const extraFields: string[] = []\n      const typeMismatches: string[] = []\n\n      for (const err of validate.errors as ErrorObject[]) {\n        const field = err.instancePath ? err.instancePath.replace(/^\\//, '').replace(/\\//g, '.') : '(root)'\n\n        switch (err.keyword) {\n          case 'required':\n            if ('missingProperty' in err.params) {\n              missingFields.push(\n                field === '(root)' ? err.params.missingProperty : `${field}.${err.params.missingProperty}`,\n              )\n            }\n            break\n          case 'type':\n            typeMismatches.push(`Field \"${field}\": must be ${err.params.type}`)\n            break\n          case 'additionalProperties':\n            if ('additionalProperty' in err.params) {\n              extraFields.push(\n                field === '(root)' ? err.params.additionalProperty : `${field}.${err.params.additionalProperty}`,\n              )\n            }\n            break\n          default:\n            typeMismatches.push(`Field \"${field}\": ${err.message}`)\n        }\n      }\n\n      const printer = motia?.printer ?? new Printer(process.cwd())\n      printer.printEventInputValidationError({ topic: event.topic }, { missingFields, extraFields, typeMismatches })\n    }\n  }\n}\n"],"mappings":";;;;;;AAMA,MAAM,MAAM,IAAI,IAAI;CAAE,WAAW;CAAM,QAAQ;CAAO,CAAC;AAEvD,MAAa,sBAAsB,MAAyB,OAAc,UAAe;CACvF,MAAM,EAAE,SAAS;CACjB,MAAM,SAAS,MAAM,SACjB,MAAM,OAAO,MAAM,EAAE,MAAM,KAAK,OAAO,MAAM,CAAC,GAC9C,MAAM,cAAc,OAAO;EAAE,MAAM,KAAK,OAAO;EAAM,SAAS,MAAM;EAAS,CAAC;AAElF,KAAI,KAAK,OAAO,OAAO;AACrB,MAAI,SAAS,QAAQ,OAAO,SAAS,UAAU;AAC7C,UAAO,KAAK,aAAa,KAAK,OAAO,KAAK,6BAA6B,EAAE,MAAM,CAAC;AAChF;;EAGF,IAAIA;EACJ,MAAM,cAAc,KAAK,OAAO;AAEhC,MAAI;AACF,oBAAiB,mBAAmB,YAAY;AAChD,OAAI,CAAC,eACH,kBAAiB;WAEZ,KAAK;AACZ,UAAO,MAAM,mDAAmD,KAAK,OAAO,KAAK,IAAI,EAAE,OAAO,KAAK,CAAC;AACpG,gBAAa,MAAM,2CAA2C;IAAE,MAAM,KAAK,OAAO;IAAM,OAAO;IAAK,CAAC;AACrG;;EAGF,IAAIC;AACJ,MAAI;AACF,cAAW,IAAI,QAAQ,eAAe;WAC/B,KAAK;AACZ,UAAO,MAAM,mCAAmC,KAAK,OAAO,KAAK,IAAI,EAAE,OAAO,KAAK,CAAC;AACpF,gBAAa,MAAM,sCAAsC;IAAE,MAAM,KAAK,OAAO;IAAM,OAAO;IAAK,CAAC;AAChG;;AAKF,MAAI,CAFU,SAAS,KAAK,IAEd,SAAS,QAAQ,QAAQ;GACrC,MAAMC,gBAA0B,EAAE;GAClC,MAAMC,cAAwB,EAAE;GAChC,MAAMC,iBAA2B,EAAE;AAEnC,QAAK,MAAM,OAAO,SAAS,QAAyB;IAClD,MAAM,QAAQ,IAAI,eAAe,IAAI,aAAa,QAAQ,OAAO,GAAG,CAAC,QAAQ,OAAO,IAAI,GAAG;AAE3F,YAAQ,IAAI,SAAZ;KACE,KAAK;AACH,UAAI,qBAAqB,IAAI,OAC3B,eAAc,KACZ,UAAU,WAAW,IAAI,OAAO,kBAAkB,GAAG,MAAM,GAAG,IAAI,OAAO,kBAC1E;AAEH;KACF,KAAK;AACH,qBAAe,KAAK,UAAU,MAAM,aAAa,IAAI,OAAO,OAAO;AACnE;KACF,KAAK;AACH,UAAI,wBAAwB,IAAI,OAC9B,aAAY,KACV,UAAU,WAAW,IAAI,OAAO,qBAAqB,GAAG,MAAM,GAAG,IAAI,OAAO,qBAC7E;AAEH;KACF,QACE,gBAAe,KAAK,UAAU,MAAM,KAAK,IAAI,UAAU;;;AAK7D,IADgB,OAAO,WAAW,IAAI,QAAQ,QAAQ,KAAK,CAAC,EACpD,+BAA+B,EAAE,OAAO,MAAM,OAAO,EAAE;IAAE;IAAe;IAAa;IAAgB,CAAC"}