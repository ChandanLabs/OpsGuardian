{"version":3,"file":"redis-stream-adapter-manager.mjs","names":["config: RedisClientOptions"],"sources":["../src/redis-stream-adapter-manager.ts"],"sourcesContent":["import type { StreamAdapter, StreamAdapterManager } from '@motiadev/core'\nimport { createClient, type RedisClientOptions, type RedisClientType } from 'redis'\nimport { RedisStreamAdapter } from './redis-stream-adapter'\nimport type { RedisStreamAdapterConfig, RedisStreamAdapterOptions } from './types'\n\nfunction isRedisClient(input: RedisClientType | RedisClientOptions): input is RedisClientType {\n  return typeof input === 'object' && 'isOpen' in input && 'connect' in input\n}\n\nexport class RedisStreamAdapterManager implements StreamAdapterManager {\n  private client: RedisClientType\n  private connected = false\n  private isExternalClient: boolean\n  private config: RedisStreamAdapterConfig\n\n  constructor(redisConnection: RedisClientType | RedisClientOptions, options?: RedisStreamAdapterOptions) {\n    this.config = {\n      keyPrefix: options?.keyPrefix || 'motia:stream:',\n      socketKeepAlive: options?.socketKeepAlive ?? true,\n    }\n\n    if (isRedisClient(redisConnection)) {\n      this.client = redisConnection\n      this.isExternalClient = true\n      this.connected = this.client.isOpen\n    } else {\n      const config: RedisClientOptions = {\n        ...redisConnection,\n        socket: {\n          ...(redisConnection.socket || {}),\n          keepAlive: this.config.socketKeepAlive,\n          noDelay: true,\n        },\n      } as RedisClientOptions\n      this.isExternalClient = false\n\n      this.client = createClient(config) as RedisClientType\n\n      this.client.on('error', (err) => {\n        if (this.connected) {\n          console.error('[Redis Stream Manager] Client error:', err?.message)\n        }\n      })\n\n      this.client.on('connect', () => {\n        this.connected = true\n      })\n\n      this.client.on('disconnect', () => {\n        console.warn('[Redis Stream Manager] Disconnected')\n        this.connected = false\n      })\n\n      this.connect()\n    }\n  }\n\n  private async connect(): Promise<void> {\n    if (!this.connected && !this.isExternalClient) {\n      try {\n        await this.client.connect()\n      } catch (error) {\n        console.error('[Redis Stream Manager] Failed to connect:', error)\n        throw error\n      }\n    }\n  }\n\n  createStream<TData>(streamName: string): StreamAdapter<TData> {\n    return new RedisStreamAdapter<TData>(streamName, this.config, this.client)\n  }\n\n  getClient(): RedisClientType {\n    return this.client\n  }\n\n  async shutdown(): Promise<void> {\n    if (!this.isExternalClient && this.client.isOpen) {\n      await this.client.quit()\n    }\n  }\n}\n"],"mappings":";;;;AAKA,SAAS,cAAc,OAAuE;AAC5F,QAAO,OAAO,UAAU,YAAY,YAAY,SAAS,aAAa;;AAGxE,IAAa,4BAAb,MAAuE;CAMrE,YAAY,iBAAuD,SAAqC;mBAJpF;AAKlB,OAAK,SAAS;GACZ,WAAW,SAAS,aAAa;GACjC,iBAAiB,SAAS,mBAAmB;GAC9C;AAED,MAAI,cAAc,gBAAgB,EAAE;AAClC,QAAK,SAAS;AACd,QAAK,mBAAmB;AACxB,QAAK,YAAY,KAAK,OAAO;SACxB;GACL,MAAMA,SAA6B;IACjC,GAAG;IACH,QAAQ;KACN,GAAI,gBAAgB,UAAU,EAAE;KAChC,WAAW,KAAK,OAAO;KACvB,SAAS;KACV;IACF;AACD,QAAK,mBAAmB;AAExB,QAAK,SAAS,aAAa,OAAO;AAElC,QAAK,OAAO,GAAG,UAAU,QAAQ;AAC/B,QAAI,KAAK,UACP,SAAQ,MAAM,wCAAwC,KAAK,QAAQ;KAErE;AAEF,QAAK,OAAO,GAAG,iBAAiB;AAC9B,SAAK,YAAY;KACjB;AAEF,QAAK,OAAO,GAAG,oBAAoB;AACjC,YAAQ,KAAK,sCAAsC;AACnD,SAAK,YAAY;KACjB;AAEF,QAAK,SAAS;;;CAIlB,MAAc,UAAyB;AACrC,MAAI,CAAC,KAAK,aAAa,CAAC,KAAK,iBAC3B,KAAI;AACF,SAAM,KAAK,OAAO,SAAS;WACpB,OAAO;AACd,WAAQ,MAAM,6CAA6C,MAAM;AACjE,SAAM;;;CAKZ,aAAoB,YAA0C;AAC5D,SAAO,IAAI,mBAA0B,YAAY,KAAK,QAAQ,KAAK,OAAO;;CAG5E,YAA6B;AAC3B,SAAO,KAAK;;CAGd,MAAM,WAA0B;AAC9B,MAAI,CAAC,KAAK,oBAAoB,KAAK,OAAO,OACxC,OAAM,KAAK,OAAO,MAAM"}