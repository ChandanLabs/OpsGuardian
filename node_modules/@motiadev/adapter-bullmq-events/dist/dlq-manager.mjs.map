{"version":3,"file":"dlq-manager.mjs","names":["queue","dlqJobData: DLQJobData<TData>"],"sources":["../src/dlq-manager.ts"],"sourcesContent":["import type { Event } from '@motiadev/core'\nimport { Queue } from 'bullmq'\nimport type { Redis } from 'ioredis'\nimport type { MergedConfig } from './config-builder'\nimport { DLQ_JOB_PREFIX, LOG_PREFIX, MILLISECONDS_PER_SECOND } from './constants'\nimport { QueueCreationError } from './errors'\n\ntype DLQJobData<TData> = {\n  originalEvent: Event<TData>\n  failureReason: string\n  failureTimestamp: number\n  attemptsMade: number\n  originalJobId?: string\n}\n\nexport class DLQManager {\n  private readonly dlqQueues: Map<string, Queue> = new Map()\n  private readonly connection: Redis\n  private readonly config: MergedConfig\n\n  constructor(connection: Redis, config: MergedConfig) {\n    this.connection = connection\n    this.config = config\n  }\n\n  getDLQQueueName(topic: string, stepName: string): string {\n    const baseQueueName = `${topic}.${stepName}`\n    return `${baseQueueName}${this.config.dlq.suffix}`\n  }\n\n  private getOrCreateDLQQueue(queueName: string): Queue {\n    if (!this.dlqQueues.has(queueName)) {\n      const ttlMs = this.config.dlq.ttl * MILLISECONDS_PER_SECOND\n      const queue = new Queue(queueName, {\n        connection: this.connection,\n        prefix: this.config.prefix,\n        defaultJobOptions: {\n          removeOnComplete: {\n            age: ttlMs,\n          },\n          removeOnFail: {\n            age: ttlMs,\n          },\n        },\n      })\n\n      queue.on('error', (err: Error) => {\n        console.error(`${LOG_PREFIX} DLQ error for ${queueName}:`, err)\n      })\n\n      this.dlqQueues.set(queueName, queue)\n    }\n\n    const queue = this.dlqQueues.get(queueName)\n    if (!queue) {\n      throw new QueueCreationError(queueName)\n    }\n    return queue\n  }\n\n  async moveToDLQ<TData>(\n    topic: string,\n    stepName: string,\n    event: Event<TData>,\n    error: Error,\n    attemptsMade: number,\n    originalJobId?: string,\n  ): Promise<void> {\n    if (!this.config.dlq!.enabled) {\n      console.warn(`${LOG_PREFIX} DLQ is disabled, skipping move to DLQ for topic ${topic}, step ${stepName}`)\n      return\n    }\n\n    try {\n      const dlqQueueName = this.getDLQQueueName(topic, stepName)\n      const dlqQueue = this.getOrCreateDLQQueue(dlqQueueName)\n\n      const sanitizedEvent = {\n        topic: event.topic,\n        data: event.data,\n        traceId: event.traceId || 'unknown',\n        ...(event.flows && { flows: event.flows }),\n        ...(event.messageGroupId && { messageGroupId: event.messageGroupId }),\n      } as Event<TData>\n\n      const dlqJobData: DLQJobData<TData> = {\n        originalEvent: sanitizedEvent,\n        failureReason: error.message || 'Unknown error',\n        failureTimestamp: Date.now(),\n        attemptsMade,\n        ...(originalJobId && { originalJobId }),\n      }\n\n      const jobOptions = originalJobId ? { jobId: `${DLQ_JOB_PREFIX}${originalJobId}` } : {}\n\n      await dlqQueue.add(`${topic}.dlq`, dlqJobData, jobOptions)\n\n      console.warn(`${LOG_PREFIX} Moved failed job to DLQ: ${dlqQueueName}`, {\n        topic,\n        stepName,\n        attemptsMade,\n        error: error.message,\n      })\n    } catch (err) {\n      const dlqError = err instanceof Error ? err : new Error(String(err))\n      console.error(`${LOG_PREFIX} Failed to move job to DLQ for topic ${topic}, step ${stepName}:`, dlqError)\n    }\n  }\n\n  async closeDLQQueue(queueName: string): Promise<void> {\n    const queue = this.dlqQueues.get(queueName)\n    if (queue) {\n      await queue.close()\n      this.dlqQueues.delete(queueName)\n    }\n  }\n\n  async closeAll(): Promise<void> {\n    const promises = Array.from(this.dlqQueues.values()).map((queue) =>\n      queue.close().catch((err) => {\n        console.error(`${LOG_PREFIX} Error closing DLQ queue:`, err)\n      }),\n    )\n    await Promise.allSettled(promises)\n    this.dlqQueues.clear()\n  }\n\n  getDLQQueue(queueName: string): Queue | undefined {\n    return this.dlqQueues.get(queueName)\n  }\n\n  getOrCreateDLQ(queueName: string): Queue {\n    return this.getOrCreateDLQQueue(queueName)\n  }\n\n  listDLQQueueNames(): string[] {\n    return Array.from(this.dlqQueues.keys())\n  }\n\n  getDLQSuffix(): string {\n    return this.config.dlq.suffix\n  }\n\n  getPrefix(): string {\n    return this.config.prefix\n  }\n\n  getConnection(): Redis {\n    return this.connection\n  }\n}\n"],"mappings":";;;;;AAeA,IAAa,aAAb,MAAwB;CAKtB,YAAY,YAAmB,QAAsB;mCAJJ,IAAI,KAAK;AAKxD,OAAK,aAAa;AAClB,OAAK,SAAS;;CAGhB,gBAAgB,OAAe,UAA0B;AAEvD,SAAO,GADe,GAAG,MAAM,GAAG,aACR,KAAK,OAAO,IAAI;;CAG5C,AAAQ,oBAAoB,WAA0B;AACpD,MAAI,CAAC,KAAK,UAAU,IAAI,UAAU,EAAE;GAClC,MAAM,QAAQ,KAAK,OAAO,IAAI,MAAM;GACpC,MAAMA,UAAQ,IAAI,MAAM,WAAW;IACjC,YAAY,KAAK;IACjB,QAAQ,KAAK,OAAO;IACpB,mBAAmB;KACjB,kBAAkB,EAChB,KAAK,OACN;KACD,cAAc,EACZ,KAAK,OACN;KACF;IACF,CAAC;AAEF,WAAM,GAAG,UAAU,QAAe;AAChC,YAAQ,MAAM,GAAG,WAAW,iBAAiB,UAAU,IAAI,IAAI;KAC/D;AAEF,QAAK,UAAU,IAAI,WAAWA,QAAM;;EAGtC,MAAM,QAAQ,KAAK,UAAU,IAAI,UAAU;AAC3C,MAAI,CAAC,MACH,OAAM,IAAI,mBAAmB,UAAU;AAEzC,SAAO;;CAGT,MAAM,UACJ,OACA,UACA,OACA,OACA,cACA,eACe;AACf,MAAI,CAAC,KAAK,OAAO,IAAK,SAAS;AAC7B,WAAQ,KAAK,GAAG,WAAW,mDAAmD,MAAM,SAAS,WAAW;AACxG;;AAGF,MAAI;GACF,MAAM,eAAe,KAAK,gBAAgB,OAAO,SAAS;GAC1D,MAAM,WAAW,KAAK,oBAAoB,aAAa;GAUvD,MAAMC,aAAgC;IACpC,eATqB;KACrB,OAAO,MAAM;KACb,MAAM,MAAM;KACZ,SAAS,MAAM,WAAW;KAC1B,GAAI,MAAM,SAAS,EAAE,OAAO,MAAM,OAAO;KACzC,GAAI,MAAM,kBAAkB,EAAE,gBAAgB,MAAM,gBAAgB;KACrE;IAIC,eAAe,MAAM,WAAW;IAChC,kBAAkB,KAAK,KAAK;IAC5B;IACA,GAAI,iBAAiB,EAAE,eAAe;IACvC;GAED,MAAM,aAAa,gBAAgB,EAAE,OAAO,GAAG,iBAAiB,iBAAiB,GAAG,EAAE;AAEtF,SAAM,SAAS,IAAI,GAAG,MAAM,OAAO,YAAY,WAAW;AAE1D,WAAQ,KAAK,GAAG,WAAW,4BAA4B,gBAAgB;IACrE;IACA;IACA;IACA,OAAO,MAAM;IACd,CAAC;WACK,KAAK;GACZ,MAAM,WAAW,eAAe,QAAQ,MAAM,IAAI,MAAM,OAAO,IAAI,CAAC;AACpE,WAAQ,MAAM,GAAG,WAAW,uCAAuC,MAAM,SAAS,SAAS,IAAI,SAAS;;;CAI5G,MAAM,cAAc,WAAkC;EACpD,MAAM,QAAQ,KAAK,UAAU,IAAI,UAAU;AAC3C,MAAI,OAAO;AACT,SAAM,MAAM,OAAO;AACnB,QAAK,UAAU,OAAO,UAAU;;;CAIpC,MAAM,WAA0B;EAC9B,MAAM,WAAW,MAAM,KAAK,KAAK,UAAU,QAAQ,CAAC,CAAC,KAAK,UACxD,MAAM,OAAO,CAAC,OAAO,QAAQ;AAC3B,WAAQ,MAAM,GAAG,WAAW,4BAA4B,IAAI;IAC5D,CACH;AACD,QAAM,QAAQ,WAAW,SAAS;AAClC,OAAK,UAAU,OAAO;;CAGxB,YAAY,WAAsC;AAChD,SAAO,KAAK,UAAU,IAAI,UAAU;;CAGtC,eAAe,WAA0B;AACvC,SAAO,KAAK,oBAAoB,UAAU;;CAG5C,oBAA8B;AAC5B,SAAO,MAAM,KAAK,KAAK,UAAU,MAAM,CAAC;;CAG1C,eAAuB;AACrB,SAAO,KAAK,OAAO,IAAI;;CAGzB,YAAoB;AAClB,SAAO,KAAK,OAAO;;CAGrB,gBAAuB;AACrB,SAAO,KAAK"}