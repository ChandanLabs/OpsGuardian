{"version":3,"file":"bullmq-event-adapter.mjs","names":[],"sources":["../src/bullmq-event-adapter.ts"],"sourcesContent":["import type { Event, EventAdapter, QueueConfig, SubscriptionHandle } from '@motiadev/core'\nimport type { Redis } from 'ioredis'\nimport { buildConfig, type MergedConfig } from './config-builder'\nimport { ConnectionManager } from './connection-manager'\nimport { DLQManager } from './dlq-manager'\nimport { QueueManager } from './queue-manager'\nimport type { BullMQEventAdapterConfig } from './types'\nimport { WorkerManager } from './worker-manager'\n\nexport class BullMQEventAdapter implements EventAdapter {\n  private readonly connectionManager: ConnectionManager\n  private readonly _queueManager: QueueManager\n  private readonly _workerManager: WorkerManager\n  private readonly _dlqManager: DLQManager\n  private readonly _config: MergedConfig\n\n  constructor(config: BullMQEventAdapterConfig) {\n    this._config = buildConfig(config)\n    this.connectionManager = new ConnectionManager(config.connection)\n    this._queueManager = new QueueManager(this.connectionManager.connection, this._config)\n    this._dlqManager = new DLQManager(this.connectionManager.connection, this._config)\n    this._workerManager = new WorkerManager(\n      this.connectionManager.connection,\n      this._config,\n      (topic, stepName) => this._queueManager.getQueueName(topic, stepName),\n      this._dlqManager,\n    )\n  }\n\n  get connection(): Redis {\n    return this.connectionManager.connection\n  }\n\n  get prefix(): string {\n    return this._config.prefix\n  }\n\n  get dlqSuffix(): string {\n    return this._config.dlq.suffix\n  }\n\n  get queueManager(): QueueManager {\n    return this._queueManager\n  }\n\n  get workerManager(): WorkerManager {\n    return this._workerManager\n  }\n\n  get dlqManager(): DLQManager {\n    return this._dlqManager\n  }\n\n  async emit<TData>(event: Event<TData>): Promise<void> {\n    const subscribers = this._workerManager.getSubscribers(event.topic)\n    if (subscribers.length === 0) {\n      return\n    }\n\n    await this._queueManager.enqueueToAll(event, subscribers)\n  }\n\n  async subscribe<TData>(\n    topic: string,\n    stepName: string,\n    handler: (event: Event<TData>) => void | Promise<void>,\n    options?: QueueConfig,\n  ): Promise<SubscriptionHandle> {\n    const queueName = this._queueManager.getQueueName(topic, stepName)\n    this._queueManager.getQueue(queueName)\n\n    return this._workerManager.createWorker(topic, stepName, handler, options)\n  }\n\n  async unsubscribe(handle: SubscriptionHandle): Promise<void> {\n    const workerInfo = this._workerManager.getWorkerInfo(handle.id)\n    if (workerInfo) {\n      const queueName = this._queueManager.getQueueName(workerInfo.topic, workerInfo.stepName)\n      await this._queueManager.closeQueue(queueName)\n      await this._workerManager.removeWorker(handle.id)\n    }\n  }\n\n  async shutdown(): Promise<void> {\n    await Promise.allSettled([\n      this._workerManager.closeAll(),\n      this._queueManager.closeAll(),\n      this._dlqManager.closeAll(),\n    ])\n\n    try {\n      await this.connectionManager.close()\n    } catch (err) {\n      console.error('[BullMQ] Error closing connection:', err)\n    }\n  }\n\n  async getSubscriptionCount(topic: string): Promise<number> {\n    return this._workerManager.getSubscriptionCount(topic)\n  }\n\n  async listTopics(): Promise<string[]> {\n    return this._workerManager.listTopics()\n  }\n}\n"],"mappings":";;;;;;;AASA,IAAa,qBAAb,MAAwD;CAOtD,YAAY,QAAkC;AAC5C,OAAK,UAAU,YAAY,OAAO;AAClC,OAAK,oBAAoB,IAAI,kBAAkB,OAAO,WAAW;AACjE,OAAK,gBAAgB,IAAI,aAAa,KAAK,kBAAkB,YAAY,KAAK,QAAQ;AACtF,OAAK,cAAc,IAAI,WAAW,KAAK,kBAAkB,YAAY,KAAK,QAAQ;AAClF,OAAK,iBAAiB,IAAI,cACxB,KAAK,kBAAkB,YACvB,KAAK,UACJ,OAAO,aAAa,KAAK,cAAc,aAAa,OAAO,SAAS,EACrE,KAAK,YACN;;CAGH,IAAI,aAAoB;AACtB,SAAO,KAAK,kBAAkB;;CAGhC,IAAI,SAAiB;AACnB,SAAO,KAAK,QAAQ;;CAGtB,IAAI,YAAoB;AACtB,SAAO,KAAK,QAAQ,IAAI;;CAG1B,IAAI,eAA6B;AAC/B,SAAO,KAAK;;CAGd,IAAI,gBAA+B;AACjC,SAAO,KAAK;;CAGd,IAAI,aAAyB;AAC3B,SAAO,KAAK;;CAGd,MAAM,KAAY,OAAoC;EACpD,MAAM,cAAc,KAAK,eAAe,eAAe,MAAM,MAAM;AACnE,MAAI,YAAY,WAAW,EACzB;AAGF,QAAM,KAAK,cAAc,aAAa,OAAO,YAAY;;CAG3D,MAAM,UACJ,OACA,UACA,SACA,SAC6B;EAC7B,MAAM,YAAY,KAAK,cAAc,aAAa,OAAO,SAAS;AAClE,OAAK,cAAc,SAAS,UAAU;AAEtC,SAAO,KAAK,eAAe,aAAa,OAAO,UAAU,SAAS,QAAQ;;CAG5E,MAAM,YAAY,QAA2C;EAC3D,MAAM,aAAa,KAAK,eAAe,cAAc,OAAO,GAAG;AAC/D,MAAI,YAAY;GACd,MAAM,YAAY,KAAK,cAAc,aAAa,WAAW,OAAO,WAAW,SAAS;AACxF,SAAM,KAAK,cAAc,WAAW,UAAU;AAC9C,SAAM,KAAK,eAAe,aAAa,OAAO,GAAG;;;CAIrD,MAAM,WAA0B;AAC9B,QAAM,QAAQ,WAAW;GACvB,KAAK,eAAe,UAAU;GAC9B,KAAK,cAAc,UAAU;GAC7B,KAAK,YAAY,UAAU;GAC5B,CAAC;AAEF,MAAI;AACF,SAAM,KAAK,kBAAkB,OAAO;WAC7B,KAAK;AACZ,WAAQ,MAAM,sCAAsC,IAAI;;;CAI5D,MAAM,qBAAqB,OAAgC;AACzD,SAAO,KAAK,eAAe,qBAAqB,MAAM;;CAGxD,MAAM,aAAgC;AACpC,SAAO,KAAK,eAAe,YAAY"}