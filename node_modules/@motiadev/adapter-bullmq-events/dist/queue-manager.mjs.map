{"version":3,"file":"queue-manager.mjs","names":["queue"],"sources":["../src/queue-manager.ts"],"sourcesContent":["import type { Event } from '@motiadev/core'\nimport { Queue } from 'bullmq'\nimport type { Redis } from 'ioredis'\nimport type { MergedConfig } from './config-builder'\nimport { MILLISECONDS_PER_SECOND } from './constants'\nimport { QueueCreationError } from './errors'\nimport type { SubscriberInfo } from './worker-manager'\n\nexport class QueueManager {\n  private readonly queues: Map<string, Queue> = new Map()\n  private readonly connection: Redis\n  private readonly config: MergedConfig\n\n  constructor(connection: Redis, config: MergedConfig) {\n    this.connection = connection\n    this.config = config\n  }\n\n  getQueue(queueName: string): Queue {\n    if (!this.queues.has(queueName)) {\n      const queue = new Queue(queueName, {\n        connection: this.connection,\n        prefix: this.config.prefix,\n        defaultJobOptions: this.config.defaultJobOptions,\n      })\n\n      queue.on('error', (err: Error) => {\n        console.error(`[BullMQ] Queue error for ${queueName}:`, err)\n      })\n\n      this.queues.set(queueName, queue)\n    }\n\n    const queue = this.queues.get(queueName)\n    if (!queue) {\n      throw new QueueCreationError(queueName)\n    }\n    return queue\n  }\n\n  getQueueName(topic: string, stepName: string): string {\n    return `${topic}.${stepName}`\n  }\n\n  async enqueueToAll<TData>(event: Event<TData>, subscribers: SubscriberInfo[]): Promise<void> {\n    const promises = subscribers.map((subscriber) => {\n      const queueName = this.getQueueName(subscriber.topic, subscriber.stepName)\n      const queue = this.getQueue(queueName)\n      const jobId = event.messageGroupId ? `${queueName}.${event.messageGroupId}` : undefined\n\n      const jobData = {\n        topic: event.topic,\n        data: event.data,\n        traceId: event.traceId,\n        flows: event.flows,\n        messageGroupId: event.messageGroupId,\n      }\n\n      const maxRetries = subscriber.queueConfig?.maxRetries\n      const attempts = maxRetries != null ? maxRetries + 1 : this.config.defaultJobOptions.attempts\n      const delay = subscriber.queueConfig?.delaySeconds\n        ? subscriber.queueConfig.delaySeconds * MILLISECONDS_PER_SECOND\n        : undefined\n\n      const jobOptions = {\n        jobId,\n        attempts,\n        backoff: this.config.defaultJobOptions.backoff,\n        delay,\n      }\n\n      return queue.add(event.topic, jobData, jobOptions).then(() => undefined)\n    })\n\n    await Promise.all(promises)\n  }\n\n  async closeQueue(queueName: string): Promise<void> {\n    const queue = this.queues.get(queueName)\n    if (queue) {\n      await queue.close()\n      this.queues.delete(queueName)\n    }\n  }\n\n  async closeAll(): Promise<void> {\n    const promises = Array.from(this.queues.values()).map((queue) =>\n      queue.close().catch((err) => {\n        console.error(`[BullMQ] Error closing queue:`, err)\n      }),\n    )\n    await Promise.allSettled(promises)\n    this.queues.clear()\n  }\n\n  listQueueNames(): string[] {\n    return Array.from(this.queues.keys())\n  }\n\n  getPrefix(): string {\n    return this.config.prefix\n  }\n\n  getConnection(): Redis {\n    return this.connection\n  }\n}\n"],"mappings":";;;;;AAQA,IAAa,eAAb,MAA0B;CAKxB,YAAY,YAAmB,QAAsB;gCAJP,IAAI,KAAK;AAKrD,OAAK,aAAa;AAClB,OAAK,SAAS;;CAGhB,SAAS,WAA0B;AACjC,MAAI,CAAC,KAAK,OAAO,IAAI,UAAU,EAAE;GAC/B,MAAMA,UAAQ,IAAI,MAAM,WAAW;IACjC,YAAY,KAAK;IACjB,QAAQ,KAAK,OAAO;IACpB,mBAAmB,KAAK,OAAO;IAChC,CAAC;AAEF,WAAM,GAAG,UAAU,QAAe;AAChC,YAAQ,MAAM,4BAA4B,UAAU,IAAI,IAAI;KAC5D;AAEF,QAAK,OAAO,IAAI,WAAWA,QAAM;;EAGnC,MAAM,QAAQ,KAAK,OAAO,IAAI,UAAU;AACxC,MAAI,CAAC,MACH,OAAM,IAAI,mBAAmB,UAAU;AAEzC,SAAO;;CAGT,aAAa,OAAe,UAA0B;AACpD,SAAO,GAAG,MAAM,GAAG;;CAGrB,MAAM,aAAoB,OAAqB,aAA8C;EAC3F,MAAM,WAAW,YAAY,KAAK,eAAe;GAC/C,MAAM,YAAY,KAAK,aAAa,WAAW,OAAO,WAAW,SAAS;GAC1E,MAAM,QAAQ,KAAK,SAAS,UAAU;GACtC,MAAM,QAAQ,MAAM,iBAAiB,GAAG,UAAU,GAAG,MAAM,mBAAmB;GAE9E,MAAM,UAAU;IACd,OAAO,MAAM;IACb,MAAM,MAAM;IACZ,SAAS,MAAM;IACf,OAAO,MAAM;IACb,gBAAgB,MAAM;IACvB;GAED,MAAM,aAAa,WAAW,aAAa;GAC3C,MAAM,WAAW,cAAc,OAAO,aAAa,IAAI,KAAK,OAAO,kBAAkB;GACrF,MAAM,QAAQ,WAAW,aAAa,eAClC,WAAW,YAAY,eAAe,0BACtC;GAEJ,MAAM,aAAa;IACjB;IACA;IACA,SAAS,KAAK,OAAO,kBAAkB;IACvC;IACD;AAED,UAAO,MAAM,IAAI,MAAM,OAAO,SAAS,WAAW,CAAC,WAAW,OAAU;IACxE;AAEF,QAAM,QAAQ,IAAI,SAAS;;CAG7B,MAAM,WAAW,WAAkC;EACjD,MAAM,QAAQ,KAAK,OAAO,IAAI,UAAU;AACxC,MAAI,OAAO;AACT,SAAM,MAAM,OAAO;AACnB,QAAK,OAAO,OAAO,UAAU;;;CAIjC,MAAM,WAA0B;EAC9B,MAAM,WAAW,MAAM,KAAK,KAAK,OAAO,QAAQ,CAAC,CAAC,KAAK,UACrD,MAAM,OAAO,CAAC,OAAO,QAAQ;AAC3B,WAAQ,MAAM,iCAAiC,IAAI;IACnD,CACH;AACD,QAAM,QAAQ,WAAW,SAAS;AAClC,OAAK,OAAO,OAAO;;CAGrB,iBAA2B;AACzB,SAAO,MAAM,KAAK,KAAK,OAAO,MAAM,CAAC;;CAGvC,YAAoB;AAClB,SAAO,KAAK,OAAO;;CAGrB,gBAAuB;AACrB,SAAO,KAAK"}