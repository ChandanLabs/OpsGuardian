import {
  Stream
} from "./chunk-7OWYCO6Z.js";
import {
  require_jsx_runtime
} from "./chunk-OVCHON5Z.js";
import {
  require_compiler_runtime
} from "./chunk-N7QBCMQ7.js";
import {
  require_react
} from "./chunk-J3YWFM6B.js";
import {
  __toESM
} from "./chunk-PR4QN5HX.js";

// node_modules/@motiadev/stream-client-react/dist/index.js
var import_compiler_runtime = __toESM(require_compiler_runtime());
var import_react = __toESM(require_react());
var import_jsx_runtime = __toESM(require_jsx_runtime());
var MotiaStreamContext = import_react.default.createContext({ stream: null });
var MotiaStreamProvider = (t0) => {
  const $ = (0, import_compiler_runtime.c)(9);
  const { children, address, protocols } = t0;
  const [stream, setStream] = (0, import_react.useState)(null);
  let t1;
  let t2;
  if ($[0] !== address || $[1] !== protocols) {
    t1 = () => {
      const streamInstance = new Stream(address, { protocols });
      setStream(streamInstance);
      return () => streamInstance.close();
    };
    t2 = [address, protocols];
    $[0] = address;
    $[1] = protocols;
    $[2] = t1;
    $[3] = t2;
  } else {
    t1 = $[2];
    t2 = $[3];
  }
  (0, import_react.useEffect)(t1, t2);
  let t3;
  if ($[4] !== stream) {
    t3 = { stream };
    $[4] = stream;
    $[5] = t3;
  } else t3 = $[5];
  const contextValue = t3;
  let t4;
  if ($[6] !== children || $[7] !== contextValue) {
    t4 = (0, import_jsx_runtime.jsx)(MotiaStreamContext.Provider, {
      value: contextValue,
      children
    });
    $[6] = children;
    $[7] = contextValue;
    $[8] = t4;
  } else t4 = $[8];
  return t4;
};
var useMotiaStream = () => {
  const context = import_react.default.useContext(MotiaStreamContext);
  if (!context) throw new Error("useMotiaStream must be used within a MotiaStreamProvider");
  return context;
};
var useStreamEventHandler = (t0, dependencies) => {
  const $ = (0, import_compiler_runtime.c)(8);
  const { event, type, listener } = t0;
  let t1;
  if ($[0] !== event || $[1] !== listener || $[2] !== type) {
    t1 = () => {
      if (event) {
        event.onEvent(type, listener);
        return () => event.offEvent(type, listener);
      }
    };
    $[0] = event;
    $[1] = listener;
    $[2] = type;
    $[3] = t1;
  } else t1 = $[3];
  let t2;
  if ($[4] !== dependencies || $[5] !== event || $[6] !== type) {
    t2 = [
      event,
      type,
      ...dependencies
    ];
    $[4] = dependencies;
    $[5] = event;
    $[6] = type;
    $[7] = t2;
  } else t2 = $[7];
  (0, import_react.useEffect)(t1, t2);
};
var useStreamGroup = (args) => {
  const { stream } = useMotiaStream();
  const [data, setData] = (0, import_react.useState)([]);
  const subscriptionRef = (0, import_react.useRef)(null);
  const { streamName, groupId, sortKey, setData: setDataCallback } = args || {};
  (0, import_react.useEffect)(() => {
    if (!streamName || !groupId || !stream) {
      console.error("useStreamGroup: streamName, groupId or stream is not defined", {
        streamName,
        groupId,
        stream
      });
      return;
    }
    subscriptionRef.current = stream.subscribeGroup(streamName, groupId, sortKey);
    subscriptionRef.current.addChangeListener((data_0) => {
      const typedData = data_0;
      setData(typedData);
      setDataCallback?.(typedData);
    });
    return () => {
      subscriptionRef.current?.close();
      subscriptionRef.current = null;
      setData([]);
    };
  }, [
    stream,
    streamName,
    groupId,
    sortKey,
    setDataCallback
  ]);
  return {
    data,
    event: subscriptionRef.current
  };
};
var useStreamItem = (args) => {
  const $ = (0, import_compiler_runtime.c)(12);
  const { stream } = useMotiaStream();
  const [data, setData] = (0, import_react.useState)();
  const [event, setEvent] = (0, import_react.useState)(null);
  let t0;
  if ($[0] !== args) {
    t0 = args || {};
    $[0] = args;
    $[1] = t0;
  } else t0 = $[1];
  const { streamName, groupId, id } = t0;
  let t1;
  if ($[2] === /* @__PURE__ */ Symbol.for("react.memo_cache_sentinel")) {
    t1 = (data_0) => {
      setData(data_0);
    };
    $[2] = t1;
  } else t1 = $[2];
  const handleChange = t1;
  let t2;
  let t3;
  if ($[3] !== groupId || $[4] !== id || $[5] !== stream || $[6] !== streamName) {
    t2 = () => {
      if (!streamName || !groupId || !id || !stream) return;
      const subscription = stream.subscribeItem(streamName, groupId, id);
      subscription.addChangeListener(handleChange);
      setEvent(subscription);
      return () => {
        setData(void 0);
        setEvent(null);
        subscription.close();
      };
    };
    t3 = [
      stream,
      streamName,
      groupId,
      id,
      handleChange
    ];
    $[3] = groupId;
    $[4] = id;
    $[5] = stream;
    $[6] = streamName;
    $[7] = t2;
    $[8] = t3;
  } else {
    t2 = $[7];
    t3 = $[8];
  }
  (0, import_react.useEffect)(t2, t3);
  let t4;
  if ($[9] !== data || $[10] !== event) {
    t4 = {
      data,
      event
    };
    $[9] = data;
    $[10] = event;
    $[11] = t4;
  } else t4 = $[11];
  return t4;
};

export {
  MotiaStreamProvider,
  useMotiaStream,
  useStreamEventHandler,
  useStreamGroup,
  useStreamItem
};
//# sourceMappingURL=chunk-EC5G5YSN.js.map
