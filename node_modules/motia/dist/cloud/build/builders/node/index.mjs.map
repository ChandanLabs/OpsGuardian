{"version":3,"file":"index.mjs","names":["builder: Builder","listener: BuildListener","defaultConfig: esbuild.BuildOptions"],"sources":["../../../../../src/cloud/build/builders/node/index.ts"],"sourcesContent":["import type { ApiRouteConfig, Step } from '@motiadev/core'\nimport * as esbuild from 'esbuild'\nimport fs from 'fs'\nimport path from 'path'\nimport pc from 'picocolors'\nimport { fileURLToPath } from 'url'\nimport { distDir } from '../../../new-deployment/constants'\nimport type { BuildListener } from '../../../new-deployment/listeners/listener.types'\nimport type { Builder, RouterBuildResult, StepBuilder } from '../../builder'\nimport { Archiver } from '../archiver'\nimport { includeStaticFiles } from '../include-static-files'\n\nexport class NodeBuilder implements StepBuilder {\n  constructor(\n    private readonly builder: Builder,\n    private readonly listener: BuildListener,\n  ) {}\n\n  private async loadEsbuildConfig(): Promise<esbuild.BuildOptions | null> {\n    const configFiles = ['esbuild.config.json', '.esbuildrc.json']\n\n    for (const configFile of configFiles) {\n      const configPath = path.join(this.builder.projectDir, configFile)\n      if (fs.existsSync(configPath)) {\n        try {\n          const configContent = fs.readFileSync(configPath, 'utf-8')\n          return JSON.parse(configContent)\n        } catch (err) {\n          console.warn(pc.yellow(`Warning: Failed to load esbuild config from ${configFile}`))\n        }\n      }\n    }\n\n    return null\n  }\n\n  async buildApiSteps(steps: Step<ApiRouteConfig>[]): Promise<RouterBuildResult> {\n    const relativePath = path.relative(distDir, this.builder.projectDir)\n    const getStepPath = (step: Step<ApiRouteConfig>) => {\n      return step.filePath\n        .replace(this.builder.projectDir, relativePath)\n        .replace(/(.*)\\.(ts|js)$/, '$1.js')\n        .replace(/\\\\/g, '/')\n    }\n    const __dirname = path.dirname(fileURLToPath(import.meta.url))\n\n    const file = fs\n      .readFileSync(path.join(__dirname, 'router-template.ts'), 'utf-8')\n      .replace(\n        '// {{imports}}',\n        steps.map((step, index) => `import * as route${index} from '${getStepPath(step)}'`).join('\\n'),\n      )\n      .replace(\n        '// {{router paths}}',\n        steps\n          .map(\n            (step, index) =>\n              `'${step.config.method} ${step.config.path}': { stepName: '${step.config.name}', handler: route${index}.handler, config: route${index}.config }`,\n          )\n          .join(',\\n'),\n      )\n\n    const tsRouter = path.join(distDir, 'router.ts')\n    fs.writeFileSync(tsRouter, file)\n\n    const userConfig = await this.loadEsbuildConfig()\n    const defaultConfig: esbuild.BuildOptions = {\n      entryPoints: [tsRouter],\n      bundle: true,\n      sourcemap: true,\n      outfile: path.join(distDir, 'router.js'),\n      platform: 'node',\n    }\n\n    await esbuild.build(userConfig ? { ...defaultConfig, ...userConfig } : defaultConfig)\n\n    const zipName = 'router-node.zip'\n    const archiver = new Archiver(path.join(distDir, zipName))\n    const routerJs = path.join(distDir, 'router.js')\n    const routerMap = path.join(distDir, 'router.js.map')\n\n    archiver.append(fs.readFileSync(routerJs), 'router.js')\n    archiver.append(fs.readFileSync(routerMap), 'router.js.map')\n    includeStaticFiles(steps, this.builder, archiver)\n\n    const { compressedSize, uncompressedSize } = await archiver.finalize()\n\n    fs.unlinkSync(tsRouter)\n    fs.unlinkSync(routerJs)\n    fs.unlinkSync(routerMap)\n\n    return { compressedSize, uncompressedSize, path: zipName }\n  }\n\n  async build(step: Step): Promise<void> {\n    const relativeFilePath = step.filePath.replace(this.builder.projectDir, '')\n    const entrypointPath = relativeFilePath.replace(/(.*)\\.(ts|js)$/, '$1.js')\n    const entrypointMapPath = entrypointPath.replace(/(.*)\\.js$/, '$1.js.map')\n    const bundlePath = path.join('node', entrypointPath.replace(/(.*)\\.js$/, '$1.zip'))\n    const outputJsFile = path.join(distDir, 'node', entrypointPath)\n    const outputMapFile = path.join(distDir, 'node', entrypointMapPath)\n\n    this.builder.registerStep({ entrypointPath, bundlePath, step, type: 'node' })\n    this.listener.onBuildStart(step)\n\n    try {\n      const userConfig = await this.loadEsbuildConfig()\n      const defaultConfig: esbuild.BuildOptions = {\n        entryPoints: [step.filePath],\n        bundle: true,\n        sourcemap: true,\n        outfile: outputJsFile,\n        platform: 'node',\n      }\n\n      await esbuild.build(userConfig ? { ...defaultConfig, ...userConfig } : defaultConfig)\n\n      const archiver = new Archiver(path.join(distDir, bundlePath))\n\n      archiver.append(fs.readFileSync(outputJsFile), entrypointPath)\n      archiver.append(fs.readFileSync(outputMapFile), entrypointMapPath)\n      includeStaticFiles([step], this.builder, archiver)\n\n      const { compressedSize, uncompressedSize } = await archiver.finalize()\n\n      fs.unlinkSync(outputJsFile)\n      fs.unlinkSync(outputMapFile)\n\n      this.builder.recordStepSize(step, compressedSize, uncompressedSize)\n      this.listener.onBuildEnd(step, compressedSize)\n    } catch (err) {\n      this.listener.onBuildError(step, err as Error)\n      throw err\n    }\n  }\n}\n"],"mappings":"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"}