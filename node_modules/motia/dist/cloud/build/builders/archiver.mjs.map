{"version":3,"file":"archiver.mjs","names":[],"sources":["../../../../src/cloud/build/builders/archiver.ts"],"sourcesContent":["import archiver from 'archiver'\nimport fs from 'fs'\nimport path from 'path'\n\nexport interface ArchiveResult {\n  compressedSize: number\n  uncompressedSize: number\n}\n\nexport class Archiver {\n  private readonly archive: archiver.Archiver\n  private readonly outputStream: fs.WriteStream\n  private uncompressedSize: number = 0\n\n  constructor(filePath: string) {\n    this.archive = archiver('zip', { zlib: { level: 9 } })\n    this.outputStream = fs.createWriteStream(filePath)\n    this.archive.pipe(this.outputStream)\n  }\n\n  appendDirectory(sourcePath: string, targetPath: string) {\n    try {\n      const stat = fs.statSync(sourcePath)\n\n      if (!stat.isDirectory()) {\n        return\n      }\n\n      this.uncompressedSize += this.calculateDirectorySize(sourcePath)\n\n      this.archive.directory(sourcePath, targetPath === '/' ? false : targetPath)\n    } catch (_error) {}\n  }\n\n  private calculateDirectorySize(dirPath: string): number {\n    let totalSize = 0\n\n    try {\n      const items = fs.readdirSync(dirPath)\n\n      for (const item of items) {\n        const fullPath = path.join(dirPath, item)\n\n        try {\n          const stat = fs.statSync(fullPath)\n\n          if (stat.isDirectory()) {\n            totalSize += this.calculateDirectorySize(fullPath)\n          } else {\n            totalSize += stat.size\n          }\n        } catch (_error) {}\n      }\n    } catch (_error) {}\n\n    return totalSize\n  }\n\n  append(stream: fs.ReadStream | string | Buffer, filePath: string) {\n    if (typeof stream === 'string') {\n      this.uncompressedSize += Buffer.byteLength(stream, 'utf8')\n      this.archive.append(stream, { name: filePath })\n    } else if (Buffer.isBuffer(stream)) {\n      this.uncompressedSize += stream.length\n      this.archive.append(stream, { name: filePath })\n    } else {\n      const stats = fs.statSync(stream.path as string)\n      this.uncompressedSize += stats.size\n      this.archive.append(stream, { name: filePath })\n    }\n  }\n\n  async finalize(): Promise<ArchiveResult> {\n    return new Promise<ArchiveResult>((resolve, reject) => {\n      this.outputStream.on('close', () => {\n        resolve({\n          compressedSize: this.archive.pointer(),\n          uncompressedSize: this.uncompressedSize,\n        })\n      })\n      this.outputStream.on('error', reject)\n      this.archive.finalize()\n    })\n  }\n}\n"],"mappings":";;;;;AASA,IAAa,WAAb,MAAsB;CAKpB,YAAY,UAAkB;0BAFK;AAGjC,OAAK,UAAU,SAAS,OAAO,EAAE,MAAM,EAAE,OAAO,GAAG,EAAE,CAAC;AACtD,OAAK,eAAe,GAAG,kBAAkB,SAAS;AAClD,OAAK,QAAQ,KAAK,KAAK,aAAa;;CAGtC,gBAAgB,YAAoB,YAAoB;AACtD,MAAI;AAGF,OAAI,CAFS,GAAG,SAAS,WAAW,CAE1B,aAAa,CACrB;AAGF,QAAK,oBAAoB,KAAK,uBAAuB,WAAW;AAEhE,QAAK,QAAQ,UAAU,YAAY,eAAe,MAAM,QAAQ,WAAW;WACpE,QAAQ;;CAGnB,AAAQ,uBAAuB,SAAyB;EACtD,IAAI,YAAY;AAEhB,MAAI;GACF,MAAM,QAAQ,GAAG,YAAY,QAAQ;AAErC,QAAK,MAAM,QAAQ,OAAO;IACxB,MAAM,WAAW,KAAK,KAAK,SAAS,KAAK;AAEzC,QAAI;KACF,MAAM,OAAO,GAAG,SAAS,SAAS;AAElC,SAAI,KAAK,aAAa,CACpB,cAAa,KAAK,uBAAuB,SAAS;SAElD,cAAa,KAAK;aAEb,QAAQ;;WAEZ,QAAQ;AAEjB,SAAO;;CAGT,OAAO,QAAyC,UAAkB;AAChE,MAAI,OAAO,WAAW,UAAU;AAC9B,QAAK,oBAAoB,OAAO,WAAW,QAAQ,OAAO;AAC1D,QAAK,QAAQ,OAAO,QAAQ,EAAE,MAAM,UAAU,CAAC;aACtC,OAAO,SAAS,OAAO,EAAE;AAClC,QAAK,oBAAoB,OAAO;AAChC,QAAK,QAAQ,OAAO,QAAQ,EAAE,MAAM,UAAU,CAAC;SAC1C;GACL,MAAM,QAAQ,GAAG,SAAS,OAAO,KAAe;AAChD,QAAK,oBAAoB,MAAM;AAC/B,QAAK,QAAQ,OAAO,QAAQ,EAAE,MAAM,UAAU,CAAC;;;CAInD,MAAM,WAAmC;AACvC,SAAO,IAAI,SAAwB,SAAS,WAAW;AACrD,QAAK,aAAa,GAAG,eAAe;AAClC,YAAQ;KACN,gBAAgB,KAAK,QAAQ,SAAS;KACtC,kBAAkB,KAAK;KACxB,CAAC;KACF;AACF,QAAK,aAAa,GAAG,SAAS,OAAO;AACrC,QAAK,QAAQ,UAAU;IACvB"}