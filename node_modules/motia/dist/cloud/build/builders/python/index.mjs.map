{"version":3,"file":"index.mjs","names":["builder: Builder","listener: BuildListener"],"sources":["../../../../../src/cloud/build/builders/python/index.ts"],"sourcesContent":["import type { ApiRouteConfig, Step } from '@motiadev/core'\nimport fs from 'fs'\nimport path from 'path'\nimport { fileURLToPath } from 'url'\nimport { activatePythonVenv, getSitePackagesPath } from '../../../../utils/activate-python-env'\nimport { distDir } from '../../../new-deployment/constants'\nimport type { BuildListener } from '../../../new-deployment/listeners/listener.types'\nimport type { Builder, RouterBuildResult, StepBuilder } from '../../builder'\nimport { Archiver } from '../archiver'\nimport { includeStaticFiles } from '../include-static-files'\nimport { extractPythonData } from './python-data/extract-python-data'\nimport { readRequirements } from './python-data/read-requirements'\nimport { resolveDepNames } from './python-data/resolve-dep-names'\nimport { UvPackager } from './uv-packager'\n\nexport class PythonBuilder implements StepBuilder {\n  private packager: UvPackager\n\n  constructor(\n    private readonly builder: Builder,\n    private readonly listener: BuildListener,\n  ) {\n    activatePythonVenv({ baseDir: this.builder.projectDir })\n    this.packager = new UvPackager()\n  }\n\n  async buildApiSteps(steps: Step<ApiRouteConfig>[]): Promise<RouterBuildResult> {\n    const zipName = 'router-python.zip'\n    const archive = new Archiver(path.join(distDir, zipName))\n    const bundleDir = path.join(distDir, 'python', 'router')\n\n    try {\n      fs.mkdirSync(bundleDir, { recursive: true })\n\n      const routerTemplate = this.createRouterTemplate(steps)\n      archive.append(routerTemplate, 'router.py')\n\n      await this.generatePackage(bundleDir, 'router.py', archive, routerTemplate)\n\n      includeStaticFiles(steps, this.builder, archive)\n\n      const { compressedSize, uncompressedSize } = await archive.finalize()\n\n      return { compressedSize, uncompressedSize, path: zipName }\n    } catch (error) {\n      throw new Error(`Failed to build Python API router: ${error}`)\n    } finally {\n      this.cleanup(bundleDir)\n    }\n  }\n\n  async build(step: Step): Promise<void> {\n    const entrypointPath = step.filePath.replace(this.builder.projectDir, '')\n    const bundlePath = path.join('python', entrypointPath.replace(/(.*)\\.py$/, '$1.zip'))\n    const bundleDir = path.join(distDir, 'python', entrypointPath.replace(/(.*)\\.py$/, '$1'))\n    const outfile = path.join(distDir, bundlePath)\n\n    this.builder.registerStep({ entrypointPath, bundlePath, step, type: 'python' })\n    this.listener.onBuildStart(step)\n\n    try {\n      fs.mkdirSync(path.dirname(outfile), { recursive: true })\n      fs.mkdirSync(bundleDir, { recursive: true })\n      const archive = new Archiver(outfile)\n\n      await this.generatePackage(bundleDir, entrypointPath, archive)\n\n      // Include static files\n      includeStaticFiles([step], this.builder, archive)\n\n      const { compressedSize, uncompressedSize } = await archive.finalize()\n      this.builder.recordStepSize(step, compressedSize, uncompressedSize)\n      this.listener.onBuildEnd(step, compressedSize)\n    } catch (err) {\n      this.listener.onBuildError(step, err as Error)\n      throw err\n    } finally {\n      this.cleanup(bundleDir)\n    }\n  }\n\n  private async generatePackage(bundleDir: string, entrypointPath: string, archive: Archiver, fileContent?: string) {\n    const requirementsFile = path.join(this.builder.projectDir, 'requirements.txt')\n    const requirements = readRequirements(requirementsFile)\n    const sitePackagesPath = getSitePackagesPath({ baseDir: this.builder.projectDir })\n    const dependenciesMap = resolveDepNames(Object.keys(requirements), sitePackagesPath)\n\n    const { externalDependencies, files } = extractPythonData(\n      this.builder.projectDir,\n      entrypointPath,\n      dependenciesMap,\n      fileContent,\n    )\n\n    // move files\n    for (const file of files) {\n      fs.mkdirSync(path.dirname(path.join(bundleDir, file)), { recursive: true })\n\n      if (fileContent && file === entrypointPath) {\n        fs.writeFileSync(path.join(bundleDir, file), fileContent)\n      } else {\n        fs.copyFileSync(path.join(this.builder.projectDir, file), path.join(bundleDir, file))\n      }\n    }\n\n    const dependencies = Object.values(externalDependencies)\n\n    if (dependencies.length > 0) {\n      // create requirements.txt\n      const requirementsContent = Object.values(externalDependencies)\n        .map((dependency) => requirements[dependency])\n        .join('\\n')\n\n      fs.writeFileSync(path.join(bundleDir, 'requirements.txt'), requirementsContent)\n      await this.packager.packageDependencies(bundleDir)\n    }\n\n    // zip entire folder\n    archive.appendDirectory(bundleDir, '/')\n  }\n\n  private cleanup(bundleDir: string): void {\n    if (bundleDir && fs.existsSync(bundleDir)) {\n      try {\n        fs.rmSync(bundleDir, { recursive: true, force: true })\n      } catch (_error) {\n        // Ignore cleanup errors\n      }\n    }\n  }\n\n  private createRouterTemplate(steps: Step<ApiRouteConfig>[]): string {\n    const imports = steps\n      .map(\n        (step, index) =>\n          `from ${this.getModuleName(step)} import handler as route${index}_handler, config as route${index}_config`,\n      )\n      .join('\\n')\n\n    const routerPaths = steps\n      .map((step, index) => {\n        const method = step.config.method.toUpperCase()\n        const path = step.config.path\n        return `    '${method} ${path}': RouterPath('${step.config.name}', '${step.config.method.toLowerCase()}', route${index}_handler, route${index}_config)`\n      })\n      .join(',\\n')\n\n    const __dirname = path.dirname(fileURLToPath(import.meta.url))\n\n    return fs\n      .readFileSync(path.join(__dirname, 'router_template.py'), 'utf-8')\n      .replace('# {{imports}}', imports)\n      .replace('    # {{router paths}}', routerPaths)\n  }\n\n  private getModuleName(step: Step): string {\n    // return step path\n    return step.filePath.replace(this.builder.projectDir, '').substring(1).replace(/\\.py$/, '').replace(/[\\\\/]/g, '.')\n  }\n}\n"],"mappings":"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"}