{"version":3,"file":"uv-packager.mjs","names":["defaultUvConfig: UvPackageConfig","config: UvPackageConfig"],"sources":["../../../../../src/cloud/build/builders/python/uv-packager.ts"],"sourcesContent":["import { spawn } from 'child_process'\nimport path from 'path'\n\nexport interface UvPackageConfig {\n  pythonVersion?: string\n  platform?: string\n  onlyBinary?: boolean\n}\n\nexport const defaultUvConfig: UvPackageConfig = {\n  pythonVersion: process.env.MOTIA_PYTHON_VERSION || '3.13',\n  platform: process.env.MOTIA_PLATFORM || 'x86_64-manylinux2014',\n  onlyBinary: process.env.MOTIA_ONLY_BINARY !== 'false',\n}\n\nexport class UvPackager {\n  constructor(private readonly config: UvPackageConfig = defaultUvConfig) {}\n\n  async packageDependencies(cwd: string): Promise<void> {\n    const requirementsFile = path.join(cwd, 'requirements.txt')\n    const args = [\n      'pip',\n      'install',\n      '--target',\n      cwd,\n      '--requirement',\n      requirementsFile,\n      '--python-version',\n      this.config.pythonVersion || '3.13',\n      '--python-platform',\n      this.config.platform || 'x86_64-manylinux2014',\n    ]\n\n    if (this.config.onlyBinary) {\n      args.push('--only-binary=:all:')\n    }\n\n    await this.runCommand('uv', args, { cwd })\n  }\n\n  private async runCommand(\n    command: string,\n    args: string[],\n    options?: {\n      cwd?: string\n      showOutput?: boolean\n    },\n  ): Promise<string> {\n    return new Promise((resolve, reject) => {\n      const child = spawn(command, args, {\n        cwd: options?.cwd,\n        stdio: ['pipe', 'pipe', 'pipe'],\n      })\n\n      let stdout = ''\n      let stderr = ''\n\n      child.stdout?.on('data', (data) => {\n        stdout += data.toString()\n        if (options?.showOutput) {\n          process.stdout.write(data)\n        }\n      })\n\n      child.stderr?.on('data', (data) => {\n        stderr += data.toString()\n      })\n\n      child.on('close', (code) => {\n        if (code === 0) {\n          resolve(stdout)\n        } else {\n          const errorPrefix = `Command '${command}'`\n          reject(new Error(`${errorPrefix} failed: ${stderr || stdout}`))\n        }\n      })\n\n      child.on('error', (error) => {\n        reject(new Error(`Failed to spawn ${command}: ${error.message}`))\n      })\n    })\n  }\n}\n"],"mappings":";;;;AASA,MAAaA,kBAAmC;CAC9C,eAAe,QAAQ,IAAI,wBAAwB;CACnD,UAAU,QAAQ,IAAI,kBAAkB;CACxC,YAAY,QAAQ,IAAI,sBAAsB;CAC/C;AAED,IAAa,aAAb,MAAwB;CACtB,YAAY,AAAiBC,SAA0B,iBAAiB;EAA3C;;CAE7B,MAAM,oBAAoB,KAA4B;EAEpD,MAAM,OAAO;GACX;GACA;GACA;GACA;GACA;GANuB,KAAK,KAAK,KAAK,mBAAmB;GAQzD;GACA,KAAK,OAAO,iBAAiB;GAC7B;GACA,KAAK,OAAO,YAAY;GACzB;AAED,MAAI,KAAK,OAAO,WACd,MAAK,KAAK,sBAAsB;AAGlC,QAAM,KAAK,WAAW,MAAM,MAAM,EAAE,KAAK,CAAC;;CAG5C,MAAc,WACZ,SACA,MACA,SAIiB;AACjB,SAAO,IAAI,SAAS,SAAS,WAAW;GACtC,MAAM,QAAQ,MAAM,SAAS,MAAM;IACjC,KAAK,SAAS;IACd,OAAO;KAAC;KAAQ;KAAQ;KAAO;IAChC,CAAC;GAEF,IAAI,SAAS;GACb,IAAI,SAAS;AAEb,SAAM,QAAQ,GAAG,SAAS,SAAS;AACjC,cAAU,KAAK,UAAU;AACzB,QAAI,SAAS,WACX,SAAQ,OAAO,MAAM,KAAK;KAE5B;AAEF,SAAM,QAAQ,GAAG,SAAS,SAAS;AACjC,cAAU,KAAK,UAAU;KACzB;AAEF,SAAM,GAAG,UAAU,SAAS;AAC1B,QAAI,SAAS,EACX,SAAQ,OAAO;SACV;KACL,MAAM,cAAc,YAAY,QAAQ;AACxC,4BAAO,IAAI,MAAM,GAAG,YAAY,WAAW,UAAU,SAAS,CAAC;;KAEjE;AAEF,SAAM,GAAG,UAAU,UAAU;AAC3B,2BAAO,IAAI,MAAM,mBAAmB,QAAQ,IAAI,MAAM,UAAU,CAAC;KACjE;IACF"}