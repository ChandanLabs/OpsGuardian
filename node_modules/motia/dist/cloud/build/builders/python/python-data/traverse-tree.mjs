import { convertImportToPath } from "./convert-import-path.mjs";
import { PythonFileNotFoundError, PythonImportNotFoundError } from "./python-errors.mjs";
import { getDependenciesFromFile } from "./get-dependencies-from-file.mjs";
import fs from "fs";
import path from "path";

//#region src/cloud/build/builders/python/python-data/traverse-tree.ts
const traverseTree = (rootDir, filePath, result, dependenciesMap, fileContent) => {
	const fileAbsolutePath = path.join(rootDir, filePath);
	if (!fileContent && !fs.existsSync(fileAbsolutePath)) throw new PythonFileNotFoundError(filePath);
	const initPath = path.resolve(path.dirname(fileAbsolutePath), "__init__.py");
	if (fs.existsSync(initPath)) result.files.add(initPath.replace(rootDir, ""));
	const dependencies = getDependenciesFromFile(fileContent || fs.readFileSync(fileAbsolutePath, "utf8"), filePath, dependenciesMap);
	result.files.add(filePath);
	dependencies.externalDependencies.forEach((dependency) => {
		result.externalDependencies.add(dependency);
	});
	dependencies.standardLibDependencies.forEach((dependency) => {
		result.standardLibDependencies.add(dependency);
	});
	for (const dependency of dependencies.projectDependencies) {
		const pythonPath = convertImportToPath(dependency);
		const fileFolder = path.dirname(fileAbsolutePath);
		const dependencyPath = path.resolve(fileFolder, `${pythonPath}.py`).replace(rootDir, "");
		if (!result.files.has(dependencyPath)) try {
			traverseTree(rootDir, dependencyPath, result, dependenciesMap);
		} catch (error) {
			if (error instanceof PythonFileNotFoundError) {
				if (dependency[0] !== ".") try {
					return traverseTree(rootDir, path.resolve(rootDir, `${pythonPath}.py`).replace(rootDir, ""), result, dependenciesMap);
				} catch (_error) {}
				throw new PythonImportNotFoundError(filePath, dependency);
			}
			throw error;
		}
	}
};

//#endregion
export { traverseTree };
//# sourceMappingURL=traverse-tree.mjs.map