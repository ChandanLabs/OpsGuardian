{"version":3,"file":"traverse-tree.mjs","names":[],"sources":["../../../../../../src/cloud/build/builders/python/python-data/traverse-tree.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport { convertImportToPath } from './convert-import-path'\nimport { getDependenciesFromFile } from './get-dependencies-from-file'\nimport { PythonFileNotFoundError, PythonImportNotFoundError } from './python-errors'\n\nexport type TraverseTreeResult = {\n  standardLibDependencies: Set<string>\n  externalDependencies: Set<string>\n  files: Set<string> // relative to rootDir\n}\n\nexport const traverseTree = (\n  rootDir: string,\n  filePath: string,\n  result: TraverseTreeResult,\n  dependenciesMap: Record<string, string>,\n  // optional\n  fileContent?: string,\n): void => {\n  const fileAbsolutePath = path.join(rootDir, filePath)\n\n  if (!fileContent && !fs.existsSync(fileAbsolutePath)) {\n    throw new PythonFileNotFoundError(filePath)\n  }\n\n  const initPath = path.resolve(path.dirname(fileAbsolutePath), '__init__.py')\n\n  if (fs.existsSync(initPath)) {\n    result.files.add(initPath.replace(rootDir, ''))\n  }\n\n  const content = fileContent || fs.readFileSync(fileAbsolutePath, 'utf8')\n  const dependencies = getDependenciesFromFile(content, filePath, dependenciesMap)\n\n  result.files.add(filePath)\n\n  dependencies.externalDependencies.forEach((dependency) => {\n    result.externalDependencies.add(dependency)\n  })\n  dependencies.standardLibDependencies.forEach((dependency) => {\n    result.standardLibDependencies.add(dependency)\n  })\n\n  for (const dependency of dependencies.projectDependencies) {\n    const pythonPath = convertImportToPath(dependency)\n    const fileFolder = path.dirname(fileAbsolutePath)\n    const dependencyFilePath = path.resolve(fileFolder, `${pythonPath}.py`)\n    const dependencyPath = dependencyFilePath.replace(rootDir, '')\n\n    if (!result.files.has(dependencyPath)) {\n      try {\n        traverseTree(rootDir, dependencyPath, result, dependenciesMap)\n      } catch (error) {\n        if (error instanceof PythonFileNotFoundError) {\n          if (dependency[0] !== '.') {\n            // try root folder\n            try {\n              const rootDependencyFilePath = path.resolve(rootDir, `${pythonPath}.py`).replace(rootDir, '')\n              return traverseTree(rootDir, rootDependencyFilePath, result, dependenciesMap)\n            } catch (_error) {\n              // let it throw\n            }\n          }\n\n          throw new PythonImportNotFoundError(filePath, dependency)\n        }\n\n        throw error\n      }\n    }\n  }\n}\n"],"mappings":";;;;;;;AAYA,MAAa,gBACX,SACA,UACA,QACA,iBAEA,gBACS;CACT,MAAM,mBAAmB,KAAK,KAAK,SAAS,SAAS;AAErD,KAAI,CAAC,eAAe,CAAC,GAAG,WAAW,iBAAiB,CAClD,OAAM,IAAI,wBAAwB,SAAS;CAG7C,MAAM,WAAW,KAAK,QAAQ,KAAK,QAAQ,iBAAiB,EAAE,cAAc;AAE5E,KAAI,GAAG,WAAW,SAAS,CACzB,QAAO,MAAM,IAAI,SAAS,QAAQ,SAAS,GAAG,CAAC;CAIjD,MAAM,eAAe,wBADL,eAAe,GAAG,aAAa,kBAAkB,OAAO,EAClB,UAAU,gBAAgB;AAEhF,QAAO,MAAM,IAAI,SAAS;AAE1B,cAAa,qBAAqB,SAAS,eAAe;AACxD,SAAO,qBAAqB,IAAI,WAAW;GAC3C;AACF,cAAa,wBAAwB,SAAS,eAAe;AAC3D,SAAO,wBAAwB,IAAI,WAAW;GAC9C;AAEF,MAAK,MAAM,cAAc,aAAa,qBAAqB;EACzD,MAAM,aAAa,oBAAoB,WAAW;EAClD,MAAM,aAAa,KAAK,QAAQ,iBAAiB;EAEjD,MAAM,iBADqB,KAAK,QAAQ,YAAY,GAAG,WAAW,KAAK,CAC7B,QAAQ,SAAS,GAAG;AAE9D,MAAI,CAAC,OAAO,MAAM,IAAI,eAAe,CACnC,KAAI;AACF,gBAAa,SAAS,gBAAgB,QAAQ,gBAAgB;WACvD,OAAO;AACd,OAAI,iBAAiB,yBAAyB;AAC5C,QAAI,WAAW,OAAO,IAEpB,KAAI;AAEF,YAAO,aAAa,SADW,KAAK,QAAQ,SAAS,GAAG,WAAW,KAAK,CAAC,QAAQ,SAAS,GAAG,EACxC,QAAQ,gBAAgB;aACtE,QAAQ;AAKnB,UAAM,IAAI,0BAA0B,UAAU,WAAW;;AAG3D,SAAM"}