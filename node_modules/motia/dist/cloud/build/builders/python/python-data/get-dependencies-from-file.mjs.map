{"version":3,"file":"get-dependencies-from-file.mjs","names":["dependencies: Dependencies"],"sources":["../../../../../../src/cloud/build/builders/python/python-data/get-dependencies-from-file.ts"],"sourcesContent":["import { type ANTLRErrorListener, CharStreams, CommonTokenStream, type Token } from 'antlr4ts'\nimport { createVisitor } from 'python-ast'\nimport { Python3Lexer } from 'python-ast/dist/parser/Python3Lexer.js'\nimport { Python3Parser } from 'python-ast/dist/parser/Python3Parser.js'\nimport { STANDARD_LIB_MODULES } from './constants'\nimport { PythonCompilationError } from './python-errors'\n\nfunction parse(source: string, sourceName: string) {\n  const chars = CharStreams.fromString(source, sourceName)\n  const lexer = new Python3Lexer(chars)\n  const tokens = new CommonTokenStream(lexer)\n  const parser = new Python3Parser(tokens)\n\n  // Remove default console error listeners\n  parser.removeErrorListeners()\n\n  const listener: ANTLRErrorListener<Token> = {\n    syntaxError: (_recognizer, _offendingSymbol, line, charPositionInLine, msg) => {\n      throw new PythonCompilationError(sourceName, `${msg} at line ${line}:${charPositionInLine}`)\n    },\n  }\n\n  // Add your custom one\n  parser.addErrorListener(listener)\n\n  return parser.file_input()\n}\n\nexport type Dependencies = {\n  standardLibDependencies: Set<string>\n  externalDependencies: Set<string>\n  projectDependencies: Set<string>\n}\n\nexport const getDependenciesFromFile = (\n  content: string,\n  path: string,\n  externalDependenciesMap: Record<string, string>,\n): Dependencies => {\n  const result = parse(content + '\\n', path)\n  const modulesSet = new Set<string>()\n\n  createVisitor({\n    visitImport_from: (ctx) => {\n      const name = ctx.dotted_name()\n\n      if (name) {\n        let dots = ctx\n          .DOT()\n          .map((dot) => dot.text)\n          .join('')\n\n        const dotsText = ctx.getChild(1)?.text ?? ''\n\n        // when ...package the parser doesn't return as ctx.DOT() â€” we need to handle it manually\n        if (!dots && dotsText[0] === '.') {\n          dots = dotsText\n        }\n\n        modulesSet.add(dots.concat(name.text))\n      }\n    },\n    visitImport_name: (ctx) => {\n      const names = ctx.dotted_as_names()\n      modulesSet.add(names.dotted_as_name(0)?.getChild(0)?.text ?? names.text)\n    },\n  }).visit(result)\n\n  const dependencies: Dependencies = {\n    standardLibDependencies: new Set(),\n    externalDependencies: new Set(),\n    projectDependencies: new Set(),\n  }\n\n  for (const module of modulesSet) {\n    const [moduleName] = module.split('.')\n\n    if (module[0] === '.') {\n      dependencies.projectDependencies.add(module)\n    } else if (STANDARD_LIB_MODULES.has(module)) {\n      dependencies.standardLibDependencies.add(module)\n    } else if (externalDependenciesMap[module] || externalDependenciesMap[moduleName]) {\n      dependencies.externalDependencies.add(module)\n    } else {\n      dependencies.projectDependencies.add(module)\n    }\n  }\n\n  return dependencies\n}\n"],"mappings":";;;;;;;;AAOA,SAAS,MAAM,QAAgB,YAAoB;CAIjD,MAAM,SAAS,IAAI,cADJ,IAAI,kBADL,IAAI,aADJ,YAAY,WAAW,QAAQ,WAAW,CACnB,CACM,CACH;AAGxC,QAAO,sBAAsB;AAS7B,QAAO,iBAPqC,EAC1C,cAAc,aAAa,kBAAkB,MAAM,oBAAoB,QAAQ;AAC7E,QAAM,IAAI,uBAAuB,YAAY,GAAG,IAAI,WAAW,KAAK,GAAG,qBAAqB;IAE/F,CAGgC;AAEjC,QAAO,OAAO,YAAY;;AAS5B,MAAa,2BACX,SACA,MACA,4BACiB;CACjB,MAAM,SAAS,MAAM,UAAU,MAAM,KAAK;CAC1C,MAAM,6BAAa,IAAI,KAAa;AAEpC,eAAc;EACZ,mBAAmB,QAAQ;GACzB,MAAM,OAAO,IAAI,aAAa;AAE9B,OAAI,MAAM;IACR,IAAI,OAAO,IACR,KAAK,CACL,KAAK,QAAQ,IAAI,KAAK,CACtB,KAAK,GAAG;IAEX,MAAM,WAAW,IAAI,SAAS,EAAE,EAAE,QAAQ;AAG1C,QAAI,CAAC,QAAQ,SAAS,OAAO,IAC3B,QAAO;AAGT,eAAW,IAAI,KAAK,OAAO,KAAK,KAAK,CAAC;;;EAG1C,mBAAmB,QAAQ;GACzB,MAAM,QAAQ,IAAI,iBAAiB;AACnC,cAAW,IAAI,MAAM,eAAe,EAAE,EAAE,SAAS,EAAE,EAAE,QAAQ,MAAM,KAAK;;EAE3E,CAAC,CAAC,MAAM,OAAO;CAEhB,MAAMA,eAA6B;EACjC,yCAAyB,IAAI,KAAK;EAClC,sCAAsB,IAAI,KAAK;EAC/B,qCAAqB,IAAI,KAAK;EAC/B;AAED,MAAK,MAAM,UAAU,YAAY;EAC/B,MAAM,CAAC,cAAc,OAAO,MAAM,IAAI;AAEtC,MAAI,OAAO,OAAO,IAChB,cAAa,oBAAoB,IAAI,OAAO;WACnC,qBAAqB,IAAI,OAAO,CACzC,cAAa,wBAAwB,IAAI,OAAO;WACvC,wBAAwB,WAAW,wBAAwB,YACpE,cAAa,qBAAqB,IAAI,OAAO;MAE7C,cAAa,oBAAoB,IAAI,OAAO;;AAIhD,QAAO"}