{"version":3,"file":"builder.mjs","names":["projectDir: string","listener: BuildListener"],"sources":["../../../src/cloud/build/builder.ts"],"sourcesContent":["import type { ApiRouteConfig, Step, StepConfig, Stream } from '@motiadev/core'\nimport type { BuildListener } from '../new-deployment/listeners/listener.types'\n\nexport type StepType = 'node' | 'python' | 'noop' | 'unknown'\n\nexport type BuildStepConfig = {\n  type: StepType\n  entrypointPath: string\n  config: StepConfig\n  filePath: string\n}\n\nexport type BuildStreamConfig = {\n  name: string\n  storageType: 'default' | 'custom'\n}\n\nexport type BuildStepsConfig = Record<string, BuildStepConfig>\nexport type BuildStreamsConfig = Record<string, BuildStreamConfig>\nexport type BuildRoutersConfig = Partial<Record<StepType, string>>\nexport type StepsConfigFile = {\n  steps: BuildStepsConfig\n  streams: BuildStreamsConfig\n  routers: BuildRoutersConfig\n}\n\nexport interface RouterBuildResult {\n  compressedSize: number\n  uncompressedSize: number\n  path: string\n}\n\nexport interface StepBuilder {\n  build(step: Step): Promise<void>\n  buildApiSteps(steps: Step<ApiRouteConfig>[]): Promise<RouterBuildResult>\n}\n\nexport class Builder {\n  public readonly stepsConfig: BuildStepsConfig\n  public readonly streamsConfig: BuildStreamsConfig\n  public routersConfig: BuildRoutersConfig\n  public readonly stepCompressedSizes: Map<string, number> = new Map()\n  public readonly stepUncompressedSizes: Map<string, number> = new Map()\n  public readonly routerCompressedSizes: Map<string, number> = new Map()\n  public readonly routerUncompressedSizes: Map<string, number> = new Map()\n  public modulegraphInstalled: boolean = false\n  private readonly builders: Map<string, StepBuilder> = new Map()\n\n  constructor(\n    public readonly projectDir: string,\n    private readonly listener: BuildListener,\n  ) {\n    this.stepsConfig = {}\n    this.streamsConfig = {}\n    this.routersConfig = {}\n  }\n\n  registerBuilder(type: string, builder: StepBuilder) {\n    this.builders.set(type, builder)\n  }\n\n  registerStateStream(stream: Stream) {\n    this.listener.onStreamCreated(stream)\n\n    this.streamsConfig[stream.config.name] = {\n      name: stream.config.name,\n      storageType: stream.config.baseConfig.storageType,\n    }\n  }\n\n  registerStep(args: { entrypointPath: string; bundlePath: string; step: Step; type: StepType }) {\n    this.stepsConfig[args.bundlePath] = {\n      type: args.type,\n      entrypointPath: args.entrypointPath,\n      config: args.step.config,\n      filePath: args.step.filePath,\n    }\n  }\n\n  recordStepSize(step: Step, compressedSize: number, uncompressedSize: number) {\n    this.stepCompressedSizes.set(step.filePath, compressedSize)\n    this.stepUncompressedSizes.set(step.filePath, uncompressedSize)\n  }\n\n  async buildStep(step: Step): Promise<void> {\n    const type = this.determineStepType(step)\n    const builder = this.builders.get(type)\n\n    if (!builder) {\n      this.listener.onBuildSkip(step, `No builder found for type: ${type}`)\n      return\n    }\n\n    try {\n      await builder.build(step)\n    } catch (err) {\n      this.listener.onBuildError(step, err as Error)\n      throw err\n    }\n  }\n\n  async buildApiSteps(steps: Step<ApiRouteConfig>[]): Promise<void> {\n    const nodeSteps = steps.filter((step) => this.determineStepType(step) === 'node')\n    const pythonSteps = steps.filter((step) => this.determineStepType(step) === 'python')\n    const nodeBuilder = this.builders.get('node')\n    const pythonBuilder = this.builders.get('python')\n\n    this.routersConfig = {}\n\n    if (nodeSteps.length > 0 && nodeBuilder) {\n      this.listener.onApiRouterBuilding('node')\n      const { compressedSize, uncompressedSize, path } = await nodeBuilder.buildApiSteps(nodeSteps)\n      this.listener.onApiRouterBuilt('node', compressedSize)\n      this.routersConfig.node = path\n      this.routerCompressedSizes.set('node', compressedSize)\n      this.routerUncompressedSizes.set('node', uncompressedSize)\n    }\n    if (pythonSteps.length > 0 && pythonBuilder) {\n      this.listener.onApiRouterBuilding('python')\n      const { compressedSize, uncompressedSize, path } = await pythonBuilder.buildApiSteps(pythonSteps)\n      this.listener.onApiRouterBuilt('python', compressedSize)\n      this.routersConfig.python = path\n      this.routerCompressedSizes.set('python', compressedSize)\n      this.routerUncompressedSizes.set('python', uncompressedSize)\n    }\n  }\n\n  private determineStepType(step: Step): string {\n    if (step.config.type === 'noop') {\n      return 'noop'\n    } else if (step.filePath.endsWith('.ts') || step.filePath.endsWith('.js')) {\n      return 'node'\n    } else if (step.filePath.endsWith('.py')) {\n      return 'python'\n    } else if (step.filePath.endsWith('.rb')) {\n      return 'ruby'\n    }\n    return 'unknown'\n  }\n}\n"],"mappings":";AAqCA,IAAa,UAAb,MAAqB;CAWnB,YACE,AAAgBA,YAChB,AAAiBC,UACjB;EAFgB;EACC;6CATwC,IAAI,KAAK;+CACP,IAAI,KAAK;+CACT,IAAI,KAAK;iDACP,IAAI,KAAK;8BACjC;kCACe,IAAI,KAAK;AAM7D,OAAK,cAAc,EAAE;AACrB,OAAK,gBAAgB,EAAE;AACvB,OAAK,gBAAgB,EAAE;;CAGzB,gBAAgB,MAAc,SAAsB;AAClD,OAAK,SAAS,IAAI,MAAM,QAAQ;;CAGlC,oBAAoB,QAAgB;AAClC,OAAK,SAAS,gBAAgB,OAAO;AAErC,OAAK,cAAc,OAAO,OAAO,QAAQ;GACvC,MAAM,OAAO,OAAO;GACpB,aAAa,OAAO,OAAO,WAAW;GACvC;;CAGH,aAAa,MAAkF;AAC7F,OAAK,YAAY,KAAK,cAAc;GAClC,MAAM,KAAK;GACX,gBAAgB,KAAK;GACrB,QAAQ,KAAK,KAAK;GAClB,UAAU,KAAK,KAAK;GACrB;;CAGH,eAAe,MAAY,gBAAwB,kBAA0B;AAC3E,OAAK,oBAAoB,IAAI,KAAK,UAAU,eAAe;AAC3D,OAAK,sBAAsB,IAAI,KAAK,UAAU,iBAAiB;;CAGjE,MAAM,UAAU,MAA2B;EACzC,MAAM,OAAO,KAAK,kBAAkB,KAAK;EACzC,MAAM,UAAU,KAAK,SAAS,IAAI,KAAK;AAEvC,MAAI,CAAC,SAAS;AACZ,QAAK,SAAS,YAAY,MAAM,8BAA8B,OAAO;AACrE;;AAGF,MAAI;AACF,SAAM,QAAQ,MAAM,KAAK;WAClB,KAAK;AACZ,QAAK,SAAS,aAAa,MAAM,IAAa;AAC9C,SAAM;;;CAIV,MAAM,cAAc,OAA8C;EAChE,MAAM,YAAY,MAAM,QAAQ,SAAS,KAAK,kBAAkB,KAAK,KAAK,OAAO;EACjF,MAAM,cAAc,MAAM,QAAQ,SAAS,KAAK,kBAAkB,KAAK,KAAK,SAAS;EACrF,MAAM,cAAc,KAAK,SAAS,IAAI,OAAO;EAC7C,MAAM,gBAAgB,KAAK,SAAS,IAAI,SAAS;AAEjD,OAAK,gBAAgB,EAAE;AAEvB,MAAI,UAAU,SAAS,KAAK,aAAa;AACvC,QAAK,SAAS,oBAAoB,OAAO;GACzC,MAAM,EAAE,gBAAgB,kBAAkB,SAAS,MAAM,YAAY,cAAc,UAAU;AAC7F,QAAK,SAAS,iBAAiB,QAAQ,eAAe;AACtD,QAAK,cAAc,OAAO;AAC1B,QAAK,sBAAsB,IAAI,QAAQ,eAAe;AACtD,QAAK,wBAAwB,IAAI,QAAQ,iBAAiB;;AAE5D,MAAI,YAAY,SAAS,KAAK,eAAe;AAC3C,QAAK,SAAS,oBAAoB,SAAS;GAC3C,MAAM,EAAE,gBAAgB,kBAAkB,SAAS,MAAM,cAAc,cAAc,YAAY;AACjG,QAAK,SAAS,iBAAiB,UAAU,eAAe;AACxD,QAAK,cAAc,SAAS;AAC5B,QAAK,sBAAsB,IAAI,UAAU,eAAe;AACxD,QAAK,wBAAwB,IAAI,UAAU,iBAAiB;;;CAIhE,AAAQ,kBAAkB,MAAoB;AAC5C,MAAI,KAAK,OAAO,SAAS,OACvB,QAAO;WACE,KAAK,SAAS,SAAS,MAAM,IAAI,KAAK,SAAS,SAAS,MAAM,CACvE,QAAO;WACE,KAAK,SAAS,SAAS,MAAM,CACtC,QAAO;WACE,KAAK,SAAS,SAAS,MAAM,CACtC,QAAO;AAET,SAAO"}