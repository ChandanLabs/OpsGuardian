{"version":3,"file":"endpoints.mjs","names":["error: any"],"sources":["../../src/cloud/endpoints.ts"],"sourcesContent":["import type { LockedData, MotiaServer } from '@motiadev/core'\nimport { randomUUID } from 'crypto'\nimport { buildValidation } from './build/build-validation'\nimport { build } from './new-deployment/build'\nimport { cloudApi } from './new-deployment/cloud-api/index'\nimport { StreamingDeploymentListener } from './new-deployment/listeners/streaming-deployment-listener'\nimport { type DeploymentData, DeploymentStreamManager } from './new-deployment/streams/deployment-stream'\nimport { uploadArtifacts } from './new-deployment/upload-artifacts'\n\nexport const deployEndpoints = (server: MotiaServer, lockedData: LockedData) => {\n  const { app } = server\n\n  // Criar stream de deployment se n√£o existir\n  const deploymentStream = lockedData.createStream<DeploymentData>({\n    filePath: '__motia.deployment',\n    hidden: true,\n    config: {\n      name: '__motia.deployment',\n      baseConfig: { storageType: 'default' },\n      schema: null as never,\n    },\n  })()\n\n  const deploymentManager = new DeploymentStreamManager(deploymentStream)\n\n  app.post('/__motia/cloud/deploy/start', async (req: any, res: any) => {\n    try {\n      const { deploymentToken, deploymentId, envs } = req.body\n      const sessionId = deploymentId || randomUUID()\n\n      if (!deploymentToken || !deploymentId) {\n        return res.status(400).json({\n          success: false,\n          error: 'deploymentToken and deploymentId are required',\n        })\n      }\n\n      await deploymentManager.startDeployment(sessionId)\n\n      const listener = new StreamingDeploymentListener(sessionId, deploymentStream)\n\n      res.json({\n        success: true,\n        message: 'Deployment started',\n        deploymentId: sessionId,\n        streamName: 'deployment-status',\n        groupId: 'deployments',\n        itemId: sessionId,\n      })\n\n      setImmediate(async () => {\n        try {\n          await listener.startBuildPhase()\n\n          const builder = await build(listener).catch(() => {\n            throw new Error('Build failed, check the logs for more information')\n          })\n\n          const isValid = buildValidation(builder, listener)\n\n          if (!isValid) {\n            await listener.onBuildErrors(listener.getErrors())\n            return\n          }\n\n          await listener.startUploadPhase()\n          await uploadArtifacts(builder, deploymentToken, listener)\n\n          await listener.startDeployPhase()\n          await cloudApi.startDeployment({\n            deploymentToken,\n            envVars: envs,\n            steps: builder.stepsConfig,\n            streams: builder.streamsConfig,\n            routers: builder.routersConfig,\n          })\n        } catch (error: any) {\n          console.error('Deployment failed:', error)\n\n          // Update stream with error\n          if (listener) {\n            await listener.onDeployError(error.message)\n          }\n        }\n      })\n    } catch (error: any) {\n      console.error('Failed to start deployment:', error)\n\n      res.status(500).json({ success: false, error: error.message })\n    }\n  })\n\n  app.get('/__motia/cloud/deploy/status/:deploymentId', async (req: any, res: any) => {\n    try {\n      const { deploymentId } = req.params\n      const deployment = await deploymentManager.getDeployment(deploymentId)\n\n      return deployment\n        ? res.status(200).json({ success: true, deployment })\n        : res.status(404).json({ success: false, error: 'Deployment not found' })\n    } catch (error: any) {\n      res.status(500).json({ success: false, error: error.message })\n    }\n  })\n}\n"],"mappings":";;;;;;;;;AASA,MAAa,mBAAmB,QAAqB,eAA2B;CAC9E,MAAM,EAAE,QAAQ;CAGhB,MAAM,mBAAmB,WAAW,aAA6B;EAC/D,UAAU;EACV,QAAQ;EACR,QAAQ;GACN,MAAM;GACN,YAAY,EAAE,aAAa,WAAW;GACtC,QAAQ;GACT;EACF,CAAC,EAAE;CAEJ,MAAM,oBAAoB,IAAI,wBAAwB,iBAAiB;AAEvE,KAAI,KAAK,+BAA+B,OAAO,KAAU,QAAa;AACpE,MAAI;GACF,MAAM,EAAE,iBAAiB,cAAc,SAAS,IAAI;GACpD,MAAM,YAAY,gBAAgB,YAAY;AAE9C,OAAI,CAAC,mBAAmB,CAAC,aACvB,QAAO,IAAI,OAAO,IAAI,CAAC,KAAK;IAC1B,SAAS;IACT,OAAO;IACR,CAAC;AAGJ,SAAM,kBAAkB,gBAAgB,UAAU;GAElD,MAAM,WAAW,IAAI,4BAA4B,WAAW,iBAAiB;AAE7E,OAAI,KAAK;IACP,SAAS;IACT,SAAS;IACT,cAAc;IACd,YAAY;IACZ,SAAS;IACT,QAAQ;IACT,CAAC;AAEF,gBAAa,YAAY;AACvB,QAAI;AACF,WAAM,SAAS,iBAAiB;KAEhC,MAAM,UAAU,MAAM,MAAM,SAAS,CAAC,YAAY;AAChD,YAAM,IAAI,MAAM,oDAAoD;OACpE;AAIF,SAAI,CAFY,gBAAgB,SAAS,SAAS,EAEpC;AACZ,YAAM,SAAS,cAAc,SAAS,WAAW,CAAC;AAClD;;AAGF,WAAM,SAAS,kBAAkB;AACjC,WAAM,gBAAgB,SAAS,iBAAiB,SAAS;AAEzD,WAAM,SAAS,kBAAkB;AACjC,WAAM,SAAS,gBAAgB;MAC7B;MACA,SAAS;MACT,OAAO,QAAQ;MACf,SAAS,QAAQ;MACjB,SAAS,QAAQ;MAClB,CAAC;aACKA,OAAY;AACnB,aAAQ,MAAM,sBAAsB,MAAM;AAG1C,SAAI,SACF,OAAM,SAAS,cAAc,MAAM,QAAQ;;KAG/C;WACKA,OAAY;AACnB,WAAQ,MAAM,+BAA+B,MAAM;AAEnD,OAAI,OAAO,IAAI,CAAC,KAAK;IAAE,SAAS;IAAO,OAAO,MAAM;IAAS,CAAC;;GAEhE;AAEF,KAAI,IAAI,8CAA8C,OAAO,KAAU,QAAa;AAClF,MAAI;GACF,MAAM,EAAE,iBAAiB,IAAI;GAC7B,MAAM,aAAa,MAAM,kBAAkB,cAAc,aAAa;AAEtE,UAAO,aACH,IAAI,OAAO,IAAI,CAAC,KAAK;IAAE,SAAS;IAAM;IAAY,CAAC,GACnD,IAAI,OAAO,IAAI,CAAC,KAAK;IAAE,SAAS;IAAO,OAAO;IAAwB,CAAC;WACpEA,OAAY;AACnB,OAAI,OAAO,IAAI,CAAC,KAAK;IAAE,SAAS;IAAO,OAAO,MAAM;IAAS,CAAC;;GAEhE"}