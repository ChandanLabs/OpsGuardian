{"version":3,"file":"deploy.mjs","names":[],"sources":["../../../src/cloud/cli/deploy.ts"],"sourcesContent":["import { buildValidation } from '../build/build-validation'\nimport { cloudCli } from '../cli'\nimport { handler, type Message } from '../config-utils'\nimport { build } from '../new-deployment/build'\nimport { cloudApi } from '../new-deployment/cloud-api/index'\nimport { deploy } from '../new-deployment/deploy'\nimport { CliListener } from '../new-deployment/listeners/cli-listener'\nimport { uploadArtifacts } from '../new-deployment/upload-artifacts'\nimport { loadEnvData } from '../new-deployment/utils/load-env-data'\n\ncloudCli\n  .command('deploy')\n  .description('Deploy a new version to Motia Cloud')\n  .requiredOption('-k, --api-key <key>', 'The API key for authentication', process.env.MOTIA_API_KEY)\n  .requiredOption('-v, --version-name <version>', 'The version to deploy')\n  .option('-p, --project-id <id>', 'Project ID (Deprecated)')\n  .option('-n, --project-name <name>', 'Project name (used when creating a new project)')\n  .option('-s, --environment-id <id>', 'Environment ID', process.env.MOTIA_ENVIRONMENT_ID)\n  .option('--environment-name <name>', 'Environment name')\n  .option('-e, --env-file <path>', 'Path to environment file')\n  .option('-d, --version-description <description>', 'The description of the version')\n  .option('-c, --ci', 'CI mode', process.env.CI)\n  .action(\n    handler(async (arg, context) => {\n      const listener = new CliListener(context)\n      const builder = await build(listener)\n      const isValid = buildValidation(builder, listener)\n\n      if (!isValid) {\n        process.exit(1)\n      }\n\n      context.log('build-completed', (message: Message) => message.tag('success').append('Build completed'))\n      context.log('creating-deployment', (message: Message) => message.tag('progress').append('Creating deployment...'))\n\n      const deployment = await cloudApi\n        .createDeployment({\n          apiKey: arg.apiKey,\n          projectName: arg.projectName,\n          environmentId: arg.environmentId,\n          environmentName: arg.environmentName,\n          versionName: arg.versionName,\n          versionDescription: arg.versionDescription,\n        })\n        .catch((error) => {\n          context.log('creating-deployment', (message: Message) =>\n            message.tag('failed').append('Failed to create deployment'),\n          )\n          throw error\n        })\n\n      context.log('creating-deployment', (message: Message) => message.tag('success').append('Deployment created'))\n      context.log('uploading-artifacts', (message: Message) => message.tag('progress').append('Uploading artifacts...'))\n\n      await uploadArtifacts(builder, deployment.deploymentToken, listener)\n\n      context.log('uploading-artifacts', (message: Message) => message.tag('success').append('Artifacts uploaded'))\n      context.log('starting-deployment', (message: Message) => message.tag('progress').append('Starting deployment...'))\n\n      await deploy({\n        envVars: loadEnvData(arg.envFile, context),\n        deploymentId: deployment.deploymentId,\n        deploymentToken: deployment.deploymentToken,\n        builder,\n        listener,\n        context,\n        ci: arg.ci,\n      })\n\n      context.exit(0)\n    }),\n  )\n"],"mappings":";;;;;;;;;;;AAUA,SACG,QAAQ,SAAS,CACjB,YAAY,sCAAsC,CAClD,eAAe,uBAAuB,kCAAkC,QAAQ,IAAI,cAAc,CAClG,eAAe,gCAAgC,wBAAwB,CACvE,OAAO,yBAAyB,0BAA0B,CAC1D,OAAO,6BAA6B,kDAAkD,CACtF,OAAO,6BAA6B,kBAAkB,QAAQ,IAAI,qBAAqB,CACvF,OAAO,6BAA6B,mBAAmB,CACvD,OAAO,yBAAyB,2BAA2B,CAC3D,OAAO,2CAA2C,iCAAiC,CACnF,OAAO,YAAY,WAAW,QAAQ,IAAI,GAAG,CAC7C,OACC,QAAQ,OAAO,KAAK,YAAY;CAC9B,MAAM,WAAW,IAAI,YAAY,QAAQ;CACzC,MAAM,UAAU,MAAM,MAAM,SAAS;AAGrC,KAAI,CAFY,gBAAgB,SAAS,SAAS,CAGhD,SAAQ,KAAK,EAAE;AAGjB,SAAQ,IAAI,oBAAoB,YAAqB,QAAQ,IAAI,UAAU,CAAC,OAAO,kBAAkB,CAAC;AACtG,SAAQ,IAAI,wBAAwB,YAAqB,QAAQ,IAAI,WAAW,CAAC,OAAO,yBAAyB,CAAC;CAElH,MAAM,aAAa,MAAM,SACtB,iBAAiB;EAChB,QAAQ,IAAI;EACZ,aAAa,IAAI;EACjB,eAAe,IAAI;EACnB,iBAAiB,IAAI;EACrB,aAAa,IAAI;EACjB,oBAAoB,IAAI;EACzB,CAAC,CACD,OAAO,UAAU;AAChB,UAAQ,IAAI,wBAAwB,YAClC,QAAQ,IAAI,SAAS,CAAC,OAAO,8BAA8B,CAC5D;AACD,QAAM;GACN;AAEJ,SAAQ,IAAI,wBAAwB,YAAqB,QAAQ,IAAI,UAAU,CAAC,OAAO,qBAAqB,CAAC;AAC7G,SAAQ,IAAI,wBAAwB,YAAqB,QAAQ,IAAI,WAAW,CAAC,OAAO,yBAAyB,CAAC;AAElH,OAAM,gBAAgB,SAAS,WAAW,iBAAiB,SAAS;AAEpE,SAAQ,IAAI,wBAAwB,YAAqB,QAAQ,IAAI,UAAU,CAAC,OAAO,qBAAqB,CAAC;AAC7G,SAAQ,IAAI,wBAAwB,YAAqB,QAAQ,IAAI,WAAW,CAAC,OAAO,yBAAyB,CAAC;AAElH,OAAM,OAAO;EACX,SAAS,YAAY,IAAI,SAAS,QAAQ;EAC1C,cAAc,WAAW;EACzB,iBAAiB,WAAW;EAC5B;EACA;EACA;EACA,IAAI,IAAI;EACT,CAAC;AAEF,SAAQ,KAAK,EAAE;EACf,CACH"}