{"version":3,"file":"upload.mjs","names":[],"sources":["../../../../src/cloud/new-deployment/utils/upload.ts"],"sourcesContent":["import axios from 'axios'\nimport fs from 'fs'\nimport path from 'path'\nimport { cloudApi } from '../cloud-api/index'\nimport { distDir, maxUploadSize } from '../constants'\n\nexport const upload = async (deploymentToken: string, fileName: string, onProgress: (progress: number) => void) => {\n  const filePath = path.join(distDir, fileName)\n  const fileStats = fs.statSync(filePath)\n\n  const {\n    fileInfo: { presignedUrl },\n  } = await cloudApi.upload({\n    deploymentToken,\n    originalName: fileName,\n    size: fileStats.size,\n    mimetype: 'application/zip',\n  })\n\n  await uploadToPresignedUrl(filePath, presignedUrl, fileStats.size, onProgress)\n}\n\nconst uploadToPresignedUrl = async (\n  filePath: string,\n  presignedUrl: string,\n  fileSize: number,\n  onProgress: (progress: number) => void,\n): Promise<void> => {\n  const fileName = path.basename(filePath)\n  const fileStream = fs.createReadStream(filePath)\n\n  await axios.put(presignedUrl, fileStream, {\n    headers: {\n      'Content-Type': 'application/zip',\n      'Content-Length': fileSize,\n      'Content-Disposition': `attachment; filename=\"${fileName}\"`,\n    },\n    maxContentLength: maxUploadSize,\n    maxBodyLength: maxUploadSize,\n\n    onUploadProgress(progressEvent) {\n      const progress = progressEvent.progress ?? 0\n      onProgress(Math.round(progress * 100))\n    },\n  })\n}\n"],"mappings":";;;;;;;AAMA,MAAa,SAAS,OAAO,iBAAyB,UAAkB,eAA2C;CACjH,MAAM,WAAW,KAAK,KAAK,SAAS,SAAS;CAC7C,MAAM,YAAY,GAAG,SAAS,SAAS;CAEvC,MAAM,EACJ,UAAU,EAAE,mBACV,MAAM,SAAS,OAAO;EACxB;EACA,cAAc;EACd,MAAM,UAAU;EAChB,UAAU;EACX,CAAC;AAEF,OAAM,qBAAqB,UAAU,cAAc,UAAU,MAAM,WAAW;;AAGhF,MAAM,uBAAuB,OAC3B,UACA,cACA,UACA,eACkB;CAClB,MAAM,WAAW,KAAK,SAAS,SAAS;CACxC,MAAM,aAAa,GAAG,iBAAiB,SAAS;AAEhD,OAAM,MAAM,IAAI,cAAc,YAAY;EACxC,SAAS;GACP,gBAAgB;GAChB,kBAAkB;GAClB,uBAAuB,yBAAyB,SAAS;GAC1D;EACD,kBAAkB;EAClB,eAAe;EAEf,iBAAiB,eAAe;GAC9B,MAAM,WAAW,cAAc,YAAY;AAC3C,cAAW,KAAK,MAAM,WAAW,IAAI,CAAC;;EAEzC,CAAC"}