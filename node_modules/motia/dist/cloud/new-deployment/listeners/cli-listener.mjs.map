{"version":3,"file":"cli-listener.mjs","names":["context: CliContext"],"sources":["../../../../src/cloud/new-deployment/listeners/cli-listener.ts"],"sourcesContent":["import type { Step, Stream } from '@motiadev/core'\nimport pc from 'picocolors'\nimport type { BuildStepConfig } from '../../build/builder'\nimport type { CliContext } from '../../config-utils'\nimport { BuildPrinter } from './build-printer'\nimport type { DeployData, DeploymentListener, DeploymentOutput, ValidationError } from './listener.types'\nimport { printDeploymentStatus } from './print-deployment-status'\nimport { DeployPrinter } from './printer'\n\nexport class CliListener implements DeploymentListener {\n  private readonly printer: BuildPrinter\n  private readonly deployPrinter = new DeployPrinter()\n\n  constructor(private readonly context: CliContext) {\n    this.printer = new BuildPrinter()\n  }\n\n  onBuildStart(step: Step) {\n    this.printer.printStepBuilding(step)\n  }\n  onBuildProgress(step: Step, message: string) {\n    this.printer.printStepBuilding(step, message)\n  }\n  onBuildEnd(step: Step, size: number) {\n    this.printer.printStepBuilt(step, size)\n  }\n  onBuildError(step: Step, error: Error) {\n    this.printer.printStepFailed(step, error)\n  }\n  onBuildSkip(step: Step, reason: string) {\n    this.printer.printStepSkipped(step, reason)\n  }\n  onStreamCreated(stream: Stream) {\n    this.printer.printStreamCreated(stream)\n  }\n\n  onApiRouterBuilding(language: string) {\n    this.printer.printApiRouterBuilding(language)\n  }\n  onApiRouterBuilt(language: string, size: number) {\n    this.printer.printApiRouterBuilt(language, size)\n  }\n\n  onWarning(id: string, warning: string) {\n    this.context.log(id, (message) => message.tag('warning').append(warning))\n  }\n\n  onBuildWarning(warning: ValidationError) {\n    this.context.log(`build-warnings-${warning.step.filePath}`, (message) => {\n      message.tag('warning').append(warning.message)\n    })\n  }\n\n  onBuildErrors(errors: ValidationError[]) {\n    this.context.log('build-failed', (message) => {\n      message.box(['Unable to deploy to Motia Cloud, please fix the following errors'], 'red')\n    })\n\n    errors.map((error) => {\n      const filePath = pc.gray(`[${error.relativePath}]`)\n      this.context.log(`build-errors-${error.relativePath}`, (message) => {\n        message.tag('failed').append(`${filePath} ${error.message}`)\n      })\n    })\n\n    this.context.log('build-failed-end', (message) => {\n      message.append(pc.gray('\\n--------------------------------\\n'))\n      message.tag('failed').append('Deployment canceled', 'red')\n    })\n  }\n\n  stepUploadStart(_: string, step: BuildStepConfig) {\n    this.deployPrinter.printStepUploading(step)\n  }\n\n  stepUploadEnd(_: string, step: BuildStepConfig) {\n    this.deployPrinter.printStepUploaded(step)\n  }\n\n  routeUploadStart(path: string, language: string) {\n    this.deployPrinter.printRouterUploading(path, language)\n  }\n  routeUploadEnd(path: string, language: string) {\n    this.deployPrinter.printRouterUploaded(path, language)\n  }\n\n  onDeployStart() {\n    this.context.log('deploy-progress', (message) => message.tag('progress').append('Version in progress...'))\n  }\n\n  onDeployProgress(data: DeployData) {\n    printDeploymentStatus(data, this.context)\n  }\n\n  onDeployEnd({ output }: DeploymentOutput) {\n    this.context.log('deploy-result', (message) =>\n      message.tag('success').append('Deployment process completed successfully'),\n    )\n\n    this.context.log('deploy-output', (message) =>\n      message.table(\n        ['Field', 'Value'],\n        Object.entries(output).map(([key, value]) => [key, value]),\n      ),\n    )\n  }\n\n  onDeployError(errorMessage: string) {\n    this.context.log('deploy-result', (message) =>\n      message\n        .tag('failed')\n        .append('Deployment failed. Please check the deployment status and try again or contact support', 'red')\n        .box([errorMessage], 'red'),\n    )\n  }\n\n  stepUploadProgress() {}\n  routeUploadProgress() {}\n  routeUploadError() {}\n  stepUploadError() {}\n}\n"],"mappings":";;;;;;AASA,IAAa,cAAb,MAAuD;CAIrD,YAAY,AAAiBA,SAAqB;EAArB;uBAFI,IAAI,eAAe;AAGlD,OAAK,UAAU,IAAI,cAAc;;CAGnC,aAAa,MAAY;AACvB,OAAK,QAAQ,kBAAkB,KAAK;;CAEtC,gBAAgB,MAAY,SAAiB;AAC3C,OAAK,QAAQ,kBAAkB,MAAM,QAAQ;;CAE/C,WAAW,MAAY,MAAc;AACnC,OAAK,QAAQ,eAAe,MAAM,KAAK;;CAEzC,aAAa,MAAY,OAAc;AACrC,OAAK,QAAQ,gBAAgB,MAAM,MAAM;;CAE3C,YAAY,MAAY,QAAgB;AACtC,OAAK,QAAQ,iBAAiB,MAAM,OAAO;;CAE7C,gBAAgB,QAAgB;AAC9B,OAAK,QAAQ,mBAAmB,OAAO;;CAGzC,oBAAoB,UAAkB;AACpC,OAAK,QAAQ,uBAAuB,SAAS;;CAE/C,iBAAiB,UAAkB,MAAc;AAC/C,OAAK,QAAQ,oBAAoB,UAAU,KAAK;;CAGlD,UAAU,IAAY,SAAiB;AACrC,OAAK,QAAQ,IAAI,KAAK,YAAY,QAAQ,IAAI,UAAU,CAAC,OAAO,QAAQ,CAAC;;CAG3E,eAAe,SAA0B;AACvC,OAAK,QAAQ,IAAI,kBAAkB,QAAQ,KAAK,aAAa,YAAY;AACvE,WAAQ,IAAI,UAAU,CAAC,OAAO,QAAQ,QAAQ;IAC9C;;CAGJ,cAAc,QAA2B;AACvC,OAAK,QAAQ,IAAI,iBAAiB,YAAY;AAC5C,WAAQ,IAAI,CAAC,mEAAmE,EAAE,MAAM;IACxF;AAEF,SAAO,KAAK,UAAU;GACpB,MAAM,WAAW,GAAG,KAAK,IAAI,MAAM,aAAa,GAAG;AACnD,QAAK,QAAQ,IAAI,gBAAgB,MAAM,iBAAiB,YAAY;AAClE,YAAQ,IAAI,SAAS,CAAC,OAAO,GAAG,SAAS,GAAG,MAAM,UAAU;KAC5D;IACF;AAEF,OAAK,QAAQ,IAAI,qBAAqB,YAAY;AAChD,WAAQ,OAAO,GAAG,KAAK,uCAAuC,CAAC;AAC/D,WAAQ,IAAI,SAAS,CAAC,OAAO,uBAAuB,MAAM;IAC1D;;CAGJ,gBAAgB,GAAW,MAAuB;AAChD,OAAK,cAAc,mBAAmB,KAAK;;CAG7C,cAAc,GAAW,MAAuB;AAC9C,OAAK,cAAc,kBAAkB,KAAK;;CAG5C,iBAAiB,MAAc,UAAkB;AAC/C,OAAK,cAAc,qBAAqB,MAAM,SAAS;;CAEzD,eAAe,MAAc,UAAkB;AAC7C,OAAK,cAAc,oBAAoB,MAAM,SAAS;;CAGxD,gBAAgB;AACd,OAAK,QAAQ,IAAI,oBAAoB,YAAY,QAAQ,IAAI,WAAW,CAAC,OAAO,yBAAyB,CAAC;;CAG5G,iBAAiB,MAAkB;AACjC,wBAAsB,MAAM,KAAK,QAAQ;;CAG3C,YAAY,EAAE,UAA4B;AACxC,OAAK,QAAQ,IAAI,kBAAkB,YACjC,QAAQ,IAAI,UAAU,CAAC,OAAO,4CAA4C,CAC3E;AAED,OAAK,QAAQ,IAAI,kBAAkB,YACjC,QAAQ,MACN,CAAC,SAAS,QAAQ,EAClB,OAAO,QAAQ,OAAO,CAAC,KAAK,CAAC,KAAK,WAAW,CAAC,KAAK,MAAM,CAAC,CAC3D,CACF;;CAGH,cAAc,cAAsB;AAClC,OAAK,QAAQ,IAAI,kBAAkB,YACjC,QACG,IAAI,SAAS,CACb,OAAO,0FAA0F,MAAM,CACvG,IAAI,CAAC,aAAa,EAAE,MAAM,CAC9B;;CAGH,qBAAqB;CACrB,sBAAsB;CACtB,mBAAmB;CACnB,kBAAkB"}