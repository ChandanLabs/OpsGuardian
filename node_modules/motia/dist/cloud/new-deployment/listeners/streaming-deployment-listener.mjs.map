{"version":3,"file":"streaming-deployment-listener.mjs","names":["deploymentId: string","mergedUpdate: Partial<DeploymentData>","buildOutput: BuildOutput","uploadOutput: UploadOutput"],"sources":["../../../../src/cloud/new-deployment/listeners/streaming-deployment-listener.ts"],"sourcesContent":["import type { MotiaStream, Step, Stream } from '@motiadev/core'\nimport type { BuildStepConfig } from '../../build/builder'\nimport {\n  type BuildOutput,\n  type DeploymentData,\n  DeploymentStreamManager,\n  type UploadOutput,\n} from '../streams/deployment-stream'\nimport type { DeployData, DeploymentListener, ValidationError } from './listener.types'\n\nexport class StreamingDeploymentListener implements DeploymentListener {\n  private errors: ValidationError[] = []\n  private warnings: ValidationError[] = []\n  private streamManager: DeploymentStreamManager\n\n  constructor(\n    private deploymentId: string,\n    deploymentStream: MotiaStream<DeploymentData>,\n  ) {\n    this.streamManager = new DeploymentStreamManager(deploymentStream)\n  }\n\n  private relativePath(path: string): string {\n    return path.replace(`${process.cwd()}/`, '')\n  }\n\n  private getStepType(step: Step): 'event' | 'api' | 'cron' {\n    if (step.config.type === 'api') return 'api'\n    if (step.config.type === 'cron') return 'cron'\n    return 'event'\n  }\n\n  private getLanguage(filePath: string): string {\n    if (filePath.endsWith('.ts') || filePath.endsWith('.js')) return 'node'\n    if (filePath.endsWith('.py')) return 'python'\n    if (filePath.endsWith('.rb')) return 'ruby'\n    return 'unknown'\n  }\n\n  private async updateStream(update: Partial<DeploymentData>) {\n    const current = await this.streamManager.getDeployment(this.deploymentId)\n\n    if (!current) {\n      return\n    }\n    const mergedUpdate: Partial<DeploymentData> = {\n      ...update,\n    }\n\n    await this.streamManager.updateDeployment(this.deploymentId, mergedUpdate)\n  }\n\n  getErrors(): ValidationError[] {\n    return this.errors\n  }\n\n  // Build phase events\n  async onBuildStart(step: Step) {\n    const message = `Building step: ${step.config.name}`\n    const buildOutput: BuildOutput = {\n      packagePath: this.relativePath(step.filePath),\n      language: this.getLanguage(step.filePath),\n      status: 'building',\n      type: this.getStepType(step),\n    }\n\n    await this.updateStream({\n      phase: 'build',\n      status: 'building',\n      message,\n    })\n    await this.streamManager.updateBuildOutput(this.deploymentId, buildOutput)\n  }\n\n  async onBuildProgress(step: Step, message: string) {\n    const logMessage = `${step.config.name}: ${message}`\n    await this.updateStream({ message: logMessage })\n  }\n\n  async onBuildEnd(step: Step, size: number) {\n    const message = `Built ${step.config.name} (${size} bytes)`\n    const buildOutput: BuildOutput = {\n      packagePath: this.relativePath(step.filePath),\n      language: this.getLanguage(step.filePath),\n      status: 'built',\n      type: this.getStepType(step),\n      size,\n    }\n\n    await this.updateStream({ message })\n    await this.streamManager.updateBuildOutput(this.deploymentId, buildOutput)\n  }\n\n  async onBuildError(step: Step, error: Error) {\n    const message = `Error building ${step.config.name}: ${error.message}`\n    const buildOutput: BuildOutput = {\n      packagePath: this.relativePath(step.filePath),\n      language: this.getLanguage(step.filePath),\n      status: 'error',\n      type: this.getStepType(step),\n      errorMessage: error.message,\n    }\n\n    await this.updateStream({\n      status: 'failed',\n      message,\n      error: error.message,\n    })\n    await this.streamManager.updateBuildOutput(this.deploymentId, buildOutput)\n  }\n\n  async onBuildSkip(step: Step, reason: string) {\n    const message = `Skipped ${step.config.name}: ${reason}`\n    await this.updateStream({ message })\n  }\n\n  async onStreamCreated(stream: Stream) {\n    const message = `Created stream: ${stream.config.name}`\n    await this.updateStream({ message })\n  }\n\n  async onApiRouterBuilding(language: string) {\n    const message = `Building API router for ${language}`\n    await this.updateStream({ message })\n  }\n\n  async onApiRouterBuilt(language: string, size: number) {\n    const message = `Built API router for ${language} (${size} bytes)`\n    await this.updateStream({ message })\n  }\n\n  async onWarning(id: string, warning: string) {\n    this.warnings.push({\n      relativePath: id,\n      message: warning,\n      step: {} as ValidationError['step'],\n    })\n    await this.updateStream({\n      message: `Warning: ${warning}`,\n    })\n  }\n\n  async onBuildWarning(warning: ValidationError): Promise<void> {\n    this.warnings.push(warning)\n    await this.updateStream({\n      message: `Build warning: ${warning.message}`,\n    })\n  }\n\n  async onBuildErrors(errors: ValidationError[]): Promise<void> {\n    this.errors.push(...errors)\n    const errorMessage = `Build failed with ${errors.length} errors`\n    await this.updateStream({\n      status: 'failed',\n      message: errorMessage,\n      error: errors.map((error) => error.message).join('\\n'),\n    })\n  }\n\n  // Upload phase events\n  async stepUploadStart(stepPath: string, step: BuildStepConfig) {\n    const message = `Starting upload: ${step.config.name}`\n    const uploadOutput: UploadOutput = {\n      packagePath: this.relativePath(stepPath),\n      language: this.getLanguage(step.filePath),\n      status: 'uploading',\n      type: step.config.type as 'event' | 'api' | 'cron',\n      progress: 0,\n    }\n\n    await this.updateStream({\n      phase: 'upload',\n      status: 'uploading',\n      message,\n    })\n    await this.streamManager.updateUploadOutput(this.deploymentId, uploadOutput)\n  }\n\n  async stepUploadProgress(stepPath: string, step: BuildStepConfig, progress: number) {\n    const uploadOutput: UploadOutput = {\n      packagePath: stepPath,\n      language: this.getLanguage(step.filePath),\n      status: 'uploading',\n      type: step.config.type as 'event' | 'api' | 'cron',\n      progress,\n    }\n\n    await this.streamManager.updateUploadOutput(this.deploymentId, uploadOutput)\n  }\n\n  async stepUploadEnd(stepPath: string, step: BuildStepConfig) {\n    const uploadOutput: UploadOutput = {\n      packagePath: this.relativePath(stepPath),\n      language: this.getLanguage(step.filePath),\n      status: 'uploaded',\n      type: step.config.type as 'event' | 'api' | 'cron',\n      progress: 100,\n    }\n\n    await this.streamManager.updateUploadOutput(this.deploymentId, uploadOutput)\n  }\n\n  async stepUploadError(stepPath: string, step: BuildStepConfig) {\n    const message = `Upload failed: ${step.config.name}`\n    const uploadOutput: UploadOutput = {\n      packagePath: this.relativePath(stepPath),\n      language: this.getLanguage(step.filePath),\n      status: 'error',\n      type: step.config.type as 'event' | 'api' | 'cron',\n      errorMessage: message,\n    }\n\n    await this.updateStream({\n      status: 'failed',\n      message,\n      error: message,\n    })\n    await this.streamManager.updateUploadOutput(this.deploymentId, uploadOutput)\n  }\n\n  async routeUploadStart(path: string, language: string) {\n    const uploadOutput: UploadOutput = {\n      packagePath: this.relativePath(path),\n      language,\n      status: 'uploading',\n      type: 'api',\n      progress: 0,\n    }\n\n    await this.streamManager.updateUploadOutput(this.deploymentId, uploadOutput)\n  }\n\n  async routeUploadProgress(path: string, language: string, progress: number) {\n    const uploadOutput: UploadOutput = {\n      packagePath: this.relativePath(path),\n      language,\n      status: 'uploading',\n      type: 'api',\n      progress,\n    }\n\n    await this.streamManager.updateUploadOutput(this.deploymentId, uploadOutput)\n  }\n\n  async routeUploadEnd(path: string, language: string) {\n    const message = `Uploaded: ${language} router`\n    const uploadOutput: UploadOutput = {\n      packagePath: this.relativePath(path),\n      language,\n      status: 'uploaded',\n      type: 'api',\n      progress: 100,\n    }\n\n    await this.updateStream({ message })\n    await this.streamManager.updateUploadOutput(this.deploymentId, uploadOutput)\n  }\n\n  async routeUploadError(path: string, language: string) {\n    const message = `Upload failed: ${language} router`\n    const uploadOutput: UploadOutput = {\n      packagePath: this.relativePath(path),\n      language,\n      status: 'error',\n      type: 'api',\n      errorMessage: message,\n    }\n\n    await this.updateStream({\n      status: 'failed',\n      message,\n      error: message,\n    })\n    await this.streamManager.updateUploadOutput(this.deploymentId, uploadOutput)\n  }\n\n  // Deploy phase events\n  async onDeployStart() {\n    const message = 'Deployment started'\n    await this.updateStream({\n      phase: 'deploy',\n      status: 'deploying',\n      message,\n    })\n  }\n\n  async onDeployProgress(data: DeployData) {\n    const message = `Deployment status: ${data.status}`\n    await this.updateStream({\n      message,\n    })\n  }\n\n  async onDeployEnd(): Promise<void> {\n    await this.streamManager.completeDeployment(this.deploymentId)\n  }\n\n  async onDeployError(errorMessage: string): Promise<void> {\n    await this.streamManager.completeDeployment(this.deploymentId, errorMessage)\n  }\n\n  // Utility methods for phase management\n  async startBuildPhase() {\n    await this.updateStream({\n      phase: 'build',\n      status: 'building',\n      message: 'Build phase started',\n    })\n  }\n\n  async startUploadPhase() {\n    await this.updateStream({\n      phase: 'upload',\n      status: 'uploading',\n      message: 'Upload phase started',\n    })\n  }\n\n  async startDeployPhase() {\n    await this.updateStream({\n      phase: 'deploy',\n      status: 'deploying',\n      message: 'Deploy phase started',\n    })\n  }\n}\n"],"mappings":"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"}