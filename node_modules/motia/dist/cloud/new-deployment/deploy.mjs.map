{"version":3,"file":"deploy.mjs","names":[],"sources":["../../../src/cloud/new-deployment/deploy.ts"],"sourcesContent":["import { Stream } from '@motiadev/stream-client-node'\nimport type { Builder } from '../build/builder'\nimport type { CliContext, Message } from '../config-utils'\nimport { cloudApiWsUrl } from './cloud-api/endpoints'\nimport { cloudApi } from './cloud-api/index'\nimport type { DeployData, DeployListener } from './listeners/listener.types'\n\nexport type DeployInput = {\n  envVars: Record<string, string>\n  deploymentId: string\n  deploymentToken: string\n  builder: Builder\n  listener: DeployListener\n  context: CliContext\n  ci: boolean\n}\n\nexport const deploy = async (input: DeployInput): Promise<void> => {\n  const { envVars, deploymentToken, builder, deploymentId, listener, context, ci } = input\n  const client = new Stream(cloudApiWsUrl)\n\n  const response = await cloudApi.startDeployment({\n    deploymentToken,\n    envVars,\n    steps: builder.stepsConfig,\n    streams: builder.streamsConfig,\n    routers: builder.routersConfig,\n  })\n\n  context.log('starting-deployment', (message: Message) => message.tag('success').append('Deployment started'))\n\n  if (!ci) {\n    const subscription = client.subscribeItem<DeployData>('deployment', deploymentId, 'data')\n\n    const interval = setInterval(() => {\n      const state = subscription.getState()\n      if (state) {\n        listener.onDeployProgress(state)\n      }\n    }, 1000)\n\n    await new Promise<void>((resolve) => {\n      subscription.addChangeListener((item: DeployData) => {\n        if (item && ['failed', 'completed'].includes(item.status)) {\n          clearInterval(interval)\n          listener.onDeployProgress(item)\n\n          if (item.status === 'completed') {\n            listener.onDeployEnd({\n              output: item.outputs,\n            })\n          }\n\n          client.close()\n          resolve()\n        }\n      })\n    })\n  } else {\n    context.log('deploy-progress', (message: Message) =>\n      message\n        .tag('progress')\n        .append(`Deployment in progress... You can view the deployment at ${response?.deploymentUrl}`),\n    )\n    client.close()\n  }\n}\n"],"mappings":";;;;;AAiBA,MAAa,SAAS,OAAO,UAAsC;CACjE,MAAM,EAAE,SAAS,iBAAiB,SAAS,cAAc,UAAU,SAAS,OAAO;CACnF,MAAM,SAAS,IAAI,OAAO,cAAc;CAExC,MAAM,WAAW,MAAM,SAAS,gBAAgB;EAC9C;EACA;EACA,OAAO,QAAQ;EACf,SAAS,QAAQ;EACjB,SAAS,QAAQ;EAClB,CAAC;AAEF,SAAQ,IAAI,wBAAwB,YAAqB,QAAQ,IAAI,UAAU,CAAC,OAAO,qBAAqB,CAAC;AAE7G,KAAI,CAAC,IAAI;EACP,MAAM,eAAe,OAAO,cAA0B,cAAc,cAAc,OAAO;EAEzF,MAAM,WAAW,kBAAkB;GACjC,MAAM,QAAQ,aAAa,UAAU;AACrC,OAAI,MACF,UAAS,iBAAiB,MAAM;KAEjC,IAAK;AAER,QAAM,IAAI,SAAe,YAAY;AACnC,gBAAa,mBAAmB,SAAqB;AACnD,QAAI,QAAQ,CAAC,UAAU,YAAY,CAAC,SAAS,KAAK,OAAO,EAAE;AACzD,mBAAc,SAAS;AACvB,cAAS,iBAAiB,KAAK;AAE/B,SAAI,KAAK,WAAW,YAClB,UAAS,YAAY,EACnB,QAAQ,KAAK,SACd,CAAC;AAGJ,YAAO,OAAO;AACd,cAAS;;KAEX;IACF;QACG;AACL,UAAQ,IAAI,oBAAoB,YAC9B,QACG,IAAI,WAAW,CACf,OAAO,4DAA4D,UAAU,gBAAgB,CACjG;AACD,SAAO,OAAO"}