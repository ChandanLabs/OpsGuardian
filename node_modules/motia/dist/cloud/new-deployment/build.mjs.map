{"version":3,"file":"build.mjs","names":["stepsFile: StepsConfigFile"],"sources":["../../../src/cloud/new-deployment/build.ts"],"sourcesContent":["import { isApiStep, LockedData, MemoryStreamAdapterManager, NoPrinter } from '@motiadev/core'\nimport fs from 'fs'\nimport { collectFlows, getStepFiles, getStreamFiles } from '../../generate-locked-data'\nimport { activatePythonVenv } from '../../utils/activate-python-env'\nimport { BuildError, BuildErrorType } from '../../utils/errors/build.error'\nimport { validatePythonEnvironment } from '../../utils/validate-python-environment'\nimport { Builder, type StepsConfigFile } from '../build/builder'\nimport { NodeBuilder } from '../build/builders/node/index'\nimport { PythonBuilder } from '../build/builders/python/index'\nimport { distDir, projectDir, stepsConfigPath } from './constants'\nimport type { BuildListener } from './listeners/listener.types'\n\nconst hasPythonSteps = (stepFiles: string[]) => {\n  return stepFiles.some((file) => file.endsWith('.py'))\n}\n\nexport const build = async (listener: BuildListener): Promise<Builder> => {\n  const builder = new Builder(projectDir, listener)\n  const stepFiles = getStepFiles(projectDir)\n  const streamFiles = getStreamFiles(projectDir)\n\n  if (stepFiles.length === 0) {\n    throw new Error('Project contains no steps, please add some steps before building')\n  }\n\n  // Register language-specific builders\n  builder.registerBuilder('node', new NodeBuilder(builder, listener))\n\n  fs.rmSync(distDir, { recursive: true, force: true })\n  fs.mkdirSync(distDir, { recursive: true })\n\n  const lockedData = new LockedData(projectDir, new MemoryStreamAdapterManager(), new NoPrinter())\n\n  const hasPython = hasPythonSteps([...stepFiles, ...streamFiles])\n  const pythonValidation = await validatePythonEnvironment({ baseDir: projectDir, hasPythonFiles: hasPython })\n  if (!pythonValidation.success) {\n    throw new BuildError(BuildErrorType.COMPILATION, undefined, '')\n  }\n\n  if (hasPython) {\n    activatePythonVenv({ baseDir: projectDir })\n    builder.registerBuilder('python', new PythonBuilder(builder, listener))\n  }\n\n  const invalidSteps = await collectFlows(projectDir, lockedData).catch((err) => {\n    const errorMessage = err.filePath ? `Build error in ${err.filePath}` : 'Build error'\n\n    const finalMessage = `${errorMessage}\\nPlease check the logs above for details`\n\n    throw new BuildError(BuildErrorType.COMPILATION, err.filePath, finalMessage, err)\n  })\n\n  if (invalidSteps.length > 0) {\n    throw new Error('Project contains invalid steps, please fix them before building')\n  }\n\n  await Promise.all(lockedData.activeSteps.map((step) => builder.buildStep(step)))\n  await builder.buildApiSteps(lockedData.activeSteps.filter(isApiStep))\n\n  const streams = lockedData.listStreams()\n\n  for (const stream of streams) {\n    if (stream.config.baseConfig.storageType === 'default') {\n      builder.registerStateStream(stream)\n    } else {\n      listener.onWarning(stream.filePath, 'Custom streams are not supported yet in the cloud')\n    }\n  }\n\n  const stepsFile: StepsConfigFile = {\n    steps: builder.stepsConfig,\n    streams: builder.streamsConfig,\n    routers: builder.routersConfig,\n  }\n  fs.writeFileSync(stepsConfigPath, JSON.stringify(stepsFile, null, 2))\n\n  return builder\n}\n"],"mappings":";;;;;;;;;;;;AAYA,MAAM,kBAAkB,cAAwB;AAC9C,QAAO,UAAU,MAAM,SAAS,KAAK,SAAS,MAAM,CAAC;;AAGvD,MAAa,QAAQ,OAAO,aAA8C;CACxE,MAAM,UAAU,IAAI,QAAQ,YAAY,SAAS;CACjD,MAAM,YAAY,aAAa,WAAW;CAC1C,MAAM,cAAc,eAAe,WAAW;AAE9C,KAAI,UAAU,WAAW,EACvB,OAAM,IAAI,MAAM,mEAAmE;AAIrF,SAAQ,gBAAgB,QAAQ,IAAI,YAAY,SAAS,SAAS,CAAC;AAEnE,IAAG,OAAO,SAAS;EAAE,WAAW;EAAM,OAAO;EAAM,CAAC;AACpD,IAAG,UAAU,SAAS,EAAE,WAAW,MAAM,CAAC;CAE1C,MAAM,aAAa,IAAI,WAAW,YAAY,IAAI,4BAA4B,EAAE,IAAI,WAAW,CAAC;CAEhG,MAAM,YAAY,eAAe,CAAC,GAAG,WAAW,GAAG,YAAY,CAAC;AAEhE,KAAI,EADqB,MAAM,0BAA0B;EAAE,SAAS;EAAY,gBAAgB;EAAW,CAAC,EACtF,QACpB,OAAM,IAAI,WAAW,eAAe,aAAa,QAAW,GAAG;AAGjE,KAAI,WAAW;AACb,qBAAmB,EAAE,SAAS,YAAY,CAAC;AAC3C,UAAQ,gBAAgB,UAAU,IAAI,cAAc,SAAS,SAAS,CAAC;;AAWzE,MARqB,MAAM,aAAa,YAAY,WAAW,CAAC,OAAO,QAAQ;EAG7E,MAAM,eAAe,GAFA,IAAI,WAAW,kBAAkB,IAAI,aAAa,cAElC;AAErC,QAAM,IAAI,WAAW,eAAe,aAAa,IAAI,UAAU,cAAc,IAAI;GACjF,EAEe,SAAS,EACxB,OAAM,IAAI,MAAM,kEAAkE;AAGpF,OAAM,QAAQ,IAAI,WAAW,YAAY,KAAK,SAAS,QAAQ,UAAU,KAAK,CAAC,CAAC;AAChF,OAAM,QAAQ,cAAc,WAAW,YAAY,OAAO,UAAU,CAAC;CAErE,MAAM,UAAU,WAAW,aAAa;AAExC,MAAK,MAAM,UAAU,QACnB,KAAI,OAAO,OAAO,WAAW,gBAAgB,UAC3C,SAAQ,oBAAoB,OAAO;KAEnC,UAAS,UAAU,OAAO,UAAU,oDAAoD;CAI5F,MAAMA,YAA6B;EACjC,OAAO,QAAQ;EACf,SAAS,QAAQ;EACjB,SAAS,QAAQ;EAClB;AACD,IAAG,cAAc,iBAAiB,KAAK,UAAU,WAAW,MAAM,EAAE,CAAC;AAErE,QAAO"}