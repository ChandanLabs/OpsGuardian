{"version":3,"file":"deployment-stream.mjs","names":["stream: MotiaStream<DeploymentData>","metadata: Metadata"],"sources":["../../../../src/cloud/new-deployment/streams/deployment-stream.ts"],"sourcesContent":["import type { MotiaStream } from '@motiadev/core'\n\nexport type BuildOutput = {\n  packagePath: string\n  language: string\n  status: 'building' | 'built' | 'error'\n  size?: number\n  type: 'event' | 'api' | 'cron'\n  errorMessage?: string\n}\n\nexport type UploadOutput = {\n  packagePath: string\n  language: string\n  status: 'uploading' | 'uploaded' | 'error'\n  size?: number\n  progress?: number\n  type: 'event' | 'api' | 'cron'\n  errorMessage?: string\n}\n\nexport type Metadata = {\n  totalSteps?: number\n  builtSteps?: number\n  uploadedSteps?: number\n}\n\nexport interface DeploymentData {\n  id: string\n  status: 'idle' | 'building' | 'uploading' | 'deploying' | 'completed' | 'failed'\n  phase: 'build' | 'upload' | 'deploy' | null\n  message: string\n  build: BuildOutput[]\n  upload: UploadOutput[]\n  error?: string\n  startedAt?: number\n  completedAt?: number\n  metadata?: Metadata\n}\n\nexport const createDefaultDeploymentData = (deploymentId: string): DeploymentData => ({\n  id: deploymentId,\n  status: 'idle',\n  phase: null,\n  message: 'No deployment in progress',\n  build: [],\n  upload: [],\n  metadata: {\n    totalSteps: 0,\n    builtSteps: 0,\n    uploadedSteps: 0,\n  },\n})\n\nexport class DeploymentStreamManager {\n  constructor(private stream: MotiaStream<DeploymentData>) {}\n\n  async getDeployment(deploymentId: string): Promise<DeploymentData | null> {\n    return await this.stream.get(deploymentId, 'data')\n  }\n\n  async updateDeployment(deploymentId: string, data: Partial<DeploymentData>): Promise<void> {\n    const current = await this.getDeployment(deploymentId)\n    if (!current) {\n      await this.stream.set(deploymentId, 'data', {\n        ...createDefaultDeploymentData(deploymentId),\n        ...data,\n        id: deploymentId,\n      })\n    } else {\n      const updated = {\n        ...current,\n        ...data,\n        id: deploymentId,\n        deploymentId,\n      }\n      await this.stream.set(deploymentId, 'data', updated)\n    }\n  }\n\n  async startDeployment(deploymentId: string): Promise<void> {\n    const defaultData = createDefaultDeploymentData(deploymentId)\n    await this.stream.set(deploymentId, 'data', {\n      ...defaultData,\n      status: 'building',\n      phase: 'build',\n      startedAt: Date.now(),\n      id: deploymentId,\n      message: 'Starting deployment...',\n    })\n  }\n\n  async completeDeployment(deploymentId: string, error?: string): Promise<void> {\n    const current = await this.getDeployment(deploymentId)\n    if (!current) return\n\n    await this.stream.set(deploymentId, 'data', {\n      ...current,\n      status: error ? 'failed' : 'completed',\n      phase: error ? current.phase : null,\n      message: error || 'Deployment completed successfully',\n      completedAt: Date.now(),\n      error,\n    })\n  }\n\n  async updateBuildOutput(deploymentId: string, buildOutput: BuildOutput): Promise<void> {\n    const current = await this.getDeployment(deploymentId)\n    if (!current) return\n\n    const existingIndex = current.build.findIndex((b) => b.packagePath === buildOutput.packagePath)\n    const updatedBuild = [...current.build]\n\n    if (existingIndex >= 0) {\n      updatedBuild[existingIndex] = buildOutput\n    } else {\n      updatedBuild.push(buildOutput)\n    }\n\n    const builtSteps = updatedBuild.filter((b) => b.status === 'built').length\n    const metadata = {\n      ...current.metadata,\n      builtSteps,\n    }\n\n    await this.updateDeployment(deploymentId, { build: updatedBuild, metadata })\n  }\n\n  async updateUploadOutput(deploymentId: string, uploadOutput: UploadOutput): Promise<void> {\n    const current = await this.getDeployment(deploymentId)\n    if (!current) return\n\n    const existingIndex = current.upload.findIndex((u) => u.packagePath === uploadOutput.packagePath)\n    const updatedUpload = [...current.upload]\n\n    if (existingIndex >= 0) {\n      updatedUpload[existingIndex] = uploadOutput\n    } else {\n      updatedUpload.push(uploadOutput)\n    }\n\n    // Update uploadedSteps count\n    const uploadedSteps = updatedUpload.filter((u) => u.status === 'uploaded').length\n    const metadata: Metadata = {\n      ...current.metadata,\n      uploadedSteps,\n    }\n\n    await this.updateDeployment(deploymentId, { upload: updatedUpload, metadata })\n  }\n}\n"],"mappings":";AAwCA,MAAa,+BAA+B,kBAA0C;CACpF,IAAI;CACJ,QAAQ;CACR,OAAO;CACP,SAAS;CACT,OAAO,EAAE;CACT,QAAQ,EAAE;CACV,UAAU;EACR,YAAY;EACZ,YAAY;EACZ,eAAe;EAChB;CACF;AAED,IAAa,0BAAb,MAAqC;CACnC,YAAY,AAAQA,QAAqC;EAArC;;CAEpB,MAAM,cAAc,cAAsD;AACxE,SAAO,MAAM,KAAK,OAAO,IAAI,cAAc,OAAO;;CAGpD,MAAM,iBAAiB,cAAsB,MAA8C;EACzF,MAAM,UAAU,MAAM,KAAK,cAAc,aAAa;AACtD,MAAI,CAAC,QACH,OAAM,KAAK,OAAO,IAAI,cAAc,QAAQ;GAC1C,GAAG,4BAA4B,aAAa;GAC5C,GAAG;GACH,IAAI;GACL,CAAC;OACG;GACL,MAAM,UAAU;IACd,GAAG;IACH,GAAG;IACH,IAAI;IACJ;IACD;AACD,SAAM,KAAK,OAAO,IAAI,cAAc,QAAQ,QAAQ;;;CAIxD,MAAM,gBAAgB,cAAqC;EACzD,MAAM,cAAc,4BAA4B,aAAa;AAC7D,QAAM,KAAK,OAAO,IAAI,cAAc,QAAQ;GAC1C,GAAG;GACH,QAAQ;GACR,OAAO;GACP,WAAW,KAAK,KAAK;GACrB,IAAI;GACJ,SAAS;GACV,CAAC;;CAGJ,MAAM,mBAAmB,cAAsB,OAA+B;EAC5E,MAAM,UAAU,MAAM,KAAK,cAAc,aAAa;AACtD,MAAI,CAAC,QAAS;AAEd,QAAM,KAAK,OAAO,IAAI,cAAc,QAAQ;GAC1C,GAAG;GACH,QAAQ,QAAQ,WAAW;GAC3B,OAAO,QAAQ,QAAQ,QAAQ;GAC/B,SAAS,SAAS;GAClB,aAAa,KAAK,KAAK;GACvB;GACD,CAAC;;CAGJ,MAAM,kBAAkB,cAAsB,aAAyC;EACrF,MAAM,UAAU,MAAM,KAAK,cAAc,aAAa;AACtD,MAAI,CAAC,QAAS;EAEd,MAAM,gBAAgB,QAAQ,MAAM,WAAW,MAAM,EAAE,gBAAgB,YAAY,YAAY;EAC/F,MAAM,eAAe,CAAC,GAAG,QAAQ,MAAM;AAEvC,MAAI,iBAAiB,EACnB,cAAa,iBAAiB;MAE9B,cAAa,KAAK,YAAY;EAGhC,MAAM,aAAa,aAAa,QAAQ,MAAM,EAAE,WAAW,QAAQ,CAAC;EACpE,MAAM,WAAW;GACf,GAAG,QAAQ;GACX;GACD;AAED,QAAM,KAAK,iBAAiB,cAAc;GAAE,OAAO;GAAc;GAAU,CAAC;;CAG9E,MAAM,mBAAmB,cAAsB,cAA2C;EACxF,MAAM,UAAU,MAAM,KAAK,cAAc,aAAa;AACtD,MAAI,CAAC,QAAS;EAEd,MAAM,gBAAgB,QAAQ,OAAO,WAAW,MAAM,EAAE,gBAAgB,aAAa,YAAY;EACjG,MAAM,gBAAgB,CAAC,GAAG,QAAQ,OAAO;AAEzC,MAAI,iBAAiB,EACnB,eAAc,iBAAiB;MAE/B,eAAc,KAAK,aAAa;EAIlC,MAAM,gBAAgB,cAAc,QAAQ,MAAM,EAAE,WAAW,WAAW,CAAC;EAC3E,MAAMC,WAAqB;GACzB,GAAG,QAAQ;GACX;GACD;AAED,QAAM,KAAK,iBAAiB,cAAc;GAAE,QAAQ;GAAe;GAAU,CAAC"}