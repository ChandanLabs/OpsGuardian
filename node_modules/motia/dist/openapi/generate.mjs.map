{"version":3,"file":"generate.mjs","names":["path","fs","openApi: OpenAPIV3.Document","operation: OpenAPIV3.OperationObject"],"sources":["../../src/openapi/generate.ts"],"sourcesContent":["import type { ApiRouteConfig, Step } from '@motiadev/core'\nimport * as fs from 'fs'\nimport type { OpenAPIV3 } from 'openapi-types'\nimport * as path from 'path'\n\nimport { processSchema } from './process-schema'\nimport { isHttpMethod } from './utils'\n\nexport function generateOpenApi(\n  projectDir: string,\n  apiSteps: Step<ApiRouteConfig>[],\n  title?: string,\n  version?: string,\n  outputFile = 'openapi.json',\n) {\n  // read package.json to get project name for default title & version\n  if (!title || !version) {\n    try {\n      const packageJsonPath = path.join(projectDir, 'package.json')\n      const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'))\n\n      if (!title) title = packageJson.name\n      if (!version) version = packageJson.version\n    } catch (error) {\n      console.warn(`Could not read package.json in ${projectDir} to determine project name. Using default.`)\n    }\n  }\n\n  const openApi: OpenAPIV3.Document = {\n    openapi: '3.0.0',\n    info: {\n      title: title ?? 'Motia Project API',\n      version: version ?? '1.0.0',\n    },\n    paths: {},\n    components: {\n      schemas: {},\n    },\n  }\n\n  for (const step of apiSteps) {\n    const pathItem = openApi.paths[step.config.path] || {}\n    const method = step.config.method.toLowerCase()\n\n    const operation: OpenAPIV3.OperationObject = {\n      summary: step.config.name,\n      description: step.config.description,\n      requestBody: undefined,\n      responses: {},\n    }\n\n    if (step.config.queryParams) {\n      operation.parameters = operation.parameters || []\n\n      for (const param of step.config.queryParams) {\n        operation.parameters.push({\n          in: 'query',\n          name: param.name,\n          description: param.description,\n          required: false,\n          schema: {\n            type: 'string',\n          },\n        })\n      }\n    }\n\n    if (step.config.bodySchema) {\n      const bodySchema = step.config.bodySchema as unknown as Record<string, unknown>\n\n      delete bodySchema.$schema\n\n      const processedSchema = processSchema(bodySchema, openApi)\n\n      operation.requestBody = {\n        content: {\n          'application/json': {\n            schema: processedSchema,\n          },\n        },\n      }\n    }\n\n    if (step.config.responseSchema) {\n      for (const [statusCode, responseSchema] of Object.entries(step.config.responseSchema)) {\n        const resSchema = responseSchema as unknown as Record<string, unknown>\n\n        delete resSchema.$schema\n\n        const processedSchema = processSchema(resSchema, openApi)\n\n        operation.responses[statusCode] = {\n          description: `Response for status code ${statusCode}`,\n          content: {\n            'application/json': {\n              schema: processedSchema,\n            },\n          },\n        }\n      }\n    }\n\n    if (isHttpMethod(method)) {\n      pathItem[method] = operation\n    }\n\n    openApi.paths[step.config.path] = pathItem\n  }\n\n  const openApiJson = JSON.stringify(openApi, null, 2)\n  fs.writeFileSync(path.join(projectDir, outputFile), openApiJson)\n\n  console.log(`âœ… OpenAPI specification generated successfully at ${outputFile}`)\n}\n"],"mappings":";;;;;;AAQA,SAAgB,gBACd,YACA,UACA,OACA,SACA,aAAa,gBACb;AAEA,KAAI,CAAC,SAAS,CAAC,QACb,KAAI;EACF,MAAM,kBAAkBA,OAAK,KAAK,YAAY,eAAe;EAC7D,MAAM,cAAc,KAAK,MAAMC,KAAG,aAAa,iBAAiB,OAAO,CAAC;AAExE,MAAI,CAAC,MAAO,SAAQ,YAAY;AAChC,MAAI,CAAC,QAAS,WAAU,YAAY;UAC7B,OAAO;AACd,UAAQ,KAAK,kCAAkC,WAAW,4CAA4C;;CAI1G,MAAMC,UAA8B;EAClC,SAAS;EACT,MAAM;GACJ,OAAO,SAAS;GAChB,SAAS,WAAW;GACrB;EACD,OAAO,EAAE;EACT,YAAY,EACV,SAAS,EAAE,EACZ;EACF;AAED,MAAK,MAAM,QAAQ,UAAU;EAC3B,MAAM,WAAW,QAAQ,MAAM,KAAK,OAAO,SAAS,EAAE;EACtD,MAAM,SAAS,KAAK,OAAO,OAAO,aAAa;EAE/C,MAAMC,YAAuC;GAC3C,SAAS,KAAK,OAAO;GACrB,aAAa,KAAK,OAAO;GACzB,aAAa;GACb,WAAW,EAAE;GACd;AAED,MAAI,KAAK,OAAO,aAAa;AAC3B,aAAU,aAAa,UAAU,cAAc,EAAE;AAEjD,QAAK,MAAM,SAAS,KAAK,OAAO,YAC9B,WAAU,WAAW,KAAK;IACxB,IAAI;IACJ,MAAM,MAAM;IACZ,aAAa,MAAM;IACnB,UAAU;IACV,QAAQ,EACN,MAAM,UACP;IACF,CAAC;;AAIN,MAAI,KAAK,OAAO,YAAY;GAC1B,MAAM,aAAa,KAAK,OAAO;AAE/B,UAAO,WAAW;GAElB,MAAM,kBAAkB,cAAc,YAAY,QAAQ;AAE1D,aAAU,cAAc,EACtB,SAAS,EACP,oBAAoB,EAClB,QAAQ,iBACT,EACF,EACF;;AAGH,MAAI,KAAK,OAAO,eACd,MAAK,MAAM,CAAC,YAAY,mBAAmB,OAAO,QAAQ,KAAK,OAAO,eAAe,EAAE;GACrF,MAAM,YAAY;AAElB,UAAO,UAAU;GAEjB,MAAM,kBAAkB,cAAc,WAAW,QAAQ;AAEzD,aAAU,UAAU,cAAc;IAChC,aAAa,4BAA4B;IACzC,SAAS,EACP,oBAAoB,EAClB,QAAQ,iBACT,EACF;IACF;;AAIL,MAAI,aAAa,OAAO,CACtB,UAAS,UAAU;AAGrB,UAAQ,MAAM,KAAK,OAAO,QAAQ;;CAGpC,MAAM,cAAc,KAAK,UAAU,SAAS,MAAM,EAAE;AACpD,MAAG,cAAcH,OAAK,KAAK,YAAY,WAAW,EAAE,YAAY;AAEhE,SAAQ,IAAI,qDAAqD,aAAa"}