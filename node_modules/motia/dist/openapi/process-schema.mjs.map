{"version":3,"file":"process-schema.mjs","names":[],"sources":["../../src/openapi/process-schema.ts"],"sourcesContent":["import type { OpenAPIV3 } from 'openapi-types'\n\nexport function processSchema(schema: Record<string, unknown>, openApi: OpenAPIV3.Document) {\n  if (!schema || typeof schema !== 'object') {\n    return schema as OpenAPIV3.SchemaObject\n  }\n\n  if (schema.$defs) {\n    if (!openApi.components) {\n      openApi.components = {}\n    }\n\n    if (!openApi.components.schemas) {\n      openApi.components.schemas = {} as Record<string, OpenAPIV3.SchemaObject | OpenAPIV3.ReferenceObject>\n    }\n\n    // copy all definitions to components/schemas for compatibility\n    for (const defName in schema.$defs) {\n      if (Object.prototype.hasOwnProperty.call(schema.$defs, defName)) {\n        ;(openApi.components.schemas as Record<string, OpenAPIV3.SchemaObject | OpenAPIV3.ReferenceObject>)[defName] = (\n          schema.$defs as Record<string, OpenAPIV3.SchemaObject | OpenAPIV3.ReferenceObject>\n        )[defName]\n      }\n    }\n\n    delete schema.$defs\n  }\n\n  if (Array.isArray(schema.anyOf)) {\n    const nullIndex = schema.anyOf.findIndex((item: { type?: string }) => item && item.type === 'null')\n\n    if (nullIndex !== -1) {\n      schema.anyOf.splice(nullIndex, 1)\n\n      schema.nullable = true\n\n      if (schema.anyOf.length === 1) {\n        // if only one schema remains, lift it up\n        const remainingSchema = schema.anyOf[0]\n\n        for (const key in remainingSchema) {\n          if (Object.prototype.hasOwnProperty.call(remainingSchema, key)) {\n            schema[key] = remainingSchema[key]\n          }\n        }\n\n        delete schema.anyOf\n      }\n    }\n  }\n\n  for (const key in schema) {\n    if (Object.prototype.hasOwnProperty.call(schema, key)) {\n      if (key === '$ref' && typeof schema[key] === 'string' && schema[key].startsWith('#/$defs/')) {\n        // convert $ref to OpenAPI components/schemas format\n        schema[key] = schema[key].replace('#/$defs/', '#/components/schemas/')\n      } else if (typeof schema[key] === 'object') {\n        const result = processSchema(schema[key] as Record<string, unknown>, openApi)\n        schema[key] = result\n      }\n    }\n  }\n\n  return schema as OpenAPIV3.SchemaObject\n}\n"],"mappings":";AAEA,SAAgB,cAAc,QAAiC,SAA6B;AAC1F,KAAI,CAAC,UAAU,OAAO,WAAW,SAC/B,QAAO;AAGT,KAAI,OAAO,OAAO;AAChB,MAAI,CAAC,QAAQ,WACX,SAAQ,aAAa,EAAE;AAGzB,MAAI,CAAC,QAAQ,WAAW,QACtB,SAAQ,WAAW,UAAU,EAAE;AAIjC,OAAK,MAAM,WAAW,OAAO,MAC3B,KAAI,OAAO,UAAU,eAAe,KAAK,OAAO,OAAO,QAAQ,CAC5D,CAAC,QAAQ,WAAW,QAA+E,WAClG,OAAO,MACP;AAIN,SAAO,OAAO;;AAGhB,KAAI,MAAM,QAAQ,OAAO,MAAM,EAAE;EAC/B,MAAM,YAAY,OAAO,MAAM,WAAW,SAA4B,QAAQ,KAAK,SAAS,OAAO;AAEnG,MAAI,cAAc,IAAI;AACpB,UAAO,MAAM,OAAO,WAAW,EAAE;AAEjC,UAAO,WAAW;AAElB,OAAI,OAAO,MAAM,WAAW,GAAG;IAE7B,MAAM,kBAAkB,OAAO,MAAM;AAErC,SAAK,MAAM,OAAO,gBAChB,KAAI,OAAO,UAAU,eAAe,KAAK,iBAAiB,IAAI,CAC5D,QAAO,OAAO,gBAAgB;AAIlC,WAAO,OAAO;;;;AAKpB,MAAK,MAAM,OAAO,OAChB,KAAI,OAAO,UAAU,eAAe,KAAK,QAAQ,IAAI,EACnD;MAAI,QAAQ,UAAU,OAAO,OAAO,SAAS,YAAY,OAAO,KAAK,WAAW,WAAW,CAEzF,QAAO,OAAO,OAAO,KAAK,QAAQ,YAAY,wBAAwB;WAC7D,OAAO,OAAO,SAAS,SAEhC,QAAO,OADQ,cAAc,OAAO,MAAiC,QAAQ;;AAMnF,QAAO"}