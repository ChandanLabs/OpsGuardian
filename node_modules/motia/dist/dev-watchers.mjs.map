{"version":3,"file":"dev-watchers.mjs","names":["watchers: Watcher[]"],"sources":["../src/dev-watchers.ts"],"sourcesContent":["import type { Stream } from '@motiadev/core'\nimport {\n  type CronManager,\n  isApiStep,\n  isCronStep,\n  isEventStep,\n  type LockedData,\n  type MotiaEventManager,\n  type MotiaServer,\n  type Step,\n  trackEvent,\n} from '@motiadev/core'\nimport { existsSync } from 'fs'\nimport path from 'path'\nimport { Watcher } from './watcher'\n\nconst setupWatcherHandlers = (\n  watcher: Watcher,\n  lockedData: LockedData,\n  server: MotiaServer,\n  eventHandler: MotiaEventManager,\n  cronManager: CronManager,\n) => {\n  watcher.onStreamChange((oldStream: Stream, stream: Stream) => {\n    trackEvent('stream_updated', {\n      streamName: stream.config.name,\n      type: stream.config.baseConfig.storageType,\n    })\n\n    return lockedData.updateStream(oldStream, stream)\n  })\n\n  watcher.onStreamCreate((stream: Stream) => {\n    trackEvent('stream_created', {\n      streamName: stream.config.name,\n      type: stream.config.baseConfig.storageType,\n    })\n\n    return lockedData.createStream(stream)\n  })\n\n  watcher.onStreamDelete((stream: Stream) => {\n    trackEvent('stream_deleted', {\n      streamName: stream.config.name,\n      type: stream.config.baseConfig.storageType,\n    })\n\n    return lockedData.deleteStream(stream)\n  })\n\n  watcher.onStepChange((oldStep: Step, newStep: Step) => {\n    if (isApiStep(oldStep)) server.removeRoute(oldStep)\n    if (isCronStep(oldStep)) cronManager.removeCronJob(oldStep)\n    if (isEventStep(oldStep)) eventHandler.removeHandler(oldStep)\n\n    const isUpdated = lockedData.updateStep(oldStep, newStep)\n\n    if (isUpdated) {\n      trackEvent('step_updated', {\n        stepName: newStep.config.name,\n        type: newStep.config.type,\n      })\n\n      if (isCronStep(newStep)) cronManager.createCronJob(newStep)\n      if (isEventStep(newStep)) eventHandler.createHandler(newStep)\n      if (isApiStep(newStep)) server.addRoute(newStep)\n    }\n  })\n\n  watcher.onStepCreate((step: Step) => {\n    const isCreated = lockedData.createStep(step)\n\n    if (isCreated) {\n      trackEvent('step_created', {\n        stepName: step.config.name,\n        type: step.config.type,\n      })\n\n      if (isApiStep(step)) server.addRoute(step)\n      if (isEventStep(step)) eventHandler.createHandler(step)\n      if (isCronStep(step)) cronManager.createCronJob(step)\n    }\n  })\n\n  watcher.onStepDelete((step: Step) => {\n    trackEvent('step_deleted', {\n      stepName: step.config.name,\n      type: step.config.type,\n    })\n\n    if (isApiStep(step)) server.removeRoute(step)\n    if (isEventStep(step)) eventHandler.removeHandler(step)\n    if (isCronStep(step)) cronManager.removeCronJob(step)\n\n    lockedData.deleteStep(step)\n  })\n}\n\nexport const createDevWatchers = (\n  lockedData: LockedData,\n  server: MotiaServer,\n  eventHandler: MotiaEventManager,\n  cronManager: CronManager,\n) => {\n  const baseDir = process.cwd()\n  const dirs = [path.join(baseDir, 'steps'), path.join(baseDir, 'src')]\n  const watchers: Watcher[] = []\n\n  dirs.forEach((dir) => {\n    if (existsSync(dir)) {\n      const watcher = new Watcher(dir, lockedData)\n      setupWatcherHandlers(watcher, lockedData, server, eventHandler, cronManager)\n      watcher.init()\n      watchers.push(watcher)\n    }\n  })\n\n  return {\n    stop: async () => {\n      await Promise.all(watchers.map((watcher) => watcher.stop()))\n    },\n  }\n}\n"],"mappings":";;;;;;AAgBA,MAAM,wBACJ,SACA,YACA,QACA,cACA,gBACG;AACH,SAAQ,gBAAgB,WAAmB,WAAmB;AAC5D,aAAW,kBAAkB;GAC3B,YAAY,OAAO,OAAO;GAC1B,MAAM,OAAO,OAAO,WAAW;GAChC,CAAC;AAEF,SAAO,WAAW,aAAa,WAAW,OAAO;GACjD;AAEF,SAAQ,gBAAgB,WAAmB;AACzC,aAAW,kBAAkB;GAC3B,YAAY,OAAO,OAAO;GAC1B,MAAM,OAAO,OAAO,WAAW;GAChC,CAAC;AAEF,SAAO,WAAW,aAAa,OAAO;GACtC;AAEF,SAAQ,gBAAgB,WAAmB;AACzC,aAAW,kBAAkB;GAC3B,YAAY,OAAO,OAAO;GAC1B,MAAM,OAAO,OAAO,WAAW;GAChC,CAAC;AAEF,SAAO,WAAW,aAAa,OAAO;GACtC;AAEF,SAAQ,cAAc,SAAe,YAAkB;AACrD,MAAI,UAAU,QAAQ,CAAE,QAAO,YAAY,QAAQ;AACnD,MAAI,WAAW,QAAQ,CAAE,aAAY,cAAc,QAAQ;AAC3D,MAAI,YAAY,QAAQ,CAAE,cAAa,cAAc,QAAQ;AAI7D,MAFkB,WAAW,WAAW,SAAS,QAAQ,EAE1C;AACb,cAAW,gBAAgB;IACzB,UAAU,QAAQ,OAAO;IACzB,MAAM,QAAQ,OAAO;IACtB,CAAC;AAEF,OAAI,WAAW,QAAQ,CAAE,aAAY,cAAc,QAAQ;AAC3D,OAAI,YAAY,QAAQ,CAAE,cAAa,cAAc,QAAQ;AAC7D,OAAI,UAAU,QAAQ,CAAE,QAAO,SAAS,QAAQ;;GAElD;AAEF,SAAQ,cAAc,SAAe;AAGnC,MAFkB,WAAW,WAAW,KAAK,EAE9B;AACb,cAAW,gBAAgB;IACzB,UAAU,KAAK,OAAO;IACtB,MAAM,KAAK,OAAO;IACnB,CAAC;AAEF,OAAI,UAAU,KAAK,CAAE,QAAO,SAAS,KAAK;AAC1C,OAAI,YAAY,KAAK,CAAE,cAAa,cAAc,KAAK;AACvD,OAAI,WAAW,KAAK,CAAE,aAAY,cAAc,KAAK;;GAEvD;AAEF,SAAQ,cAAc,SAAe;AACnC,aAAW,gBAAgB;GACzB,UAAU,KAAK,OAAO;GACtB,MAAM,KAAK,OAAO;GACnB,CAAC;AAEF,MAAI,UAAU,KAAK,CAAE,QAAO,YAAY,KAAK;AAC7C,MAAI,YAAY,KAAK,CAAE,cAAa,cAAc,KAAK;AACvD,MAAI,WAAW,KAAK,CAAE,aAAY,cAAc,KAAK;AAErD,aAAW,WAAW,KAAK;GAC3B;;AAGJ,MAAa,qBACX,YACA,QACA,cACA,gBACG;CACH,MAAM,UAAU,QAAQ,KAAK;CAC7B,MAAM,OAAO,CAAC,KAAK,KAAK,SAAS,QAAQ,EAAE,KAAK,KAAK,SAAS,MAAM,CAAC;CACrE,MAAMA,WAAsB,EAAE;AAE9B,MAAK,SAAS,QAAQ;AACpB,MAAI,WAAW,IAAI,EAAE;GACnB,MAAM,UAAU,IAAI,QAAQ,KAAK,WAAW;AAC5C,wBAAqB,SAAS,YAAY,QAAQ,cAAc,YAAY;AAC5E,WAAQ,MAAM;AACd,YAAS,KAAK,QAAQ;;GAExB;AAEF,QAAO,EACL,MAAM,YAAY;AAChB,QAAM,QAAQ,IAAI,SAAS,KAAK,YAAY,QAAQ,MAAM,CAAC,CAAC;IAE/D"}