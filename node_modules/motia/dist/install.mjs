import { getStepFiles, getStreamFiles } from "./generate-locked-data.mjs";
import { executeCommand } from "./utils/execute-command.mjs";
import { getPythonCommand } from "./utils/python-version-utils.mjs";
import { activatePythonVenv } from "./utils/activate-python-env.mjs";
import { ensureUvInstalled } from "./utils/ensure-uv.mjs";
import { installLambdaPythonPackages } from "./utils/install-lambda-python-packages.mjs";
import fs from "fs";
import path from "path";

//#region src/install.ts
const pythonInstall = async ({ baseDir, isVerbose = false, pythonVersion = "3.13" }) => {
	const venvPath = path.join(baseDir, "python_modules");
	console.log("ðŸ“¦ Installing Python dependencies...", venvPath);
	const requirementsList = [
		path.join(baseDir, "node_modules", "motia", "dist", "requirements-core.txt"),
		path.join(baseDir, "node_modules", "motia", "dist", "requirements-snap.txt"),
		path.join(baseDir, "requirements.txt")
	];
	try {
		const pythonCmd = await getPythonCommand(pythonVersion, baseDir);
		if (isVerbose) console.log(`ðŸ Using Python command: ${pythonCmd}`);
		if (!fs.existsSync(venvPath)) {
			console.log("ðŸ“¦ Creating Python virtual environment...");
			await executeCommand(`${pythonCmd} -m venv python_modules`, baseDir);
		}
		activatePythonVenv({
			baseDir,
			isVerbose,
			pythonVersion
		});
		console.log("ðŸ”§ Checking UV installation...");
		await ensureUvInstalled();
		console.log("âœ… UV is available");
		installLambdaPythonPackages({
			isVerbose,
			requirementsList
		});
		console.log("ðŸ“¥ Installing Python dependencies...");
		for (const requirement of requirementsList) if (fs.existsSync(requirement)) {
			if (isVerbose) console.log("ðŸ“„ Using requirements from:", requirement);
			await executeCommand(`pip install -r "${requirement}" --only-binary=:all:`, baseDir);
		}
	} catch (error) {
		const errorMessage = error instanceof Error ? error.message : String(error);
		console.error("âŒ Installation failed:", errorMessage);
		process.exit(1);
	}
};
const install = async ({ isVerbose = false, pythonVersion = "3.13" }) => {
	const baseDir = process.cwd();
	const steps = getStepFiles(baseDir);
	const streams = getStreamFiles(baseDir);
	if (steps.some((file) => file.endsWith(".py")) || streams.some((file) => file.endsWith(".py"))) await pythonInstall({
		baseDir,
		isVerbose,
		pythonVersion
	});
	console.info("âœ… Installation completed successfully!");
	process.exit(0);
};

//#endregion
export { install, pythonInstall };
//# sourceMappingURL=install.mjs.map