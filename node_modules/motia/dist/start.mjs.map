{"version":3,"file":"start.mjs","names":["redisClient: RedisClientType","plugins: MotiaPlugin[]"],"sources":["../src/start.ts"],"sourcesContent":["import { BullMQEventAdapter } from '@motiadev/adapter-bullmq-events'\nimport { RedisCronAdapter } from '@motiadev/adapter-redis-cron'\nimport { RedisStateAdapter } from '@motiadev/adapter-redis-state'\nimport { RedisStreamAdapterManager } from '@motiadev/adapter-redis-streams'\nimport { createServer, type MotiaPlugin } from '@motiadev/core'\nimport path from 'path'\nimport type { RedisClientType } from 'redis'\nimport { workbenchBase } from './constants'\nimport { generateLockedData, getStepFiles, getStreamFiles } from './generate-locked-data'\nimport { loadMotiaConfig } from './load-motia-config'\nimport { processPlugins } from './plugins/index'\nimport { getRedisClient, getRedisConnectionInfo, stopRedisConnection } from './redis/connection'\nimport { activatePythonVenv } from './utils/activate-python-env'\nimport { listenWithFallback } from './utils/listen-with-fallback'\nimport { validatePythonEnvironment } from './utils/validate-python-environment'\nimport { version } from './version'\n\nexport const start = async (\n  port: number,\n  hostname: string,\n  disableVerbose: boolean,\n  motiaFileStorageDir?: string,\n): Promise<void> => {\n  const baseDir = process.cwd()\n  const isVerbose = !disableVerbose\n\n  const stepFiles = [...getStepFiles(baseDir), ...getStreamFiles(baseDir)]\n  const hasPythonFiles = stepFiles.some((file) => file.endsWith('.py'))\n\n  const pythonValidation = await validatePythonEnvironment({ baseDir, hasPythonFiles })\n  if (!pythonValidation.success) {\n    process.exit(1)\n  }\n\n  if (pythonValidation.hasPythonFiles) {\n    console.log('âš™ï¸ Activating Python environment...')\n    activatePythonVenv({ baseDir, isVerbose })\n  }\n\n  const motiaFileStoragePath = motiaFileStorageDir || '.motia'\n\n  const dotMotia = path.join(baseDir, motiaFileStoragePath)\n  const appConfig = await loadMotiaConfig(baseDir)\n\n  const redisClient: RedisClientType = await getRedisClient(dotMotia, appConfig)\n\n  const adapters = {\n    eventAdapter:\n      appConfig.adapters?.events ||\n      new BullMQEventAdapter({\n        connection: getRedisConnectionInfo(),\n      }),\n    cronAdapter: appConfig.adapters?.cron || new RedisCronAdapter(redisClient),\n    streamAdapter: appConfig.adapters?.streams || new RedisStreamAdapterManager(redisClient),\n  }\n  const lockedData = await generateLockedData({\n    projectDir: baseDir,\n    streamAdapter: adapters.streamAdapter,\n    redisClient,\n    streamAuth: appConfig.streamAuth,\n  })\n\n  const state = appConfig.adapters?.state || new RedisStateAdapter(redisClient)\n\n  const config = { isVerbose, isDev: false, version }\n\n  const motiaServer = createServer(lockedData, state, config, adapters, appConfig.app)\n  const plugins: MotiaPlugin[] = await processPlugins(motiaServer)\n\n  if (!process.env.MOTIA_DOCKER_DISABLE_WORKBENCH) {\n    const { applyMiddleware } = await import('@motiadev/workbench/middleware')\n    await applyMiddleware({\n      app: motiaServer.app,\n      port,\n      workbenchBase,\n      plugins: plugins.flatMap((item) => item.workbench),\n    })\n  }\n\n  const actualPort = await listenWithFallback(motiaServer.server, port, hostname)\n  if (actualPort !== port) {\n    console.log(`âš ï¸  Port ${port} was in use, using port ${actualPort} instead`)\n  }\n  console.log('ðŸš€ Server ready and listening on port', actualPort)\n  console.log(`ðŸ”— Open http://${hostname}:${actualPort}${workbenchBase} to open workbench ðŸ› ï¸`)\n\n  process.on('SIGTERM', async () => {\n    motiaServer.server.close()\n    await stopRedisConnection()\n    process.exit(0)\n  })\n\n  process.on('SIGINT', async () => {\n    motiaServer.server.close()\n    await stopRedisConnection()\n    process.exit(0)\n  })\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAiBA,MAAa,QAAQ,OACnB,MACA,UACA,gBACA,wBACkB;CAClB,MAAM,UAAU,QAAQ,KAAK;CAC7B,MAAM,YAAY,CAAC;CAKnB,MAAM,mBAAmB,MAAM,0BAA0B;EAAE;EAAS,gBAHlD,CAAC,GAAG,aAAa,QAAQ,EAAE,GAAG,eAAe,QAAQ,CAAC,CACvC,MAAM,SAAS,KAAK,SAAS,MAAM,CAAC;EAEe,CAAC;AACrF,KAAI,CAAC,iBAAiB,QACpB,SAAQ,KAAK,EAAE;AAGjB,KAAI,iBAAiB,gBAAgB;AACnC,UAAQ,IAAI,sCAAsC;AAClD,qBAAmB;GAAE;GAAS;GAAW,CAAC;;CAG5C,MAAM,uBAAuB,uBAAuB;CAEpD,MAAM,WAAW,KAAK,KAAK,SAAS,qBAAqB;CACzD,MAAM,YAAY,MAAM,gBAAgB,QAAQ;CAEhD,MAAMA,cAA+B,MAAM,eAAe,UAAU,UAAU;CAE9E,MAAM,WAAW;EACf,cACE,UAAU,UAAU,UACpB,IAAI,mBAAmB,EACrB,YAAY,wBAAwB,EACrC,CAAC;EACJ,aAAa,UAAU,UAAU,QAAQ,IAAI,iBAAiB,YAAY;EAC1E,eAAe,UAAU,UAAU,WAAW,IAAI,0BAA0B,YAAY;EACzF;CAYD,MAAM,cAAc,aAXD,MAAM,mBAAmB;EAC1C,YAAY;EACZ,eAAe,SAAS;EACxB;EACA,YAAY,UAAU;EACvB,CAAC,EAEY,UAAU,UAAU,SAAS,IAAI,kBAAkB,YAAY,EAE9D;EAAE;EAAW,OAAO;EAAO;EAAS,EAES,UAAU,UAAU,IAAI;CACpF,MAAMC,UAAyB,MAAM,eAAe,YAAY;AAEhE,KAAI,CAAC,QAAQ,IAAI,gCAAgC;EAC/C,MAAM,EAAE,oBAAoB,MAAM,OAAO;AACzC,QAAM,gBAAgB;GACpB,KAAK,YAAY;GACjB;GACA;GACA,SAAS,QAAQ,SAAS,SAAS,KAAK,UAAU;GACnD,CAAC;;CAGJ,MAAM,aAAa,MAAM,mBAAmB,YAAY,QAAQ,MAAM,SAAS;AAC/E,KAAI,eAAe,KACjB,SAAQ,IAAI,YAAY,KAAK,0BAA0B,WAAW,UAAU;AAE9E,SAAQ,IAAI,yCAAyC,WAAW;AAChE,SAAQ,IAAI,kBAAkB,SAAS,GAAG,aAAa,cAAc,wBAAwB;AAE7F,SAAQ,GAAG,WAAW,YAAY;AAChC,cAAY,OAAO,OAAO;AAC1B,QAAM,qBAAqB;AAC3B,UAAQ,KAAK,EAAE;GACf;AAEF,SAAQ,GAAG,UAAU,YAAY;AAC/B,cAAY,OAAO,OAAO;AAC1B,QAAM,qBAAqB;AAC3B,UAAQ,KAAK,EAAE;GACf"}