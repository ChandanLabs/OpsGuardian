import { collectPluginSteps } from "./collect-plugin-steps.mjs";
import { PLUGIN_FLOW_ID } from "@motiadev/core";
import { randomUUID } from "node:crypto";

//#region src/plugins/process-steps.ts
const processSteps = async (motiaServer, plugins, baseDir) => {
	const { motia, addRoute, printer } = motiaServer;
	for (const plugin of plugins) if (plugin.dirname && plugin.steps) {
		printer.printPluginLog(`Loading steps from ${plugin.dirname}`);
		try {
			const pluginSteps = await collectPluginSteps(plugin.dirname, plugin.steps, baseDir, printer);
			const version = `plugin_${randomUUID()}:${Math.floor(Date.now() / 1e3)}`;
			for (const { filePath, config } of pluginSteps) try {
				if (motia.lockedData.createStep({
					filePath,
					version,
					config: {
						...config,
						flows: [PLUGIN_FLOW_ID]
					}
				}, { disableTypeCreation: true })) {
					const step = motia.lockedData.activeSteps.find((s) => s.filePath === filePath);
					if (step && step.config.type === "api") addRoute(step);
				} else printer.printPluginWarn(`Failed to register step: ${config.name} from ${filePath}`);
			} catch (error) {
				printer.printPluginError(`Error registering step ${filePath}:`, error);
			}
		} catch (error) {
			printer.printPluginError(`Error loading steps from ${plugin.dirname}:`, error);
		}
	}
};

//#endregion
export { processSteps };
//# sourceMappingURL=process-steps.mjs.map