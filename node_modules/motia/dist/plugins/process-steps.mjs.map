{"version":3,"file":"process-steps.mjs","names":[],"sources":["../../src/plugins/process-steps.ts"],"sourcesContent":["import { randomUUID } from 'node:crypto'\nimport { type MotiaPlugin, type MotiaServer, PLUGIN_FLOW_ID } from '@motiadev/core'\nimport { collectPluginSteps } from './collect-plugin-steps'\n\nexport const processSteps = async (\n  motiaServer: MotiaServer,\n  plugins: MotiaPlugin[],\n  baseDir: string,\n): Promise<void> => {\n  const { motia, addRoute, printer } = motiaServer\n  for (const plugin of plugins) {\n    if (plugin.dirname && plugin.steps) {\n      printer.printPluginLog(`Loading steps from ${plugin.dirname}`)\n      try {\n        const pluginSteps = await collectPluginSteps(plugin.dirname, plugin.steps, baseDir, printer)\n        const version = `plugin_${randomUUID()}:${Math.floor(Date.now() / 1000)}`\n\n        for (const { filePath, config } of pluginSteps) {\n          try {\n            const isCreated = motia.lockedData.createStep(\n              { filePath, version, config: { ...config, flows: [PLUGIN_FLOW_ID] } },\n              { disableTypeCreation: true },\n            )\n\n            if (isCreated) {\n              const step = motia.lockedData.activeSteps.find((s) => s.filePath === filePath)\n              if (step && step.config.type === 'api') {\n                // biome-ignore lint/suspicious/noExplicitAny: Step type casting needed for route handler\n                addRoute(step as any)\n              }\n            } else {\n              printer.printPluginWarn(`Failed to register step: ${config.name} from ${filePath}`)\n            }\n          } catch (error) {\n            printer.printPluginError(`Error registering step ${filePath}:`, error)\n          }\n        }\n      } catch (error) {\n        printer.printPluginError(`Error loading steps from ${plugin.dirname}:`, error)\n      }\n    }\n  }\n}\n"],"mappings":";;;;;AAIA,MAAa,eAAe,OAC1B,aACA,SACA,YACkB;CAClB,MAAM,EAAE,OAAO,UAAU,YAAY;AACrC,MAAK,MAAM,UAAU,QACnB,KAAI,OAAO,WAAW,OAAO,OAAO;AAClC,UAAQ,eAAe,sBAAsB,OAAO,UAAU;AAC9D,MAAI;GACF,MAAM,cAAc,MAAM,mBAAmB,OAAO,SAAS,OAAO,OAAO,SAAS,QAAQ;GAC5F,MAAM,UAAU,UAAU,YAAY,CAAC,GAAG,KAAK,MAAM,KAAK,KAAK,GAAG,IAAK;AAEvE,QAAK,MAAM,EAAE,UAAU,YAAY,YACjC,KAAI;AAMF,QALkB,MAAM,WAAW,WACjC;KAAE;KAAU;KAAS,QAAQ;MAAE,GAAG;MAAQ,OAAO,CAAC,eAAe;MAAE;KAAE,EACrE,EAAE,qBAAqB,MAAM,CAC9B,EAEc;KACb,MAAM,OAAO,MAAM,WAAW,YAAY,MAAM,MAAM,EAAE,aAAa,SAAS;AAC9E,SAAI,QAAQ,KAAK,OAAO,SAAS,MAE/B,UAAS,KAAY;UAGvB,SAAQ,gBAAgB,4BAA4B,OAAO,KAAK,QAAQ,WAAW;YAE9E,OAAO;AACd,YAAQ,iBAAiB,0BAA0B,SAAS,IAAI,MAAM;;WAGnE,OAAO;AACd,WAAQ,iBAAiB,4BAA4B,OAAO,QAAQ,IAAI,MAAM"}