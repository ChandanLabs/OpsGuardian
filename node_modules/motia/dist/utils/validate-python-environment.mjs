import { internalLogger } from "./internal-logger.mjs";
import { getPythonCommand } from "./python-version-utils.mjs";
import { getPackageManager } from "./get-package-manager.mjs";
import fs from "fs";
import path from "path";

//#region src/utils/validate-python-environment.ts
function getInstallCommand(baseDir) {
	switch (getPackageManager(baseDir)) {
		case "yarn": return "yarn install";
		case "pnpm": return "pnpm install";
		case "npm":
		default: return "npm install";
	}
}
async function validatePythonEnvironment({ baseDir, hasPythonFiles, pythonVersion = "3.13" }) {
	if (!hasPythonFiles) return {
		success: true,
		hasPythonFiles: false
	};
	const installCmd = getInstallCommand(baseDir);
	try {
		await getPythonCommand(pythonVersion, baseDir);
	} catch {
		internalLogger.error("Python is not installed");
		internalLogger.info("Python files were detected in your project but Python 3 is not available");
		internalLogger.info("Please install Python 3.10 or higher: https://www.python.org/downloads/");
		return {
			success: false,
			hasPythonFiles: true
		};
	}
	const venvPath = path.join(baseDir, "python_modules");
	if (!fs.existsSync(venvPath)) {
		internalLogger.error("Python environment not configured");
		internalLogger.info("The python_modules directory was not found");
		internalLogger.info(`Run '${installCmd}' to set up your Python environment`);
		return {
			success: false,
			hasPythonFiles: true
		};
	}
	const libPath = path.join(venvPath, "lib");
	if (!fs.existsSync(libPath)) {
		internalLogger.error("Python environment is incomplete");
		internalLogger.info("The python_modules directory exists but appears to be corrupted");
		internalLogger.info(`Run '${installCmd}' to recreate your Python environment`);
		return {
			success: false,
			hasPythonFiles: true
		};
	}
	try {
		if (fs.readdirSync(libPath).filter((item) => item.startsWith("python3")).length === 0) {
			internalLogger.error("Python environment is incomplete");
			internalLogger.info("The python_modules/lib directory exists but contains no Python version directories");
			internalLogger.info(`Run '${installCmd}' to recreate your Python environment`);
			return {
				success: false,
				hasPythonFiles: true
			};
		}
	} catch (error) {
		internalLogger.error("Python environment is incomplete");
		internalLogger.info("The python_modules/lib directory cannot be read");
		internalLogger.info(`Run '${installCmd}' to recreate your Python environment`);
		return {
			success: false,
			hasPythonFiles: true
		};
	}
	return {
		success: true,
		hasPythonFiles: true
	};
}

//#endregion
export { validatePythonEnvironment };
//# sourceMappingURL=validate-python-environment.mjs.map