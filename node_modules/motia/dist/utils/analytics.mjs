import { BuildError } from "./errors/build.error.mjs";
import { version } from "../version.mjs";
import { MotiaEnrichmentPlugin } from "./amplitude/enrichment-plugin.mjs";
import { getProjectName, getUserIdentifier, isAnalyticsEnabled, trackEvent } from "@motiadev/core";
import { Identify, Types, add, flush, identify, init, setOptOut } from "@amplitude/analytics-node";

//#region src/utils/analytics.ts
init("ab2408031a38aa5cb85587a27ecfc69c", { logLevel: Types.LogLevel.None });
const updateOptOutStatus = () => {
	setOptOut(!isAnalyticsEnabled());
};
updateOptOutStatus();
add(new MotiaEnrichmentPlugin());
const identifyUser = () => {
	try {
		const identifyObj = new Identify();
		identifyObj.postInsert("project_id", getProjectName(process.cwd()));
		identifyObj.postInsert("motia_version", version || "unknown");
		identifyObj.postInsert("project_version", process.env.npm_package_version || "unknown");
		identify(identifyObj, { user_id: getUserIdentifier() });
	} catch (error) {}
};
const logCliError = (command, error) => {
	try {
		const cause = error.cause instanceof BuildError ? error.cause : error;
		const errorMessage = cause?.message || "Unknown error";
		const errorType = cause?.constructor?.name || "Unknown error type";
		const errorStack = cause?.stack ? cause.stack.split("\n").slice(0, 10).join("\n") : void 0;
		trackEvent("cli_command_error", {
			command,
			error_message: errorMessage.length > 500 ? `${errorMessage.substring(0, 500)}...` : errorMessage,
			error_type: errorType,
			...errorStack && { error_stack: errorStack }
		});
	} catch (logError) {}
};
const getCommandNameFromArgs = () => {
	const args = process.argv.slice(2);
	const commandParts = [];
	for (let i = 0; i < args.length && i < 3; i++) {
		const arg = args[i];
		if (!arg.startsWith("-") && !arg.startsWith("--")) commandParts.push(arg);
		else break;
	}
	return commandParts.join(" ") || "unknown";
};
const wrapAction = (action) => {
	return (async (...args) => {
		try {
			return await action(...args);
		} catch (error) {
			const commandName = getCommandNameFromArgs();
			if (error instanceof BuildError) logCliError(commandName, error);
			await flush().promise.catch(() => {});
			throw error;
		}
	});
};

//#endregion
export { identifyUser, logCliError, wrapAction };
//# sourceMappingURL=analytics.mjs.map