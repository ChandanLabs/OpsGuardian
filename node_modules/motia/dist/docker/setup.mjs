import { identifyUser } from "../utils/analytics.mjs";
import { printMotiaDockerIntro } from "./utils/print-intro.mjs";
import { getProjectIdentifier, trackEvent } from "@motiadev/core";
import * as fs$1 from "fs";
import * as path$1 from "path";
import { fileURLToPath } from "url";
import * as readline$1 from "readline";

//#region src/docker/setup.ts
const __dirname = path$1.dirname(fileURLToPath(import.meta.url));
const resolveTemplatesDir = () => {
	const localTemplates = path$1.join(__dirname, "./templates");
	if (fs$1.existsSync(localTemplates)) return localTemplates;
	return path$1.join(__dirname, "../../../docker/templates");
};
const templatesDir = resolveTemplatesDir();
const updatePackageJson = () => {
	const packageJsonPath = path$1.join(process.cwd(), "package.json");
	if (fs$1.existsSync(packageJsonPath)) {
		const packageJson = JSON.parse(fs$1.readFileSync(packageJsonPath, "utf-8"));
		if (!packageJson.scripts) packageJson.scripts = {};
		packageJson.scripts.start = "motia start";
		fs$1.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2));
		console.log("Updated package.json with start script");
	}
};
const createDockerfile = async () => {
	const dockerfilePath = path$1.join(process.cwd(), "Dockerfile");
	if (fs$1.existsSync(dockerfilePath)) {
		console.log("Dockerfile already exists");
		const rl = readline$1.createInterface({
			input: process.stdin,
			output: process.stdout
		});
		if (!await new Promise((resolve) => {
			rl.question("Do you want to override the existing Dockerfile? (y/N): ", (answer) => {
				rl.close();
				resolve(answer.toLowerCase() === "y" || answer.toLowerCase() === "yes");
			});
		})) {
			console.log("Dockerfile generation cancelled");
			return;
		}
	}
	const dockerfileContent = fs$1.readFileSync(path$1.join(templatesDir, "MotiaDockerSample"), "utf-8");
	try {
		fs$1.writeFileSync(dockerfilePath, dockerfileContent);
		console.log("Dockerfile generated successfully!");
	} catch (error) {
		console.error("Error generating Dockerfile:", error.message);
		throw error;
	}
};
const createDockerignore = async () => {
	identifyUser();
	trackEvent("docker_setup_command", { project_name: getProjectIdentifier(process.cwd()) });
	const dockerignoreContent = fs$1.readFileSync(path$1.join(templatesDir, ".dockerignore.sample"), "utf-8");
	const dockerignorePath = path$1.join(process.cwd(), ".dockerignore");
	if (fs$1.existsSync(dockerignorePath)) {
		console.log(".dockerignore already exists");
		const rl = readline$1.createInterface({
			input: process.stdin,
			output: process.stdout
		});
		if (!await new Promise((resolve) => {
			rl.question("Do you want to override the existing .dockerignore? (y/N): ", (answer) => {
				rl.close();
				resolve(answer.toLowerCase() === "y" || answer.toLowerCase() === "yes");
			});
		})) {
			console.log(".dockerignore generation cancelled");
			return;
		}
	}
	try {
		fs$1.writeFileSync(dockerignorePath, dockerignoreContent);
		console.log(".dockerignore generated successfully!");
	} catch (error) {
		console.error("Error generating .dockerignore:", error.message);
		throw error;
	}
};
const setup = async () => {
	printMotiaDockerIntro();
	await createDockerfile();
	await createDockerignore();
	updatePackageJson();
};

//#endregion
export { setup };
//# sourceMappingURL=setup.mjs.map