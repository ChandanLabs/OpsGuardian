import { identifyUser } from "../utils/analytics.mjs";
import { promiseExec } from "./utils/promised-exec.mjs";
import { buildDockerImage } from "./utils/build-docker-image.mjs";
import { printMotiaDockerIntro } from "./utils/print-intro.mjs";
import { getProjectIdentifier, trackEvent } from "@motiadev/core";
import * as fs$1 from "fs";
import * as path$1 from "path";

//#region src/docker/run.ts
const run = async (hostPort = 3e3, projectName, skipBuild) => {
	printMotiaDockerIntro();
	identifyUser();
	let nextProjectName = projectName;
	if (!projectName) {
		const packageJsonPath = path$1.join(process.cwd(), "package.json");
		nextProjectName = JSON.parse(fs$1.readFileSync(packageJsonPath, "utf-8")).name;
	}
	trackEvent("docker_run_command", {
		dockerImageName: nextProjectName,
		project_name: getProjectIdentifier(process.cwd())
	});
	console.log(`Preparing your docker container for project: ${nextProjectName}`);
	const dockerPort = fs$1.readFileSync(path$1.join(process.cwd(), "Dockerfile"), "utf-8").match(/EXPOSE\s+(\d+)/)?.[1] || "3000";
	if (!fs$1.existsSync(path$1.join(process.cwd(), "Dockerfile"))) {
		console.error("Dockerfile not found");
		process.exit(1);
	}
	let dockerImageName = nextProjectName;
	const dockerRunCommand = `docker run -it --rm -p ${hostPort}:${dockerPort} ${dockerImageName}`;
	if (!skipBuild) dockerImageName = await buildDockerImage(dockerImageName);
	else try {
		await promiseExec(`docker image inspect ${dockerImageName}`, false);
		console.log(`Docker image ${dockerImageName} found`);
	} catch (error) {
		console.error(`Docker image ${dockerImageName} not found, remove the skip flag to build it`);
		process.exit(1);
	}
	console.log(`Running docker container: ${dockerImageName}`);
	await promiseExec(dockerRunCommand);
};

//#endregion
export { run };
//# sourceMappingURL=run.mjs.map