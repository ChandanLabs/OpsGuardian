{"version":3,"file":"generate-locked-data.mjs","names":["invalidSteps: Step[]"],"sources":["../src/generate-locked-data.ts"],"sourcesContent":["import {\n  getStepConfig,\n  getStreamConfig,\n  type JsonSchema,\n  LockedData,\n  MemoryStreamAdapterManager,\n  NoPrinter,\n  Printer,\n  type Step,\n  type StreamAdapterManager,\n  type StreamAuthConfig,\n} from '@motiadev/core'\nimport { randomUUID } from 'crypto'\nimport { existsSync } from 'fs'\nimport { globSync } from 'glob'\nimport path from 'path'\nimport pc from 'picocolors'\nimport type { RedisClientType } from 'redis'\nimport { CompilationError } from './utils/errors/compilation.error'\nimport { LockedDataGenerationError } from './utils/errors/locked-data-generation.error'\n\nconst version = `${randomUUID()}:${Math.floor(Date.now() / 1000)}`\n\nconst getStepFilesFromDir = (dir: string): string[] => {\n  if (!existsSync(dir)) {\n    return []\n  }\n  return [\n    ...globSync('**/*.step.{ts,js,rb}', { absolute: true, cwd: dir }),\n    ...globSync('**/*_step.{ts,js,py,rb}', { absolute: true, cwd: dir }),\n  ]\n}\n\nexport const getStepFiles = (projectDir: string): string[] => {\n  const stepsDir = path.join(projectDir, 'steps')\n  const srcDir = path.join(projectDir, 'src')\n  return [...getStepFilesFromDir(stepsDir), ...getStepFilesFromDir(srcDir)]\n}\n\nconst getStreamFilesFromDir = (dir: string): string[] => {\n  if (!existsSync(dir)) {\n    return []\n  }\n  return [\n    ...globSync('**/*.stream.{ts,js,rb}', { absolute: true, cwd: dir }),\n    ...globSync('**/*_stream.{ts,js,py,rb}', { absolute: true, cwd: dir }),\n  ]\n}\n\nexport const getStreamFiles = (projectDir: string): string[] => {\n  const stepsDir = path.join(projectDir, 'steps')\n  const srcDir = path.join(projectDir, 'src')\n  return [...getStreamFilesFromDir(stepsDir), ...getStreamFilesFromDir(srcDir)]\n}\n\n// Helper function to recursively collect flow data\nexport const collectFlows = async (projectDir: string, lockedData: LockedData): Promise<Step[]> => {\n  const invalidSteps: Step[] = []\n  const stepFiles = getStepFiles(projectDir)\n  const streamFiles = getStreamFiles(projectDir)\n  const stepsDir = path.join(projectDir, 'steps')\n  const srcDir = path.join(projectDir, 'src')\n  const deprecatedSteps = [\n    ...(existsSync(stepsDir) ? globSync('**/*.step.py', { absolute: true, cwd: stepsDir }) : []),\n    ...(existsSync(srcDir) ? globSync('**/*.step.py', { absolute: true, cwd: srcDir }) : []),\n  ]\n\n  for (const filePath of stepFiles) {\n    try {\n      const config = await getStepConfig(filePath, projectDir)\n\n      if (!config) {\n        console.warn(`No config found in step ${filePath}, step skipped`)\n        continue\n      }\n\n      const result = lockedData.createStep({ filePath, version, config }, { disableTypeCreation: true })\n\n      if (!result) {\n        invalidSteps.push({ filePath, version, config })\n      }\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : String(err)\n      if (errorMessage.includes('Executable ruby not found') || errorMessage.includes('Executable python not found')) {\n        console.warn(pc.yellow(`! [WARNING] Skipping step ${filePath}: ${errorMessage}`))\n        continue\n      }\n      throw new CompilationError(`Error collecting flow ${filePath}`, path.relative(projectDir, filePath), err as Error)\n    }\n  }\n\n  for (const filePath of streamFiles) {\n    const config = await getStreamConfig(filePath)\n\n    if (!config) {\n      console.warn(`No config found in stream ${filePath}, stream skipped`)\n      continue\n    }\n\n    lockedData.createStream({ filePath, config }, { disableTypeCreation: true })\n  }\n\n  if (deprecatedSteps.length > 0) {\n    const warning = pc.yellow('! [WARNING]')\n    console.warn(\n      pc.yellow(\n        [\n          '',\n          '========================================',\n          warning,\n          '',\n          `Python steps with ${pc.gray('.step.py')} extensions are no longer supported.`,\n          `Please rename them to ${pc.gray('_step.py')}.`,\n          '',\n          pc.bold('Steps:'),\n          ...deprecatedSteps.map((step) =>\n            pc.reset(\n              `- ${pc.cyan(pc.bold(step.replace(projectDir, '')))} rename to ${pc.gray(`${step.replace(projectDir, '').replace('.step.py', '_step.py')}`)}`,\n            ),\n          ),\n\n          '',\n          'Make sure the step names are importable from Python:',\n          `- Don't use numbers, dots, dashes, commas, spaces, colons, or special characters`,\n          '========================================',\n          '',\n        ].join('\\n'),\n      ),\n    )\n  }\n\n  return invalidSteps\n}\n\ntype StreamAuthOptions = {\n  authenticate: StreamAuthConfig['authenticate']\n  contextSchema?: JsonSchema\n}\n\nexport const generateLockedData = async (config: {\n  projectDir: string\n  streamAdapter?: StreamAdapterManager\n  redisClient?: RedisClientType\n  printerType?: 'disabled' | 'default'\n  streamAuth?: StreamAuthOptions\n}): Promise<LockedData> => {\n  try {\n    const {\n      projectDir,\n      streamAdapter = new MemoryStreamAdapterManager(),\n      printerType = 'default',\n      redisClient,\n      streamAuth,\n    } = config\n    const printer = printerType === 'disabled' ? new NoPrinter() : new Printer(projectDir)\n    /*\n     * NOTE: right now for performance and simplicity let's enforce a folder,\n     * but we might want to remove this and scan the entire current directory\n     */\n    const lockedData = new LockedData(projectDir, streamAdapter, printer, redisClient)\n    lockedData.setStreamAuthConfig(streamAuth)\n\n    await collectFlows(projectDir, lockedData)\n    lockedData.saveTypes()\n\n    return lockedData\n  } catch (error) {\n    console.error(error)\n\n    throw new LockedDataGenerationError(\n      'Failed to parse the project, generating locked data step failed',\n      error as Error,\n    )\n  }\n}\n"],"mappings":"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"}