{"version":3,"file":"generate.mjs","names":["replacements: Record<string, string>","version","path","fs","fd: fs.FileHandle | null","fd"],"sources":["../../../src/create/templates/generate.ts"],"sourcesContent":["import { constants, promises as fs, mkdirSync, statSync } from 'fs'\nimport { globSync } from 'glob'\nimport * as path from 'path'\nimport { fileURLToPath } from 'url'\nimport type { CliContext } from '../../cloud/config-utils'\nimport { version } from '../../version'\n\nexport type Generator = (rootDir: string, context: CliContext) => Promise<void>\n\nconst replaceTemplateVariables = (content: string, projectName: string, version?: string): string => {\n  const replacements: Record<string, string> = {\n    '{{PROJECT_NAME}}': projectName,\n    '{{PLUGIN_NAME}}': toPascalCase(projectName),\n    '{{VERSION}}': version || 'latest',\n  }\n\n  return Object.entries(replacements).reduce((result, [key, value]) => {\n    return result.replace(new RegExp(key, 'g'), value)\n  }, content)\n}\n\nconst toPascalCase = (str: string): string => {\n  // Remove @ and scope if present\n  const name = str.replace(/^@[^/]+\\//, '')\n  return name\n    .split(/[-_]/)\n    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\n    .join('')\n}\nconst __dirname = path.dirname(fileURLToPath(import.meta.url))\n\nexport const generateTemplateSteps = (templateFolder: string): Generator => {\n  return async (rootDir: string, context: CliContext): Promise<void> => {\n    const templatePath = path.join(__dirname, templateFolder)\n    const files = globSync('**/*', { absolute: false, cwd: templatePath, dot: true })\n    const projectName = path.basename(rootDir)\n\n    try {\n      for (const fileName of files) {\n        const filePath = path.join(templatePath, fileName)\n        const targetFilePath = path.join(rootDir, fileName)\n        const targetDir = path.dirname(targetFilePath)\n\n        mkdirSync(targetDir, { recursive: true })\n\n        if (statSync(filePath).isDirectory()) {\n          const folderPath = filePath.replace(templatePath, '')\n          mkdirSync(path.join(rootDir, folderPath), { recursive: true })\n          continue\n        }\n\n        const sanitizedFileName = fileName === 'requirements.txt' ? fileName : fileName.replace('.txt', '')\n        const isWorkbenchConfig = fileName.match('motia-workbench.json')\n        const generateFilePath = path.join(rootDir, sanitizedFileName)\n        let content = await fs.readFile(filePath, 'utf8')\n\n        if (isWorkbenchConfig) {\n          try {\n            // Use file descriptor to avoid TOCTOU vulnerability\n            let fd: fs.FileHandle | null = null\n            try {\n              // Try to open existing file for reading\n              fd = await fs.open(generateFilePath, constants.O_RDONLY)\n              const existingWorkbenchConfig = await fd.readFile('utf8')\n              const workbenchContent = JSON.parse(content)\n\n              content = JSON.stringify([...JSON.parse(existingWorkbenchConfig), ...workbenchContent], null, 2)\n\n              context.log('workbench-config-updated', (message) =>\n                message.tag('success').append('Workbench config').append('has been updated.'),\n              )\n            } finally {\n              if (fd) await fd.close()\n            }\n          } catch {\n            void 0\n          }\n        } else {\n          content = replaceTemplateVariables(content, projectName)\n        }\n\n        // Use file descriptor for atomic write operation\n        let fd: fs.FileHandle | null = null\n        try {\n          fd = await fs.open(generateFilePath, constants.O_CREAT | constants.O_WRONLY | constants.O_TRUNC, 0o644)\n          await fd.writeFile(content, 'utf8')\n        } finally {\n          if (fd) await fd.close()\n        }\n        context.log(sanitizedFileName, (message) => {\n          message.tag('success').append('File').append(sanitizedFileName, 'cyan').append('has been created.')\n        })\n      }\n    } catch (error) {\n      console.error('Error generating template files:', error)\n    }\n  }\n}\n\nexport const generatePluginTemplate = (templateFolder: string): Generator => {\n  return async (rootDir: string, context: CliContext): Promise<void> => {\n    const templatePath = path.join(__dirname, templateFolder)\n    const files = globSync('**/*', { absolute: false, cwd: templatePath, dot: true })\n    const projectName = path.basename(rootDir)\n\n    try {\n      for (const fileName of files) {\n        const filePath = path.join(templatePath, fileName)\n        const targetFilePath = path.join(rootDir, fileName)\n        const targetDir = path.dirname(targetFilePath)\n\n        mkdirSync(targetDir, { recursive: true })\n\n        if (statSync(filePath).isDirectory()) {\n          const folderPath = filePath.replace(templatePath, '')\n          mkdirSync(path.join(rootDir, folderPath), { recursive: true })\n          continue\n        }\n\n        const sanitizedFileName = fileName.replace('.txt', '')\n        const generateFilePath = path.join(rootDir, sanitizedFileName)\n        let content = await fs.readFile(filePath, 'utf8')\n\n        content = replaceTemplateVariables(content, projectName, version)\n\n        // Use file descriptor for atomic write operation\n        let fd: fs.FileHandle | null = null\n        try {\n          fd = await fs.open(generateFilePath, constants.O_CREAT | constants.O_WRONLY | constants.O_TRUNC, 0o644)\n          await fd.writeFile(content, 'utf8')\n        } finally {\n          if (fd) await fd.close()\n        }\n        context.log(sanitizedFileName, (message) => {\n          message.tag('success').append('File').append(sanitizedFileName, 'cyan').append('has been created.')\n        })\n      }\n    } catch (error) {\n      console.error('Error generating template files:', error)\n    }\n  }\n}\n"],"mappings":"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"}