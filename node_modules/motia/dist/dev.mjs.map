{"version":3,"file":"dev.mjs","names":["redisClient: RedisClientType","plugins: MotiaPlugin[]"],"sources":["../src/dev.ts"],"sourcesContent":["import { flush } from '@amplitude/analytics-node'\nimport { BullMQEventAdapter } from '@motiadev/adapter-bullmq-events'\nimport { RedisCronAdapter } from '@motiadev/adapter-redis-cron'\nimport { RedisStateAdapter } from '@motiadev/adapter-redis-state'\nimport { RedisStreamAdapterManager } from '@motiadev/adapter-redis-streams'\nimport {\n  createMermaidGenerator,\n  createServer,\n  getProjectIdentifier,\n  type MotiaPlugin,\n  trackEvent,\n} from '@motiadev/core'\nimport type { RedisClientType } from 'redis'\nimport { deployEndpoints } from './cloud/endpoints'\nimport { isTutorialDisabled, workbenchBase } from './constants'\nimport { createDevWatchers } from './dev-watchers'\nimport { generateLockedData, getStepFiles, getStreamFiles } from './generate-locked-data'\nimport { loadMotiaConfig } from './load-motia-config'\nimport { processPlugins } from './plugins'\nimport { getRedisClient, getRedisConnectionInfo, stopRedisConnection } from './redis/connection'\nimport { activatePythonVenv } from './utils/activate-python-env'\nimport { identifyUser } from './utils/analytics'\nimport { listenWithFallback } from './utils/listen-with-fallback'\nimport { validatePythonEnvironment } from './utils/validate-python-environment'\nimport { version } from './version'\n\nexport const dev = async (\n  port: number,\n  hostname: string,\n  disableVerbose: boolean,\n  enableMermaid: boolean,\n  motiaFileStorageDir?: string,\n): Promise<void> => {\n  const baseDir = process.cwd()\n  const isVerbose = !disableVerbose\n\n  identifyUser()\n\n  const stepFiles = [...getStepFiles(baseDir), ...getStreamFiles(baseDir)]\n  const hasPythonFiles = stepFiles.some((file) => file.endsWith('.py'))\n\n  trackEvent('dev_server_started', {\n    port,\n    verbose_mode: isVerbose,\n    mermaid_enabled: enableMermaid,\n    has_python_files: hasPythonFiles,\n    total_step_files: stepFiles.length,\n    project_name: getProjectIdentifier(baseDir),\n  })\n\n  const pythonValidation = await validatePythonEnvironment({ baseDir, hasPythonFiles })\n  if (!pythonValidation.success) {\n    process.exit(1)\n  }\n\n  if (pythonValidation.hasPythonFiles) {\n    activatePythonVenv({ baseDir, isVerbose })\n    trackEvent('python_environment_activated')\n  }\n\n  const motiaFileStoragePath = motiaFileStorageDir || '.motia'\n\n  const appConfig = await loadMotiaConfig(baseDir)\n\n  const redisClient: RedisClientType = await getRedisClient(motiaFileStoragePath, appConfig)\n\n  const adapters = {\n    eventAdapter:\n      appConfig.adapters?.events ||\n      new BullMQEventAdapter({\n        connection: getRedisConnectionInfo(),\n        prefix: 'motia:events',\n      }),\n    cronAdapter: appConfig.adapters?.cron || new RedisCronAdapter(redisClient),\n    streamAdapter: appConfig.adapters?.streams || new RedisStreamAdapterManager(redisClient),\n  }\n\n  const lockedData = await generateLockedData({\n    projectDir: baseDir,\n    streamAdapter: adapters.streamAdapter,\n    redisClient,\n    streamAuth: appConfig.streamAuth,\n  })\n\n  const state = appConfig.adapters?.state || new RedisStateAdapter(redisClient)\n\n  const config = { isVerbose }\n\n  const motiaServer = createServer(lockedData, state, config, adapters, appConfig.app)\n  const watcher = createDevWatchers(lockedData, motiaServer, motiaServer.motiaEventManager, motiaServer.cronManager)\n  const plugins: MotiaPlugin[] = await processPlugins(motiaServer)\n\n  // Initialize mermaid generator\n  if (enableMermaid) {\n    const mermaidGenerator = createMermaidGenerator(baseDir)\n    mermaidGenerator.initialize(lockedData)\n    trackEvent('mermaid_generator_initialized')\n  }\n\n  deployEndpoints(motiaServer, lockedData)\n\n  motiaServer.app.get('/__motia', (_, res) => {\n    const meta = {\n      version,\n      isDev: true,\n      isTutorialDisabled,\n      workbenchBase,\n    }\n\n    res //\n      .header('Access-Control-Allow-Origin', '*')\n      .header('Access-Control-Allow-Private-Network', 'true')\n      .status(200)\n      .json(meta)\n  })\n\n  trackEvent('dev_server_ready', {\n    port,\n    flows_count: lockedData.flows?.length || 0,\n    steps_count: lockedData.activeSteps?.length || 0,\n    flows: Object.keys(lockedData.flows || {}),\n    steps: lockedData.activeSteps.map((step) => step.config.name),\n    streams: Object.keys(lockedData.getStreams() || {}),\n    runtime_version: version,\n    environment: process.env.NODE_ENV || 'development',\n  })\n\n  const { applyMiddleware } = await import('@motiadev/workbench/middleware')\n\n  await applyMiddleware({\n    app: motiaServer.app,\n    port,\n    workbenchBase,\n    plugins: plugins.flatMap((item) => item.workbench),\n  })\n\n  const actualPort = await listenWithFallback(motiaServer.server, port, hostname)\n  if (actualPort !== port) {\n    console.log(`âš ï¸  Port ${port} was in use, using port ${actualPort} instead`)\n  }\n  console.log('ðŸš€ Server ready and listening on port', actualPort)\n  console.log(`ðŸ”— Open http://localhost:${actualPort}${workbenchBase} to open workbench ðŸ› ï¸`)\n\n  process.on('SIGTERM', async () => {\n    trackEvent('dev_server_shutdown', { reason: 'SIGTERM' })\n    motiaServer.server.close()\n    await watcher.stop()\n    await stopRedisConnection()\n    await flush().promise\n    process.exit(0)\n  })\n\n  process.on('SIGINT', async () => {\n    trackEvent('dev_server_shutdown', { reason: 'SIGINT' })\n    motiaServer.server.close()\n    await watcher.stop()\n    await stopRedisConnection()\n    await flush().promise\n    process.exit(0)\n  })\n}\n"],"mappings":"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"}