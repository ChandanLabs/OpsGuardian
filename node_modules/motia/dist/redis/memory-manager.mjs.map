{"version":3,"file":"memory-manager.mjs","names":["instance: RedisMemoryInstancePropT","error: unknown"],"sources":["../../src/redis/memory-manager.ts"],"sourcesContent":["import { mkdirSync } from 'fs'\nimport type { RedisClientType } from 'redis'\nimport { RedisMemoryServer } from 'redis-memory-server'\nimport type { RedisMemoryInstancePropT } from 'redis-memory-server/lib/types'\nimport type { RedisConnectionInfo } from './types'\n\nexport class RedisMemoryManager {\n  private server: RedisMemoryServer | null = null\n  private client: RedisClientType | null = null\n  private running = false\n\n  private registerCleanupHandlers(): void {\n    process.on('exit', async () => {\n      await this.stop()\n    })\n    process.on('SIGTERM', async () => {\n      await this.stop()\n    })\n\n    process.on('SIGINT', async () => {\n      await this.stop()\n    })\n  }\n\n  async startServer(baseDir: string): Promise<RedisConnectionInfo> {\n    if (!this.server) {\n      try {\n        mkdirSync(baseDir, { recursive: true })\n\n        const instance: RedisMemoryInstancePropT = {\n          args: ['--appendonly', 'yes', '--appendfsync', 'everysec', '--save', '\"\"', '--dir', baseDir],\n        }\n\n        if (process.env.MOTIA_REDIS_PORT) {\n          instance.port = parseInt(process.env.MOTIA_REDIS_PORT || '6379')\n        }\n\n        this.server = new RedisMemoryServer({ instance })\n        console.log('Redis Memory Server started')\n        this.running = true\n        this.registerCleanupHandlers()\n      } catch (error) {\n        console.error('[Redis Memory Server] Failed to start:', error)\n        throw error\n      }\n    }\n\n    const host = await this.server.getHost()\n    const port = await this.server.getPort()\n\n    return { host, port }\n  }\n\n  async stop(): Promise<void> {\n    if (this.server && this.running) {\n      try {\n        await this.server.stop()\n      } catch (error: unknown) {\n        console.error('[Redis Memory Server] Error stopping:', (error as Error)?.message)\n      } finally {\n        this.running = false\n        this.server = null\n      }\n    }\n  }\n\n  isRunning(): boolean {\n    return this.running\n  }\n\n  getClient(): RedisClientType | null {\n    return this.client\n  }\n}\n"],"mappings":";;;;AAMA,IAAa,qBAAb,MAAgC;;gBACa;gBACF;iBACvB;;CAElB,AAAQ,0BAAgC;AACtC,UAAQ,GAAG,QAAQ,YAAY;AAC7B,SAAM,KAAK,MAAM;IACjB;AACF,UAAQ,GAAG,WAAW,YAAY;AAChC,SAAM,KAAK,MAAM;IACjB;AAEF,UAAQ,GAAG,UAAU,YAAY;AAC/B,SAAM,KAAK,MAAM;IACjB;;CAGJ,MAAM,YAAY,SAA+C;AAC/D,MAAI,CAAC,KAAK,OACR,KAAI;AACF,aAAU,SAAS,EAAE,WAAW,MAAM,CAAC;GAEvC,MAAMA,WAAqC,EACzC,MAAM;IAAC;IAAgB;IAAO;IAAiB;IAAY;IAAU;IAAM;IAAS;IAAQ,EAC7F;AAED,OAAI,QAAQ,IAAI,iBACd,UAAS,OAAO,SAAS,QAAQ,IAAI,oBAAoB,OAAO;AAGlE,QAAK,SAAS,IAAI,kBAAkB,EAAE,UAAU,CAAC;AACjD,WAAQ,IAAI,8BAA8B;AAC1C,QAAK,UAAU;AACf,QAAK,yBAAyB;WACvB,OAAO;AACd,WAAQ,MAAM,0CAA0C,MAAM;AAC9D,SAAM;;AAOV,SAAO;GAAE,MAHI,MAAM,KAAK,OAAO,SAAS;GAGzB,MAFF,MAAM,KAAK,OAAO,SAAS;GAEnB;;CAGvB,MAAM,OAAsB;AAC1B,MAAI,KAAK,UAAU,KAAK,QACtB,KAAI;AACF,SAAM,KAAK,OAAO,MAAM;WACjBC,OAAgB;AACvB,WAAQ,MAAM,yCAA0C,OAAiB,QAAQ;YACzE;AACR,QAAK,UAAU;AACf,QAAK,SAAS;;;CAKpB,YAAqB;AACnB,SAAO,KAAK;;CAGd,YAAoC;AAClC,SAAO,KAAK"}