{"version":3,"file":"connection.mjs","names":[],"sources":["../../src/redis/connection.ts"],"sourcesContent":["import { createClient, type RedisClientType } from 'redis'\nimport type { LoadedMotiaConfig } from '../load-motia-config'\nimport { RedisMemoryManager } from './memory-manager'\nimport type { RedisConnectionInfo } from './types'\nimport { isExternalRedisConfig, shouldUseMemoryServer } from './utils'\n\nexport type { RedisConnectionInfo } from './types'\n\nclass RedisConnectionManager {\n  private client: RedisClientType | null = null\n  private redisConnectionInfo: RedisConnectionInfo | null = null\n\n  private async getConnectionInfo(baseDir: string, config: LoadedMotiaConfig): Promise<RedisConnectionInfo> {\n    if (shouldUseMemoryServer(config)) {\n      return await new RedisMemoryManager().startServer(baseDir)\n    }\n    if (isExternalRedisConfig(config.redis)) {\n      return {\n        host: config.redis.host,\n        port: config.redis.port,\n        password: config.redis.password,\n        username: config.redis.username,\n        db: config.redis.db,\n      }\n    }\n    return {\n      host: process.env.MOTIA_REDIS_HOST || '127.0.0.1',\n      port: parseInt(process.env.MOTIA_REDIS_PORT || '6379'),\n      password: process.env.MOTIA_REDIS_PASSWORD,\n      username: process.env.MOTIA_REDIS_USERNAME,\n      db: parseInt(process.env.MOTIA_REDIS_DB || '0'),\n    }\n  }\n\n  async connect(baseDir: string, config: LoadedMotiaConfig): Promise<RedisClientType> {\n    if (this.client) {\n      return this.client\n    }\n\n    this.redisConnectionInfo = await this.getConnectionInfo(baseDir, config)\n\n    this.client = createClient({\n      password: this.redisConnectionInfo.password,\n      username: this.redisConnectionInfo.username,\n      database: this.redisConnectionInfo.db,\n      socket: {\n        host: this.redisConnectionInfo.host,\n        port: this.redisConnectionInfo.port,\n        noDelay: true,\n        keepAlive: true,\n        reconnectStrategy: (retries: number) => {\n          if (retries > 10) {\n            return new Error('Redis connection retry limit exceeded')\n          }\n          return Math.min(retries * 100, 3000)\n        },\n        connectTimeout: 10000,\n      },\n    })\n\n    await this.client.connect()\n\n    return this.client\n  }\n\n  async stop(): Promise<void> {\n    if (this.client?.isOpen) {\n      await this.client.quit().catch(() => {\n        console.error('[Redis Connection] Redis client closed')\n      })\n      this.client = null\n    }\n  }\n\n  isRunning(): boolean {\n    return !!this.client?.isOpen\n  }\n\n  getClient(): RedisClientType | null {\n    return this.client\n  }\n\n  get connectionInfo(): RedisConnectionInfo {\n    return this.redisConnectionInfo!\n  }\n}\n\nconst manager = new RedisConnectionManager()\n\nexport const getRedisClient = (baseDir: string, config: LoadedMotiaConfig): Promise<RedisClientType> =>\n  manager.connect(baseDir, config)\n\nexport const stopRedisConnection = (): Promise<void> => manager.stop()\n\nexport const getRedisConnectionInfo = (): RedisConnectionInfo => manager.connectionInfo\n"],"mappings":";;;;;AAQA,IAAM,yBAAN,MAA6B;;gBACc;6BACiB;;CAE1D,MAAc,kBAAkB,SAAiB,QAAyD;AACxG,MAAI,sBAAsB,OAAO,CAC/B,QAAO,MAAM,IAAI,oBAAoB,CAAC,YAAY,QAAQ;AAE5D,MAAI,sBAAsB,OAAO,MAAM,CACrC,QAAO;GACL,MAAM,OAAO,MAAM;GACnB,MAAM,OAAO,MAAM;GACnB,UAAU,OAAO,MAAM;GACvB,UAAU,OAAO,MAAM;GACvB,IAAI,OAAO,MAAM;GAClB;AAEH,SAAO;GACL,MAAM,QAAQ,IAAI,oBAAoB;GACtC,MAAM,SAAS,QAAQ,IAAI,oBAAoB,OAAO;GACtD,UAAU,QAAQ,IAAI;GACtB,UAAU,QAAQ,IAAI;GACtB,IAAI,SAAS,QAAQ,IAAI,kBAAkB,IAAI;GAChD;;CAGH,MAAM,QAAQ,SAAiB,QAAqD;AAClF,MAAI,KAAK,OACP,QAAO,KAAK;AAGd,OAAK,sBAAsB,MAAM,KAAK,kBAAkB,SAAS,OAAO;AAExE,OAAK,SAAS,aAAa;GACzB,UAAU,KAAK,oBAAoB;GACnC,UAAU,KAAK,oBAAoB;GACnC,UAAU,KAAK,oBAAoB;GACnC,QAAQ;IACN,MAAM,KAAK,oBAAoB;IAC/B,MAAM,KAAK,oBAAoB;IAC/B,SAAS;IACT,WAAW;IACX,oBAAoB,YAAoB;AACtC,SAAI,UAAU,GACZ,wBAAO,IAAI,MAAM,wCAAwC;AAE3D,YAAO,KAAK,IAAI,UAAU,KAAK,IAAK;;IAEtC,gBAAgB;IACjB;GACF,CAAC;AAEF,QAAM,KAAK,OAAO,SAAS;AAE3B,SAAO,KAAK;;CAGd,MAAM,OAAsB;AAC1B,MAAI,KAAK,QAAQ,QAAQ;AACvB,SAAM,KAAK,OAAO,MAAM,CAAC,YAAY;AACnC,YAAQ,MAAM,yCAAyC;KACvD;AACF,QAAK,SAAS;;;CAIlB,YAAqB;AACnB,SAAO,CAAC,CAAC,KAAK,QAAQ;;CAGxB,YAAoC;AAClC,SAAO,KAAK;;CAGd,IAAI,iBAAsC;AACxC,SAAO,KAAK;;;AAIhB,MAAM,UAAU,IAAI,wBAAwB;AAE5C,MAAa,kBAAkB,SAAiB,WAC9C,QAAQ,QAAQ,SAAS,OAAO;AAElC,MAAa,4BAA2C,QAAQ,MAAM;AAEtE,MAAa,+BAAoD,QAAQ"}