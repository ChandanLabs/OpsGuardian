import { AiOpsAgent } from "../utils/ai_agent.js";
import { InfrastructureManager } from "../services/mock_infrastructure.js";
const config = {
  name: "AnalyzeIncident",
  type: "event",
  subscribes: ["incident.detected"],
  emits: ["incident.analyzed"],
  description: "Analyzes the incident logs and determines a fix"
};
const handler = async (event, { emit, logger, state }) => {
  logger.info("RECEIVED EVENT", JSON.stringify(event));
  const data = event.data || event;
  const { alertId, severity } = data;
  logger.info(`\u{1F575}\uFE0F analyzing incident ${alertId}...`);
  const logs = await InfrastructureManager.getSystemLogs();
  const analysis = await AiOpsAgent.analyzeIncident(logs);
  logger.info("AI Analysis Complete", analysis);
  await state.set(`incident:${alertId}:analysis`, analysis);
  await state.set(`incident:${alertId}:status`, "WAITING_APPROVAL");
  await emit({
    topic: "incident.analyzed",
    data: {
      alertId,
      analysis,
      approvalLink: `/approval/approve?alertId=${alertId}`
    }
  });
};
export {
  config,
  handler
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vLi4vc3JjL3N0ZXBzL2FuYWx5emUuc3RlcC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiXHJcbmltcG9ydCB0eXBlIHsgRXZlbnRDb25maWcsIEhhbmRsZXJzIH0gZnJvbSAnbW90aWEnO1xyXG5pbXBvcnQgeyBBaU9wc0FnZW50IH0gZnJvbSAnLi4vdXRpbHMvYWlfYWdlbnQnO1xyXG5pbXBvcnQgeyBJbmZyYXN0cnVjdHVyZU1hbmFnZXIgfSBmcm9tICcuLi9zZXJ2aWNlcy9tb2NrX2luZnJhc3RydWN0dXJlJztcclxuXHJcbmV4cG9ydCBjb25zdCBjb25maWc6IEV2ZW50Q29uZmlnID0ge1xyXG4gICAgbmFtZTogJ0FuYWx5emVJbmNpZGVudCcsXHJcbiAgICB0eXBlOiAnZXZlbnQnLFxyXG4gICAgc3Vic2NyaWJlczogWydpbmNpZGVudC5kZXRlY3RlZCddLFxyXG4gICAgZW1pdHM6IFsnaW5jaWRlbnQuYW5hbHl6ZWQnXSxcclxuICAgIGRlc2NyaXB0aW9uOiAnQW5hbHl6ZXMgdGhlIGluY2lkZW50IGxvZ3MgYW5kIGRldGVybWluZXMgYSBmaXgnXHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlcjogYW55ID0gYXN5bmMgKGV2ZW50OiBhbnksIHsgZW1pdCwgbG9nZ2VyLCBzdGF0ZSB9OiBhbnkpID0+IHtcclxuICAgIGxvZ2dlci5pbmZvKFwiUkVDRUlWRUQgRVZFTlRcIiwgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcclxuICAgIGNvbnN0IGRhdGEgPSBldmVudC5kYXRhIHx8IGV2ZW50OyAvLyBGYWxsYmFjayBpZiB1bndyYXBwZWRcclxuICAgIGNvbnN0IHsgYWxlcnRJZCwgc2V2ZXJpdHkgfSA9IGRhdGE7XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oYFx1RDgzRFx1REQ3NVx1RkUwRiBhbmFseXppbmcgaW5jaWRlbnQgJHthbGVydElkfS4uLmApO1xyXG5cclxuICAgIC8vIDEuIEZldGNoIExvZ3NcclxuICAgIGNvbnN0IGxvZ3MgPSBhd2FpdCBJbmZyYXN0cnVjdHVyZU1hbmFnZXIuZ2V0U3lzdGVtTG9ncygpO1xyXG5cclxuICAgIC8vIDIuIEFJIEFuYWx5c2lzXHJcbiAgICBjb25zdCBhbmFseXNpcyA9IGF3YWl0IEFpT3BzQWdlbnQuYW5hbHl6ZUluY2lkZW50KGxvZ3MpO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKFwiQUkgQW5hbHlzaXMgQ29tcGxldGVcIiwgYW5hbHlzaXMpO1xyXG5cclxuICAgIC8vIDMuIFN0b3JlIEFuYWx5c2lzIGluIFN0YXRlIGZvciB0aGUgQXBwcm92YWwgU3RlcFxyXG4gICAgYXdhaXQgc3RhdGUuc2V0KGBpbmNpZGVudDoke2FsZXJ0SWR9OmFuYWx5c2lzYCwgYW5hbHlzaXMpO1xyXG4gICAgYXdhaXQgc3RhdGUuc2V0KGBpbmNpZGVudDoke2FsZXJ0SWR9OnN0YXR1c2AsICdXQUlUSU5HX0FQUFJPVkFMJyk7XHJcblxyXG4gICAgLy8gNC4gRW1pdCBldmVudCB0byBub3RpZnkgYWRtaW5cclxuICAgIGF3YWl0IGVtaXQoe1xyXG4gICAgICAgIHRvcGljOiAnaW5jaWRlbnQuYW5hbHl6ZWQnLFxyXG4gICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgYWxlcnRJZCxcclxuICAgICAgICAgICAgYW5hbHlzaXMsXHJcbiAgICAgICAgICAgIGFwcHJvdmFsTGluazogYC9hcHByb3ZhbC9hcHByb3ZlP2FsZXJ0SWQ9JHthbGVydElkfWBcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufTtcclxuIl0sCiAgIm1hcHBpbmdzIjogIkFBRUEsU0FBUyxrQkFBa0I7QUFDM0IsU0FBUyw2QkFBNkI7QUFFL0IsTUFBTSxTQUFzQjtBQUFBLEVBQy9CLE1BQU07QUFBQSxFQUNOLE1BQU07QUFBQSxFQUNOLFlBQVksQ0FBQyxtQkFBbUI7QUFBQSxFQUNoQyxPQUFPLENBQUMsbUJBQW1CO0FBQUEsRUFDM0IsYUFBYTtBQUNqQjtBQUVPLE1BQU0sVUFBZSxPQUFPLE9BQVksRUFBRSxNQUFNLFFBQVEsTUFBTSxNQUFXO0FBQzVFLFNBQU8sS0FBSyxrQkFBa0IsS0FBSyxVQUFVLEtBQUssQ0FBQztBQUNuRCxRQUFNLE9BQU8sTUFBTSxRQUFRO0FBQzNCLFFBQU0sRUFBRSxTQUFTLFNBQVMsSUFBSTtBQUU5QixTQUFPLEtBQUssc0NBQTBCLE9BQU8sS0FBSztBQUdsRCxRQUFNLE9BQU8sTUFBTSxzQkFBc0IsY0FBYztBQUd2RCxRQUFNLFdBQVcsTUFBTSxXQUFXLGdCQUFnQixJQUFJO0FBRXRELFNBQU8sS0FBSyx3QkFBd0IsUUFBUTtBQUc1QyxRQUFNLE1BQU0sSUFBSSxZQUFZLE9BQU8sYUFBYSxRQUFRO0FBQ3hELFFBQU0sTUFBTSxJQUFJLFlBQVksT0FBTyxXQUFXLGtCQUFrQjtBQUdoRSxRQUFNLEtBQUs7QUFBQSxJQUNQLE9BQU87QUFBQSxJQUNQLE1BQU07QUFBQSxNQUNGO0FBQUEsTUFDQTtBQUFBLE1BQ0EsY0FBYyw2QkFBNkIsT0FBTztBQUFBLElBQ3REO0FBQUEsRUFDSixDQUFDO0FBQ0w7IiwKICAibmFtZXMiOiBbXQp9Cg==
