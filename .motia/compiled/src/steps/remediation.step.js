import { InfrastructureManager } from "../services/mock_infrastructure.js";
const config = {
  name: "ExecuteRemediation",
  type: "event",
  subscribes: ["incident.approved"],
  description: "Executes the approved fix and verifies health",
  emits: ["incident.resolved"]
};
const handler = async (event, { emit, logger, state }) => {
  logger.info("RECEIVED REMEDIATION EVENT", JSON.stringify(event));
  const data = event.data || event;
  const { alertId, analysis } = data;
  const command = analysis.recommendedAction;
  logger.info(`\u{1F6E0}\uFE0F Executing Remediation: ${command}`);
  await InfrastructureManager.executeCommand(command);
  const health = await InfrastructureManager.healthCheck();
  if (health.status === 200) {
    logger.info("\u2705 System Health Verified. Incident Resolved.");
    await state.set(`incident:${alertId}:status`, "RESOLVED");
    await emit({
      topic: "incident.resolved",
      data: { alertId, status: "RESOLVED", health }
    });
  } else {
    logger.error("\u274C Fix failed. System still unhealthy.");
    await state.set(`incident:${alertId}:status`, "FIX_FAILED");
  }
};
export {
  config,
  handler
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vLi4vc3JjL3N0ZXBzL3JlbWVkaWF0aW9uLnN0ZXAudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbIlxyXG5pbXBvcnQgdHlwZSB7IEV2ZW50Q29uZmlnLCBIYW5kbGVycyB9IGZyb20gJ21vdGlhJztcclxuaW1wb3J0IHsgSW5mcmFzdHJ1Y3R1cmVNYW5hZ2VyIH0gZnJvbSAnLi4vc2VydmljZXMvbW9ja19pbmZyYXN0cnVjdHVyZSc7XHJcblxyXG5leHBvcnQgY29uc3QgY29uZmlnOiBFdmVudENvbmZpZyA9IHtcclxuICAgIG5hbWU6ICdFeGVjdXRlUmVtZWRpYXRpb24nLFxyXG4gICAgdHlwZTogJ2V2ZW50JyxcclxuICAgIHN1YnNjcmliZXM6IFsnaW5jaWRlbnQuYXBwcm92ZWQnXSxcclxuICAgIGRlc2NyaXB0aW9uOiAnRXhlY3V0ZXMgdGhlIGFwcHJvdmVkIGZpeCBhbmQgdmVyaWZpZXMgaGVhbHRoJyxcclxuICAgIGVtaXRzOiBbJ2luY2lkZW50LnJlc29sdmVkJ11cclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBhbnkgPSBhc3luYyAoZXZlbnQ6IGFueSwgeyBlbWl0LCBsb2dnZXIsIHN0YXRlIH06IGFueSkgPT4ge1xyXG4gICAgbG9nZ2VyLmluZm8oXCJSRUNFSVZFRCBSRU1FRElBVElPTiBFVkVOVFwiLCBKU09OLnN0cmluZ2lmeShldmVudCkpO1xyXG4gICAgY29uc3QgZGF0YSA9IGV2ZW50LmRhdGEgfHwgZXZlbnQ7XHJcbiAgICBjb25zdCB7IGFsZXJ0SWQsIGFuYWx5c2lzIH0gPSBkYXRhO1xyXG4gICAgY29uc3QgY29tbWFuZCA9IGFuYWx5c2lzLnJlY29tbWVuZGVkQWN0aW9uO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKGBcdUQ4M0RcdURFRTBcdUZFMEYgRXhlY3V0aW5nIFJlbWVkaWF0aW9uOiAke2NvbW1hbmR9YCk7XHJcblxyXG4gICAgLy8gMS4gRXhlY3V0ZSBDb21tYW5kXHJcbiAgICBhd2FpdCBJbmZyYXN0cnVjdHVyZU1hbmFnZXIuZXhlY3V0ZUNvbW1hbmQoY29tbWFuZCk7XHJcblxyXG4gICAgLy8gMi4gVmVyaWZ5IEhlYWx0aFxyXG4gICAgY29uc3QgaGVhbHRoID0gYXdhaXQgSW5mcmFzdHJ1Y3R1cmVNYW5hZ2VyLmhlYWx0aENoZWNrKCk7XHJcblxyXG4gICAgaWYgKGhlYWx0aC5zdGF0dXMgPT09IDIwMCkge1xyXG4gICAgICAgIGxvZ2dlci5pbmZvKFwiXHUyNzA1IFN5c3RlbSBIZWFsdGggVmVyaWZpZWQuIEluY2lkZW50IFJlc29sdmVkLlwiKTtcclxuICAgICAgICBhd2FpdCBzdGF0ZS5zZXQoYGluY2lkZW50OiR7YWxlcnRJZH06c3RhdHVzYCwgJ1JFU09MVkVEJyk7XHJcblxyXG4gICAgICAgIGF3YWl0IGVtaXQoe1xyXG4gICAgICAgICAgICB0b3BpYzogJ2luY2lkZW50LnJlc29sdmVkJyxcclxuICAgICAgICAgICAgZGF0YTogeyBhbGVydElkLCBzdGF0dXM6ICdSRVNPTFZFRCcsIGhlYWx0aCB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoXCJcdTI3NEMgRml4IGZhaWxlZC4gU3lzdGVtIHN0aWxsIHVuaGVhbHRoeS5cIik7XHJcbiAgICAgICAgYXdhaXQgc3RhdGUuc2V0KGBpbmNpZGVudDoke2FsZXJ0SWR9OnN0YXR1c2AsICdGSVhfRkFJTEVEJyk7XHJcbiAgICB9XHJcbn07XHJcbiJdLAogICJtYXBwaW5ncyI6ICJBQUVBLFNBQVMsNkJBQTZCO0FBRS9CLE1BQU0sU0FBc0I7QUFBQSxFQUMvQixNQUFNO0FBQUEsRUFDTixNQUFNO0FBQUEsRUFDTixZQUFZLENBQUMsbUJBQW1CO0FBQUEsRUFDaEMsYUFBYTtBQUFBLEVBQ2IsT0FBTyxDQUFDLG1CQUFtQjtBQUMvQjtBQUVPLE1BQU0sVUFBZSxPQUFPLE9BQVksRUFBRSxNQUFNLFFBQVEsTUFBTSxNQUFXO0FBQzVFLFNBQU8sS0FBSyw4QkFBOEIsS0FBSyxVQUFVLEtBQUssQ0FBQztBQUMvRCxRQUFNLE9BQU8sTUFBTSxRQUFRO0FBQzNCLFFBQU0sRUFBRSxTQUFTLFNBQVMsSUFBSTtBQUM5QixRQUFNLFVBQVUsU0FBUztBQUV6QixTQUFPLEtBQUssMENBQThCLE9BQU8sRUFBRTtBQUduRCxRQUFNLHNCQUFzQixlQUFlLE9BQU87QUFHbEQsUUFBTSxTQUFTLE1BQU0sc0JBQXNCLFlBQVk7QUFFdkQsTUFBSSxPQUFPLFdBQVcsS0FBSztBQUN2QixXQUFPLEtBQUssbURBQThDO0FBQzFELFVBQU0sTUFBTSxJQUFJLFlBQVksT0FBTyxXQUFXLFVBQVU7QUFFeEQsVUFBTSxLQUFLO0FBQUEsTUFDUCxPQUFPO0FBQUEsTUFDUCxNQUFNLEVBQUUsU0FBUyxRQUFRLFlBQVksT0FBTztBQUFBLElBQ2hELENBQUM7QUFBQSxFQUVMLE9BQU87QUFDSCxXQUFPLE1BQU0sNENBQXVDO0FBQ3BELFVBQU0sTUFBTSxJQUFJLFlBQVksT0FBTyxXQUFXLFlBQVk7QUFBQSxFQUM5RDtBQUNKOyIsCiAgIm5hbWVzIjogW10KfQo=
